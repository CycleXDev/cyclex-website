<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CycleX Firewall â€” Wallet Protection</title>
  <meta name="description" content="Turn any wallet into a protected wallet in 60 seconds. Scan approvals, see your Blast Radius, get a Fix Plan." />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="theme-color" content="#05060a">

  <!-- Ethers (same version as main site) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js" defer></script>

  <style>
    :root {
      --bg:#05060a;
      --cyan:#00e5ff;
      --green:#5dffb2;
      --purple:#7c5cff;
      --red:#ff4757;
      --yellow:#ffd166;
      --text:rgba(244,246,255,1);
      --muted:rgba(244,246,255,.65);
      --card:rgba(255,255,255,.055);
      --border:rgba(255,255,255,.12);
      --radius:22px;
      --radius-sm:14px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      --sans:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100%;overflow-x:hidden}
    html{font-size:16px;background:#05060a!important}
    body{
      font-family:var(--sans);
      background:
        radial-gradient(1200px 720px at 14% 10%,rgba(124,92,255,.20),transparent 58%),
        radial-gradient(1200px 720px at 86% 12%,rgba(0,229,255,.18),transparent 56%),
        radial-gradient(980px 680px at 55% 120%,rgba(0,58,76,.42),transparent 62%),
        linear-gradient(160deg,#05060a,#0b0a18,#021b24)!important;
      background-repeat:no-repeat!important;
      background-attachment:fixed!important;
      background-size:cover!important;
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
    }
    body::before{
      content:"";position:fixed;inset:0;pointer-events:none;
      background:
        radial-gradient(740px 640px at 20% 14%,rgba(0,229,255,.10),transparent 60%),
        radial-gradient(940px 780px at 78% 18%,rgba(124,92,255,.09),transparent 62%),
        radial-gradient(820px 700px at 52% 78%,rgba(93,255,178,.06),transparent 64%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      background-size:auto,auto,auto,260px 260px;
      background-repeat:no-repeat,no-repeat,no-repeat,repeat;
      opacity:.10;mix-blend-mode:overlay;z-index:0
    }
    a{color:inherit;text-decoration:none}

    /* â”€â”€ PAGE SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-shell{width:100%;max-width:1160px;margin:0 auto;padding:32px 20px 80px;position:relative;z-index:1}

    /* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .top-bar{
      position:sticky;top:14px;z-index:999;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 16px;margin:0 auto 36px;
      width:min(1160px,calc(100% - 24px));
      border-radius:999px;
      background:rgba(10,12,22,.55);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter:blur(18px) saturate(1.12);
      -webkit-backdrop-filter:blur(18px) saturate(1.12);
      box-shadow:0 14px 50px rgba(0,0,0,.50),inset 0 1px 0 rgba(255,255,255,.06);
    }
    .top-bar::before{
      content:"";position:absolute;inset:0;border-radius:999px;padding:1px;
      background:linear-gradient(120deg,rgba(0,229,255,.22),rgba(124,92,255,.16),rgba(255,255,255,.10));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;opacity:.55
    }
    .brand{display:flex;align-items:center;gap:10px;position:relative;z-index:1}
    .brand-logo{width:42px;height:42px;border-radius:14px;object-fit:contain;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);box-shadow:0 12px 32px rgba(0,0,0,.7);flex:0 0 auto}
    .brand-text{display:flex;flex-direction:column;gap:2px}
    .brand-title{font-weight:950;letter-spacing:.10em;font-size:13px;text-transform:uppercase;white-space:nowrap}
    .brand-sub{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:rgba(244,246,255,.56);white-space:nowrap}
    .top-right{display:flex;align-items:center;gap:10px;position:relative;z-index:1}
    .back-link{
      font-size:11px;letter-spacing:.16em;text-transform:uppercase;
      color:rgba(244,246,255,.72);padding:8px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);
      transition:all .18s ease;cursor:pointer
    }
    .back-link:hover{background:rgba(255,255,255,.08);color:var(--text)}
    .firewall-badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 12px;border-radius:999px;
      border:1px solid rgba(255,80,80,.35);background:rgba(255,80,80,.10);
      font-size:11px;font-weight:800;letter-spacing:.10em;text-transform:uppercase;
      color:#ff6b6b
    }
    .firewall-badge .dot{width:7px;height:7px;border-radius:50%;background:#ff4757;animation:pulse 1.8s infinite}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.85)}}

    /* â”€â”€ HERO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero{position:relative;max-width:1100px;margin:10px auto 32px;padding:10px 0 24px;text-align:center;z-index:1}
    .hero-kicker{
      display:inline-flex;align-items:center;gap:8px;
      font-size:11px;letter-spacing:.24em;text-transform:uppercase;
      color:rgba(255,100,100,.92);margin-bottom:18px;
      padding:6px 14px;border-radius:999px;border:1px solid rgba(255,80,80,.22);background:rgba(255,80,80,.08)
    }
    .hero-title{
      font-size:clamp(42px,5vw,80px);line-height:1.10;font-weight:950;letter-spacing:-.04em;
      margin-bottom:14px;
      background:linear-gradient(110deg,rgba(244,246,255,1) 0%,rgba(255,150,100,.95) 35%,rgba(255,80,80,.90) 65%,rgba(124,92,255,.88) 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      background-size:200% 200%;animation:titleSheen 6s ease-in-out infinite
    }
    @keyframes titleSheen{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    .hero-sub{max-width:68ch;margin:0 auto 28px;font-size:16px;line-height:1.75;color:var(--muted)}

    /* â”€â”€ WALLET INPUT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .scan-bar{
      display:flex;align-items:center;gap:10px;max-width:760px;margin:0 auto;
      background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.16);
      border-radius:999px;padding:7px 7px 7px 22px;
      box-shadow:0 18px 60px rgba(0,0,0,.50),inset 0 1px 0 rgba(255,255,255,.06);
      transition:border-color .22s ease,box-shadow .22s ease
    }
    .scan-bar:focus-within{border-color:rgba(255,100,80,.45);box-shadow:0 18px 60px rgba(0,0,0,.50),0 0 0 3px rgba(255,80,80,.10)}
    .scan-bar input{
      flex:1;background:transparent;border:none;outline:none;
      font-family:var(--mono);font-size:14px;color:var(--text);
      placeholder-color:var(--muted)
    }
    .scan-bar input::placeholder{color:var(--muted)}
    .scan-net{
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);
      color:var(--text);font-size:12px;padding:8px 12px;border-radius:999px;outline:none;cursor:pointer
    }
    .btn-scan{
      background:linear-gradient(135deg,#ff4757,#ff6b6b);color:#fff;
      border:none;border-radius:999px;padding:12px 22px;
      font-size:13px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
      cursor:pointer;white-space:nowrap;transition:transform .2s ease,box-shadow .2s ease;
      box-shadow:0 14px 42px rgba(255,71,87,.38)
    }
    .btn-scan:hover{transform:translateY(-1px);box-shadow:0 20px 60px rgba(255,71,87,.52)}
    .btn-scan:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .hero-micro{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px;margin:14px 0 0;font-size:12px;color:var(--muted)}
    .micro-dot{opacity:.38;margin:0 2px}
    .demo-hint{
      margin-top:12px;font-size:12px;color:rgba(255,160,100,.75);cursor:pointer;
      text-decoration:underline;text-underline-offset:3px;opacity:.85;transition:opacity .2s
    }
    .demo-hint:hover{opacity:1}

    /* â”€â”€ LOADING BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loadWrap{display:none;max-width:760px;margin:28px auto 0;text-align:center}
    .load-label{font-size:13px;color:var(--muted);margin-bottom:12px;letter-spacing:.04em}
    .load-steps{display:flex;flex-direction:column;gap:8px;max-width:420px;margin:0 auto 16px}
    .load-step{
      display:flex;align-items:center;gap:12px;padding:10px 14px;
      border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);
      font-size:13px;color:var(--muted);opacity:.45;transition:opacity .3s,border-color .3s
    }
    .load-step.active{opacity:1;border-color:rgba(255,100,80,.35);color:var(--text)}
    .load-step.done{opacity:.8;color:var(--green)}
    .load-step .step-icon{width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:10px;flex:0 0 auto}
    .load-step.active .step-icon{border-color:rgba(255,100,80,.6);animation:spin .8s linear infinite}
    .load-step.done .step-icon{border-color:var(--green);background:rgba(93,255,178,.12)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .load-bar{height:3px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;max-width:420px;margin:0 auto}
    .load-bar-fill{height:100%;background:linear-gradient(90deg,#ff4757,#ff9a6b,#ffcc5c);border-radius:999px;width:0%;transition:width .4s ease}

    /* â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #dashboard{display:none;animation:dashIn .5s ease-out forwards}
    @keyframes dashIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

    .section-title{
      font-size:11px;letter-spacing:.20em;text-transform:uppercase;
      color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:10px
    }
    .section-title::after{content:"";flex:1;height:1px;background:rgba(255,255,255,.08)}

    /* Score bar (top 3) */
    .top3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px}
    .score-card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
      padding:22px 20px;box-shadow:0 20px 55px rgba(0,0,0,.55),inset 0 1px 0 rgba(255,255,255,.05);
      position:relative;overflow:hidden;transition:transform .18s ease,border-color .18s ease
    }
    .score-card:hover{transform:translateY(-2px)}
    .score-card::before{content:"";position:absolute;inset:0;border-radius:var(--radius);opacity:.12;pointer-events:none}
    .score-card.card-score::before{background:radial-gradient(circle at 50% -20%,rgba(255,71,87,.6),transparent 60%)}
    .score-card.card-blast::before{background:radial-gradient(circle at 50% -20%,rgba(255,193,7,.5),transparent 60%)}
    .score-card.card-drain::before{background:radial-gradient(circle at 50% -20%,rgba(0,229,255,.4),transparent 60%)}
    .sc-kicker{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:10px}
    .sc-big{font-size:clamp(38px,4vw,56px);font-weight:950;letter-spacing:-.02em;line-height:1}
    .sc-unit{font-size:16px;font-weight:700;opacity:.7;margin-left:4px}
    .sc-label{margin-top:10px;font-size:13px;display:flex;align-items:center;gap:8px}
    .sc-dot{width:10px;height:10px;border-radius:50%;flex:0 0 auto}
    /* score gauge */
    .gauge-wrap{position:relative;width:90px;height:90px;margin:0 auto 6px}
    .gauge-svg{transform:rotate(-90deg)}
    .gauge-track{fill:none;stroke:rgba(255,255,255,.08);stroke-width:8}
    .gauge-fill{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.2s cubic-bezier(.22,1,.36,1)}
    .gauge-num{
      position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-size:22px;font-weight:950;letter-spacing:-.02em
    }
    .gauge-num small{font-size:9px;font-weight:700;opacity:.6;letter-spacing:.14em;text-transform:uppercase;margin-top:1px}

    /* blast + drain cards */
    .blast-amount{font-size:clamp(30px,3.5vw,46px);font-weight:950;letter-spacing:-.02em;color:#ffd166}
    .drain-time{font-size:clamp(30px,3.5vw,46px);font-weight:950;letter-spacing:-.02em;color:var(--red)}
    .drain-fast{animation:drainPulse 2s ease-in-out infinite}
    @keyframes drainPulse{0%,100%{opacity:1}50%{opacity:.7}}
    .card-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:14px}
    .meta-chip{
      display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;
      font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);
      color:var(--muted)
    }
    .meta-chip.warn{border-color:rgba(255,193,7,.3);background:rgba(255,193,7,.08);color:#ffd166}
    .meta-chip.bad{border-color:rgba(255,71,87,.3);background:rgba(255,71,87,.09);color:#ff6b6b}
    .meta-chip.ok{border-color:rgba(93,255,178,.3);background:rgba(93,255,178,.09);color:var(--green)}

    /* â”€â”€ MAIN GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-grid{display:grid;grid-template-columns:1.3fr 1fr;gap:16px;margin-bottom:16px}

    /* Exposure Map */
    .exp-card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
      padding:20px;box-shadow:0 20px 55px rgba(0,0,0,.55)
    }
    .exp-title{font-size:14px;font-weight:800;margin-bottom:4px}
    .exp-sub{font-size:12px;color:var(--muted);margin-bottom:16px}
    #exposureMap{width:100%;height:280px;background:rgba(0,0,0,.2);border-radius:16px;border:1px solid rgba(255,255,255,.06);overflow:hidden}

    /* Top Threats */
    .threats-card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
      padding:20px;box-shadow:0 20px 55px rgba(0,0,0,.55)
    }
    .threat-item{
      padding:12px 0;border-bottom:1px solid rgba(255,255,255,.07);display:flex;flex-direction:column;gap:8px
    }
    .threat-item:last-child{border-bottom:none;padding-bottom:0}
    .threat-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .threat-name{font-size:13px;font-weight:800;font-family:var(--mono)}
    .threat-damage{font-size:12px;font-weight:900;color:#ff6b6b}
    .threat-meta{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .threat-why{font-size:11px;color:var(--muted);flex:1 1 100%}
    .btn-fix-small{
      padding:5px 12px;border-radius:999px;font-size:11px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;
      border:1px solid rgba(255,193,7,.4);background:rgba(255,193,7,.10);color:#ffd166;
      cursor:pointer;transition:all .18s ease;white-space:nowrap
    }
    .btn-fix-small:hover{background:rgba(255,193,7,.18);border-color:rgba(255,193,7,.6)}
    .btn-fix-small.fixed{border-color:rgba(93,255,178,.4);background:rgba(93,255,178,.10);color:var(--green);cursor:default}

    /* â”€â”€ FIX MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .fix-card{
      background:var(--card);border:1px solid rgba(255,193,7,.22);border-radius:var(--radius);
      padding:22px;box-shadow:0 20px 55px rgba(0,0,0,.55),0 0 0 1px rgba(255,193,7,.10),0 0 28px rgba(255,193,7,.08);
      margin-bottom:16px
    }
    .fix-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px}
    .fix-steps{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .fix-step{
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:16px;
      padding:16px 14px;position:relative;overflow:hidden;transition:all .22s ease
    }
    .fix-step.step-done{border-color:rgba(93,255,178,.25);background:rgba(93,255,178,.06)}
    .fix-step.step-done::before{
      content:"âœ“";position:absolute;top:10px;right:12px;font-size:14px;font-weight:900;
      color:var(--green);opacity:.8
    }
    .fix-step-num{
      width:28px;height:28px;border-radius:50%;
      background:linear-gradient(135deg,rgba(255,71,87,.3),rgba(255,150,80,.3));
      border:1px solid rgba(255,100,80,.3);display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:900;color:#ff9a6b;margin-bottom:10px
    }
    .fix-step.step-done .fix-step-num{
      background:rgba(93,255,178,.15);border-color:rgba(93,255,178,.3);color:var(--green)
    }
    .fix-step-title{font-size:13px;font-weight:800;margin-bottom:4px}
    .fix-step-desc{font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:10px}
    .btn-action{
      width:100%;padding:9px 12px;border-radius:999px;font-size:11px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
      border:1px solid rgba(255,100,80,.4);background:rgba(255,80,80,.10);color:#ff8080;
      cursor:pointer;transition:all .2s ease
    }
    .btn-action:hover{background:rgba(255,80,80,.18);transform:translateY(-1px)}
    .btn-action:disabled{opacity:.45;cursor:not-allowed;transform:none}
    .btn-action.done{border-color:rgba(93,255,178,.35);background:rgba(93,255,178,.10);color:var(--green);cursor:default}
    .fix-score-gain{
      margin-top:16px;padding:12px 16px;border-radius:12px;
      background:rgba(93,255,178,.06);border:1px solid rgba(93,255,178,.18);
      font-size:13px;color:var(--green);display:flex;align-items:center;gap:10px
    }
    .fix-score-gain strong{font-size:18px;font-weight:950}

    /* â”€â”€ PASSPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .passport-wrap{
      background:var(--card);border:1px solid rgba(0,229,255,.22);border-radius:var(--radius);
      padding:22px;box-shadow:0 20px 55px rgba(0,0,0,.55),0 0 28px rgba(0,229,255,.08);
      margin-bottom:16px
    }
    .passport-inner{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}
    .passport-card-preview{
      background:linear-gradient(135deg,rgba(5,6,10,1),rgba(20,10,38,1));
      border:1px solid rgba(0,229,255,.3);border-radius:18px;padding:20px;
      box-shadow:0 12px 40px rgba(0,0,0,.6),0 0 60px rgba(0,229,255,.08);
      position:relative;overflow:hidden
    }
    .passport-card-preview::before{
      content:"";position:absolute;top:-40px;right:-40px;width:160px;height:160px;
      border-radius:50%;background:radial-gradient(circle,rgba(0,229,255,.12),transparent 70%)
    }
    .pp-logo{font-size:11px;font-weight:900;letter-spacing:.2em;text-transform:uppercase;color:var(--cyan);margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .pp-logo-dot{width:8px;height:8px;border-radius:50%;background:var(--cyan);box-shadow:0 0 10px var(--cyan)}
    .pp-wallet{font-family:var(--mono);font-size:11px;color:var(--muted);margin-bottom:14px;word-break:break-all}
    .pp-score-row{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .pp-score-big{font-size:40px;font-weight:950;letter-spacing:-.03em}
    .pp-score-label{font-size:10px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
    .pp-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
    .pp-stat{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 10px}
    .pp-stat-val{font-size:16px;font-weight:900}
    .pp-stat-key{font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-top:2px}
    .pp-status{
      display:inline-flex;align-items:center;gap:6px;padding:6px 12px;
      border-radius:999px;font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;
      border:1px solid rgba(255,193,7,.35);background:rgba(255,193,7,.10);color:#ffd166
    }
    .pp-date{font-size:10px;color:var(--muted);margin-top:10px;font-family:var(--mono)}

    .passport-actions{display:flex;flex-direction:column;gap:12px}
    .passport-actions h3{font-size:16px;font-weight:800;margin-bottom:4px}
    .passport-actions p{font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:8px}
    .btn-passport{
      padding:12px 18px;border-radius:999px;font-size:13px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;
      cursor:pointer;transition:all .2s ease;width:100%;text-align:center;
      border:1px solid rgba(0,229,255,.35);background:rgba(0,229,255,.10);color:var(--cyan);
      box-shadow:0 8px 24px rgba(0,229,255,.12)
    }
    .btn-passport:hover{background:rgba(0,229,255,.18);transform:translateY(-1px);box-shadow:0 14px 34px rgba(0,229,255,.20)}
    .btn-passport.secondary{border-color:rgba(255,255,255,.16);background:rgba(255,255,255,.04);color:var(--text)}
    .passport-shared{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(93,255,178,.25);
      background:rgba(93,255,178,.07);color:var(--green);font-size:12px;
      display:none;margin-top:4px;line-height:1.5
    }
    .passport-shared.show{display:block}

    /* â”€â”€ GENERAL SHARED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border-radius:999px;border:1px solid transparent;padding:11px 22px;
      font-size:13px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
      cursor:pointer;transition:all .22s ease;user-select:none;white-space:nowrap
    }
    .btn-primary{background:linear-gradient(135deg,#00e5ff,#7df2ff);color:#03040a;box-shadow:0 14px 50px rgba(0,229,255,.32)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 22px 70px rgba(0,229,255,.48)}
    .btn-ghost{background:rgba(255,255,255,.04);color:var(--text);border-color:rgba(255,255,255,.14);backdrop-filter:blur(14px)}
    .btn-ghost:hover{background:rgba(255,255,255,.08);border-color:rgba(0,229,255,.24);transform:translateY(-1px)}

    /* status dots */
    .sig{display:inline-flex;align-items:center;gap:6px;padding:4px 9px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--muted)}
    .sig.bad{border-color:rgba(220,53,69,.25);background:rgba(220,53,69,.10);color:#ff7a8a}
    .sig.warn{border-color:rgba(255,193,7,.25);background:rgba(255,193,7,.08);color:#ffd166}
    .sig.ok{border-color:rgba(0,230,118,.25);background:rgba(0,230,118,.08);color:#78ffbf}
    .sig-dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.9;flex:0 0 auto}

    /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer{border-top:1px solid rgba(255,255,255,.06);margin-top:32px;padding-top:18px;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted)}
    .footer-brand{color:var(--cyan);font-weight:700}
    .footer-note{font-size:11px;opacity:.7;max-width:580px;line-height:1.5}

    /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width:900px){.top3{grid-template-columns:1fr 1fr}.top3 .score-card.card-score{grid-column:1/-1}}
    @media (max-width:780px){.main-grid{grid-template-columns:1fr}.fix-steps{grid-template-columns:1fr}.passport-inner{grid-template-columns:1fr}.top3{grid-template-columns:1fr}}
    @media (max-width:640px){.scan-bar{flex-wrap:wrap;border-radius:20px;padding:12px 14px}.scan-bar input{width:100%;flex:1 1 100%}.scan-net,.btn-scan{flex:1 1 calc(50% - 5px)}}
    @media (min-width:901px){html{zoom:1.10}}

    /* â”€â”€ NOTICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notice{
      max-width:760px;margin:0 auto 24px;padding:12px 18px;border-radius:14px;
      border:1px solid rgba(255,193,7,.22);background:rgba(255,193,7,.07);
      font-size:12px;color:rgba(244,246,255,.72);line-height:1.5;text-align:center
    }
    .notice strong{color:#ffd166}

    /* â”€â”€ FULL ACCESS BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-full-access{
      background:linear-gradient(135deg,#7c5cff,#a87eff);color:#fff;
      border:none;border-radius:999px;padding:13px 24px;
      font-size:13px;font-weight:900;letter-spacing:.06em;text-transform:uppercase;
      cursor:pointer;white-space:nowrap;transition:transform .2s ease,box-shadow .2s ease;
      box-shadow:0 14px 42px rgba(124,92,255,.42)
    }
    .btn-full-access:hover{transform:translateY(-1px);box-shadow:0 20px 60px rgba(124,92,255,.58)}
    .btn-full-access-top{
      background:rgba(124,92,255,.15);border:1px solid rgba(124,92,255,.35);color:#a87eff;
      border-radius:999px;padding:8px 14px;font-size:11px;font-weight:800;letter-spacing:.10em;text-transform:uppercase;
      cursor:pointer;transition:all .2s ease
    }
    .btn-full-access-top:hover{background:rgba(124,92,255,.28);color:#c4a6ff}
    /* Coming soon badge on disabled CYCX button */
    .coming-soon-badge{
      position:absolute;top:-8px;right:-4px;
      background:linear-gradient(135deg,#ff9a6b,#ffd166);color:#03040a;
      font-size:8px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;
      padding:2px 6px;border-radius:999px;white-space:nowrap
    }

    /* â”€â”€ LOCKED SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .locked-section{position:relative}
    .locked-section .lock-overlay{
      position:absolute;inset:0;border-radius:var(--radius);z-index:5;
      background:linear-gradient(180deg,rgba(5,6,10,.05) 0%,rgba(5,6,10,.92) 55%,rgba(5,6,10,.98) 100%);
      display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:24px;
      backdrop-filter:blur(2px)
    }
    .lock-overlay-inner{text-align:center}
    .lock-overlay-inner .lock-icon{font-size:22px;margin-bottom:6px}
    .lock-overlay-inner p{font-size:12px;color:var(--muted);margin-bottom:12px}
    .pp-watermark{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-size:15px;font-weight:900;letter-spacing:.3em;text-transform:uppercase;
      color:rgba(255,255,255,.08);pointer-events:none;transform:rotate(-18deg);
      text-shadow:none;z-index:2
    }
  </style>
</head>
<body>
<div class="page-shell">

  <!-- TOP BAR -->
  <header class="top-bar">
    <a class="brand" href="/" title="Back to CycleX">
      <picture>
        <source srcset="/logo.webp" type="image/webp">
        <img src="/logo.png" alt="CycleX" class="brand-logo" width="42" height="42" onerror="this.style.display='none'">
      </picture>
      <div class="brand-text">
        <div class="brand-title">CYCLEX</div>
        <div class="brand-sub">Wallet Firewall</div>
      </div>
    </a>
    <div class="top-right">
      <div id="tierBadge" style="display:none;font-size:10px;letter-spacing:.14em;text-transform:uppercase;padding:6px 12px;border-radius:999px;border:1px solid rgba(93,255,178,.3);background:rgba(93,255,178,.08);color:var(--green);font-weight:800">âœ“ FULL ACCESS</div>
      <div class="firewall-badge"><span class="dot"></span>FIREWALL</div>
      <button class="btn-full-access-top" id="btnTopAccess" title="Unlock full features">ğŸ”‘ Full Access</button>
      <a class="back-link" href="/">â† Back to Hub</a>
    </div>
  </header>

  <main>

    <!-- â”€â”€ HERO / LANDING â”€â”€ -->
    <section class="hero" id="heroSection">
      <div class="hero-kicker">ğŸ”¥ Wallet Firewall</div>
      <h1 class="hero-title">Turn any wallet into<br>a protected wallet.</h1>
      <p class="hero-sub">
        Scan your approvals, reveal your Blast Radius, get a guided Fix Plan â€”
        and generate a shareable Proof Passport. In 60 seconds.
      </p>

      <div class="scan-bar">
        <input id="walletInput" class="mono" placeholder="0x... wallet address" spellcheck="false" autocomplete="off" />
        <select id="netSelect" class="scan-net">
          <option value="bsc">BSC</option>
          <option value="eth">ETH</option>
          <option value="polygon">POLYGON</option>
        </select>
        <button class="btn-scan" id="btnRunFirewall">Run Firewall</button>
      </div>

      <span class="demo-hint" id="demoHint">â†— Try with demo wallet</span>

      <div class="hero-micro">
        <span>No signature required</span>
        <span class="micro-dot">Â·</span>
        <span>No transactions</span>
        <span class="micro-dot">Â·</span>
        <span>Read-only scan</span>
        <span class="micro-dot">Â·</span>
        <span>BSC + ETH + Polygon</span>
      </div>
    </section>

    <!-- â”€â”€ LOADING STATE â”€â”€ -->
    <div id="loadWrap">
      <div class="load-label" id="loadLabel">Initializing Firewall Scanâ€¦</div>
      <div class="load-steps">
        <div class="load-step" id="step1"><div class="step-icon">âŸ³</div><span>Fetching approval logs</span></div>
        <div class="load-step" id="step2"><div class="step-icon">âŸ³</div><span>Analyzing spender risk</span></div>
        <div class="load-step" id="step3"><div class="step-icon">âŸ³</div><span>Calculating Blast Radius</span></div>
        <div class="load-step" id="step4"><div class="step-icon">âŸ³</div><span>Building Fix Plan</span></div>
      </div>
      <div class="load-bar"><div class="load-bar-fill" id="loadBarFill"></div></div>
    </div>

    <!-- â”€â”€ DASHBOARD â”€â”€ -->
    <div id="dashboard">

      <div class="notice" id="scanNotice" style="display:none">
        <strong>Live scan.</strong> Read-only on-chain data. No transactions made.
      </div>
      <div class="notice" id="demoNotice">
        <strong>Demo mode:</strong> Showing sample data. Enter a real wallet address and click "Run Firewall" to scan live.
      </div>

      <!-- ACCESS GATE OVERLAY -->
      <div id="accessGateOverlay" style="display:none;position:relative;z-index:10;margin-bottom:24px">
        <div style="
          background:linear-gradient(135deg,rgba(124,92,255,.12),rgba(0,229,255,.08));
          border:1px solid rgba(124,92,255,.35);border-radius:22px;padding:28px;
          text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.55),0 0 30px rgba(124,92,255,.12)
        ">
          <div style="font-size:32px;margin-bottom:12px">ğŸ”’</div>
          <div style="font-size:18px;font-weight:900;margin-bottom:8px">Full Access Required</div>
          <div style="font-size:13px;color:var(--muted);line-height:1.7;max-width:52ch;margin:0 auto 20px">
            Hold <strong style="color:var(--cyan)">1 PASS token</strong> to unlock Fix Mode, full Blast Radius, Wallet Passport, and real revoke actions.
          </div>
          <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
            <!-- Connect & Check â€” triggers AppKit modal -->
            <button class="btn btn-full-access" id="btnCheckAccess">
              ğŸ”‘ Connect &amp; Check Access
            </button>
            <!-- PASS: opens purchase popup -->
            <button class="btn btn-ghost" id="btnBuyPass" style="font-size:12px">
              ğŸ« Get PASS â†—
            </button>
          </div>
          <div id="gateStatus" style="margin-top:14px;font-size:12px;color:var(--muted);min-height:18px"></div>
        </div>
      </div>

      <!-- Wallet badge -->
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="meta-chip" style="font-family:var(--mono);font-size:12px;padding:8px 14px" id="walletBadge">0x...</div>
          <div class="meta-chip" id="netBadge">BSC</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-ghost" id="btnRescan" style="padding:9px 16px;font-size:12px">â†º Rescan</button>
          <button class="btn btn-ghost" id="btnNewScan" style="padding:9px 16px;font-size:12px">New wallet</button>
        </div>
      </div>

      <!-- TOP 3 CARDS -->
      <div class="section-title">Firewall Status</div>
      <div class="top3">

        <!-- Score -->
        <div class="score-card card-score">
          <div class="sc-kicker">Firewall Score</div>
          <div class="gauge-wrap">
            <svg class="gauge-svg" width="90" height="90" viewBox="0 0 90 90">
              <circle class="gauge-track" cx="45" cy="45" r="36"/>
              <circle class="gauge-fill" id="gaugeFill" cx="45" cy="45" r="36"
                stroke="#ff4757"
                stroke-dasharray="226.2"
                stroke-dashoffset="226.2"/>
            </svg>
            <div class="gauge-num">
              <span id="scoreNum">â€”</span>
              <small>/100</small>
            </div>
          </div>
          <div class="sc-label">
            <div class="sc-dot" id="scoreDot" style="background:#ff4757"></div>
            <span id="scoreLabel" style="font-weight:800">Scanningâ€¦</span>
          </div>
          <div class="card-meta" id="scoreMeta"></div>
        </div>

        <!-- Blast Radius -->
        <div class="score-card card-blast">
          <div class="sc-kicker">ğŸ’¥ Blast Radius</div>
          <div class="blast-amount" id="blastAmt">â€”</div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px">max drainable if top spender exploited</div>
          <div class="card-meta" id="blastMeta"></div>
        </div>

        <!-- Time to Drain -->
        <div class="score-card card-drain">
          <div class="sc-kicker">â± Time-to-Drain</div>
          <div class="drain-time" id="drainTime">â€”</div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px">estimated drain time for exposed assets</div>
          <div class="card-meta" id="drainMeta"></div>
        </div>

      </div>

      <!-- MAIN GRID: Map + Threats -->
      <div class="main-grid">

        <!-- Exposure Map -->
        <div class="exp-card">
          <div class="exp-title">ğŸ—º Exposure Map</div>
          <div class="exp-sub">Wallet â†’ Spenders â†’ Tokens. Node size = risk weight.</div>
          <svg id="exposureMap" viewBox="0 0 480 260" xmlns="http://www.w3.org/2000/svg">
            <!-- rendered by JS -->
          </svg>
        </div>

        <!-- Top Threats -->
        <div class="threats-card">
          <div class="exp-title" style="margin-bottom:14px">ğŸ¯ Top Threats</div>
          <div id="threatsList"></div>
        </div>

      </div>

      <!-- FIX MODE -->
      <div class="section-title">Fix Mode</div>
      <div class="fix-card locked-section" id="fixCard">
        <!-- Lock overlay (shown in free tier) -->
        <div class="lock-overlay" id="fixLockOverlay">
          <div class="lock-overlay-inner">
            <div class="lock-icon">ğŸ”’</div>
            <p>Fix Mode requires Full Access<br>(hold 1 PASS token)</p>
            <button class="btn-full-access" onclick="requestFullAccess()" style="font-size:11px;padding:10px 18px">Unlock Fix Mode</button>
          </div>
        </div>
        <div class="fix-header">
          <div>
            <div style="font-size:16px;font-weight:800;margin-bottom:4px">ğŸ›  3-Step Fix Plan</div>
            <div style="font-size:13px;color:var(--muted)">Complete these actions to improve your Firewall Score.</div>
          </div>
          <div class="fix-score-gain" id="fixGain" style="display:none">
            After fix: <strong id="fixNewScore">â€”</strong>/100 <span style="opacity:.7;font-size:12px">(+<span id="fixDelta">â€”</span> pts)</span>
          </div>
        </div>

        <div class="fix-steps">
          <div class="fix-step" id="fixStep1">
            <div class="fix-step-num">1</div>
            <div class="fix-step-title">Revoke Top Spender</div>
            <div class="fix-step-desc">Remove unlimited allowance from the highest-risk spender detected on your wallet.</div>
            <button class="btn-action" id="btnFix1" onclick="applyFix(0)">Revoke Top Spender</button>
            <button class="btn-action btn-undo" id="undoFix1" style="display:none;margin-top:6px;background:rgba(255,100,50,.08);border-color:rgba(255,100,50,.3);color:#ff9a6b;font-size:10px" onclick="undoFix(0)">â†© Undo â€” Restore approval</button>
          </div>
          <div class="fix-step" id="fixStep2">
            <div class="fix-step-num">2</div>
            <div class="fix-step-title">Revoke All Unlimited</div>
            <div class="fix-step-desc">Revoke every unlimited approval on your wallet in one go â€” one on-chain tx per spender.</div>
            <button class="btn-action" id="btnFix2" onclick="applyFix(1)">Revoke All Unlimited</button>
            <button class="btn-action btn-undo" id="undoFix2" style="display:none;margin-top:6px;background:rgba(255,100,50,.08);border-color:rgba(255,100,50,.3);color:#ff9a6b;font-size:10px" onclick="undoFix(1)">â†© Undo â€” Restore all unlimited</button>
          </div>
          <div class="fix-step" id="fixStep3">
            <div class="fix-step-num">3</div>
            <div class="fix-step-title">Lock Risky dApp</div>
            <div class="fix-step-desc">Flag and monitor the unverified spender contract to receive alerts on new activity.</div>
            <button class="btn-action" id="btnFix3" onclick="applyFix(2)">Add to Watchlist</button>
            <button class="btn-action btn-undo" id="undoFix3" style="display:none;margin-top:6px;background:rgba(255,100,50,.08);border-color:rgba(255,100,50,.3);color:#ff9a6b;font-size:10px" onclick="undoFix(2)">â†© Undo â€” Remove from watchlist</button>
          </div>
        </div>

        <div class="fix-score-gain" id="fixComplete" style="display:none">
          âœ… Fix complete! Your estimated score after applying all fixes: <strong id="finalScore">â€”</strong>/100
        </div>
      </div>

      <!-- WALLET PASSPORT -->
      <div class="section-title">Wallet Passport</div>
      <div class="passport-wrap locked-section" id="passportWrap">
        <div class="lock-overlay" id="passportLockOverlay">
          <div class="lock-overlay-inner">
            <div class="lock-icon">ğŸ”’</div>
            <p>Wallet Passport requires Full Access</p>
            <button class="btn-full-access" onclick="requestFullAccess()" style="font-size:11px;padding:10px 18px">Unlock Passport</button>
          </div>
        </div>
        <div style="margin-bottom:18px">
          <div style="font-size:16px;font-weight:800;margin-bottom:4px">ğŸªª Proof Passport</div>
          <div style="font-size:13px;color:var(--muted)">A shareable, verifiable snapshot of your wallet's security state. Tweet it, share it, flex it.</div>
        </div>
        <div class="passport-inner">

          <!-- Card Preview -->
          <div class="passport-card-preview" id="passportCard">
            <div class="pp-watermark" id="ppWatermark">PREVIEW</div>
            <div class="pp-logo"><div class="pp-logo-dot"></div>CycleX Firewall</div>
            <div class="pp-wallet" id="ppWallet">0x...</div>
            <div class="pp-score-row">
              <div>
                <div class="pp-score-big" id="ppScore" style="color:#ffd166">â€”</div>
                <div class="pp-score-label">Firewall Score</div>
              </div>
              <div class="pp-status" id="ppStatus">âš  Exposed</div>
            </div>
            <div class="pp-stats">
              <div class="pp-stat">
                <div class="pp-stat-val" id="ppApprovals" style="color:#ff6b6b">â€”</div>
                <div class="pp-stat-key">Risky Approvals</div>
              </div>
              <div class="pp-stat">
                <div class="pp-stat-val" id="ppBlast" style="color:#ffd166">â€”</div>
                <div class="pp-stat-key">Blast Radius</div>
              </div>
              <div class="pp-stat">
                <div class="pp-stat-val" id="ppDrain" style="color:#ff4757">â€”</div>
                <div class="pp-stat-key">Drain Time</div>
              </div>
              <div class="pp-stat">
                <div class="pp-stat-val" id="ppChain">BSC</div>
                <div class="pp-stat-key">Network</div>
              </div>
            </div>
            <div class="pp-date" id="ppDate">Scanned: â€”</div>
          </div>

          <!-- Actions -->
          <div class="passport-actions">
            <h3>Share your Wallet Passport</h3>
            <p>Generate a proof badge others can verify. No KYC. Signed snapshot of on-chain data.</p>
            <button class="btn-passport" id="btnShareX">ğŸ¦ Share to X (Twitter)</button>
            <button class="btn-passport secondary" id="btnCopyPassport">ğŸ“‹ Copy Passport Text</button>
            <button class="btn-passport secondary" id="btnCopyLink">ğŸ”— Copy Share Link</button>
            <div class="passport-shared" id="passportShared"></div>
          </div>
        </div>
      </div>

      <!-- SPEND RULES TEMPLATES -->
      <div class="section-title">Firewall Rules</div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:16px">
        <div style="font-size:16px;font-weight:800;margin-bottom:4px">ğŸ”’ Spend Limit Templates</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:18px">Apply a spending rule profile to minimize future exposure.</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px" id="ruleTemplates">
          <!-- rendered by JS -->
        </div>
      </div>

    </div><!-- end #dashboard -->
  </main>

  <footer class="footer">
    <div>
      <span class="footer-brand">CycleX Firewall</span>
      <span style="margin:0 8px;opacity:.35">Â·</span>
      <span>Wallet Protection Tool</span>
    </div>
    <div class="footer-note">
      Informational only. No signatures. No transactions. Always verify contracts independently.
      All revoke actions happen on-chain directly from this site.
    </div>
  </footer>

</div><!-- .page-shell -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CycleX Firewall â€” LIVE ENGINE v2.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMO_WALLET = "0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD";
const CYCX_BSC    = "0xda63b65825AE30532a507B0C091B0bD9F8204F7E";
const PASS_BSC    = "0x718bc4E915fF66249C1eB86Eb566Ce4fefCA801e";
const CYCX_MIN    = 100n;   // minimum CYCX
const PASS_MIN    = 1n;     // minimum PASS
const API_BASE    = window.CYCLEX_API_BASE || location.origin;

const GATE_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
const ERC20_APPROVE_ABI = ["function approve(address spender, uint256 amount) returns (bool)"];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fwAccessTier   = "free";      // "free" | "full"
let fwScanData     = null;        // raw parsed approvals
let fwCurrentScore = 0;
let fwWallet       = "";
let fwNet          = "bsc";
let fixDone        = [false, false, false];
let fixApprovals   = [];          // top revocable approvals for fix steps
const scoreIncrements = [18, 14, 10];

// â”€â”€ ETHERS BRIDGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getE()  { return window.E || window.ethers; }
function getRPC(net) {
  if (typeof getReadProvider === "function") return getReadProvider(net);
  if (window.CX?.getReadProvider) return window.CX.getReadProvider(net);
  return null;
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wait     = ms => new Promise(r => setTimeout(r, ms));
function fwShort(a) {
  if (!a || a.length < 12) return a || "â€”";
  return a.slice(0, 8) + "â€¦" + a.slice(-5);
}
function today() {
  return new Date().toLocaleDateString("en-US", { year:"numeric", month:"short", day:"numeric" });
}
function esc(s) {
  return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function fwIsAddr(a) {
  try {
    const E = getE();
    if (E?.isAddress) return E.isAddress(a);
    if (E?.utils?.isAddress) return E.utils.isAddress(a);
    return /^0x[0-9a-fA-F]{40}$/.test(a);
  } catch { return /^0x[0-9a-fA-F]{40}$/.test(String(a||"")); }
}
function fwNorm(a) {
  try {
    const E = getE();
    if (E?.getAddress) return E.getAddress(a);
    if (E?.utils?.getAddress) return E.utils.getAddress(a);
  } catch {}
  return String(a || "");
}
function isUnlimitedAllow(v) {
  const s = String(v || "").toLowerCase().trim();
  if (s === "âˆ" || s === "infinite" || s === "unlimited" || s.includes("inf")) return true;
  try {
    const n = BigInt(s);
    return n > (2n ** 200n);
  } catch { return false; }
}
function fmtUSD(n) {
  if (!Number.isFinite(n) || n <= 0) return "â€”";
  if (n >= 1_000_000) return `$${(n/1_000_000).toFixed(1)}M`;
  if (n >= 1_000)    return `$${(n/1_000).toFixed(1)}K`;
  return `$${n.toFixed(0)}`;
}

// â”€â”€ API FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchApprovals(net, address) {
  const u = new URL("/api/getApprovals", API_BASE);
  u.searchParams.set("net", net);
  u.searchParams.set("address", address);

  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), 18000);

  try {
    const res = await fetch(u.toString(), { method:"GET", signal:ctrl.signal });
    if (res.status === 429) {
      const e = new Error("RATE_LIMIT"); e.status = 429; throw e;
    }
    if (!res.ok) {
      const e = new Error(`API_${res.status}`); e.status = res.status; throw e;
    }
    const data = await res.json();
    return Array.isArray(data) ? data
      : Array.isArray(data?.approvals) ? data.approvals
      : Array.isArray(data?.result)    ? data.result
      : Array.isArray(data?.data)      ? data.data
      : [];
  } finally { clearTimeout(t); }
}

// â”€â”€ METRICS COMPUTATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeMetrics(approvals) {
  const rows = approvals.map(r => {
    const allow  = String(r?.allowance ?? r?.value ?? r?.approved_amount ?? "0");
    const symbol = String(r?.symbol || r?.token_symbol || r?.tokenSymbol || "TOKEN");
    const token  = String(r?.token || r?.token_address || r?.tokenAddress || "");
    const spender= String(r?.spender || r?.spender_address || "");
    const risk   = String(r?.risk || "â€”").toLowerCase();
    const verified = (r?.verified === true) ? true : (r?.verified === false) ? false : null;
    const decimals = Number(r?.decimals ?? r?.token_decimals ?? 18) || 18;
    return { allow, symbol, token, spender, risk, verified, decimals, raw:r };
  });

  const unlimited = rows.filter(r => isUnlimitedAllow(r.allow));
  const risky     = rows.filter(r => r.risk === "high" || isUnlimitedAllow(r.allow));
  const highRisk  = rows.filter(r => r.risk === "high");
  const unverified= rows.filter(r => r.verified === false);

  // Score: start at 100, penalize
  let score = 100;
  score -= unlimited.length  * 14;
  score -= highRisk.length   * 18;
  score -= unverified.length * 8;
  score = Math.max(5, Math.min(100, score));

  // Blast Radius: rough heuristic (unlimited Ã— token balance placeholder)
  // We expose the count; USD requires prices (shown as "?" if unavailable)
  const blastCount  = unlimited.length;
  const blastLabel  = blastCount === 0 ? "$0 exposed" : blastCount <= 2 ? "Limited exposure" : blastCount <= 6 ? "Moderate exposure" : "High exposure";
  const blastSuffix = blastCount > 0 ? ` (${blastCount} unlimited)` : "";
  const blastDisplay= `${blastLabel}${blastSuffix}`;

  // Time-to-Drain heuristic
  let drainTime, drainFast = false;
  if (unlimited.length === 0) {
    drainTime = "Safe (no unlimited)";
    drainFast = false;
  } else if (unlimited.length <= 2) {
    drainTime = "~5 min";
    drainFast = false;
  } else if (unlimited.length <= 6) {
    drainTime = "~90 sec";
    drainFast = true;
  } else {
    drainTime = "< 30 sec";
    drainFast = true;
  }

  const scoreLabel = score >= 85 ? "Protected" : score >= 70 ? "Exposed" : score >= 50 ? "Vulnerable" : "Critical";

  // Threats list (top 5, worst first)
  const sorted = [...rows].sort((a, b) => {
    const rA = a.risk === "high" ? 3 : a.risk === "medium" ? 2 : 1;
    const rB = b.risk === "high" ? 3 : b.risk === "medium" ? 2 : 1;
    const uA = isUnlimitedAllow(a.allow) ? 1 : 0;
    const uB = isUnlimitedAllow(b.allow) ? 1 : 0;
    return (rB + uB) - (rA + uA);
  });
  const threats = sorted.slice(0, 5).map(r => ({
    name: r.spender ? fwShort(r.spender) : "Unknown",
    fullSpender: r.spender,
    token: r.token,
    label: r.risk === "high" ? "High Risk" : r.verified === false ? "Unverified" : isUnlimitedAllow(r.allow) ? "Unlimited" : "Capped",
    damage: isUnlimitedAllow(r.allow) ? "Max exposure" : "Capped",
    risk: r.risk === "high" ? "bad" : isUnlimitedAllow(r.allow) ? "warn" : "ok",
    why: r.risk === "high" ? "High-risk spender. Revoke recommended."
       : r.verified === false ? "Unverified contract. Review before trusting."
       : isUnlimitedAllow(r.allow) ? "Unlimited approval. Consider revoking or capping."
       : "Capped approval. Lower risk.",
    tokens: [r.symbol || "TOKEN"],
    isUnlimited: isUnlimitedAllow(r.allow),
    canRevoke: !!(r.token && r.spender)
  }));

  // Fix targets (top 3 revocable)
  const fixTargets = sorted.filter(r => r.canRevoke !== false && r.token && r.spender).slice(0, 3);

  return {
    score, scoreLabel,
    blastDisplay,
    drainTime, drainFast,
    riskyApprovals: risky.length,
    unlimitedCount: unlimited.length,
    highRiskCount: highRisk.length,
    unverifiedCount: unverified.length,
    totalApprovals: rows.length,
    rows,          // â† full normalized rows array (needed by Rule Templates & Revoke All)
    threats,
    fixTargets,
    scoreMeta: [
      ...(unlimited.length  ? [{ label: `${unlimited.length} unlimited`,  cls:"bad" }] : []),
      ...(highRisk.length   ? [{ label: `${highRisk.length} high-risk`,   cls:"bad" }] : []),
      ...(unverified.length ? [{ label: `${unverified.length} unverified`,cls:"warn"}] : []),
      ...(!unlimited.length && !highRisk.length ? [{ label:"No unlimited detected", cls:"ok" }] : [])
    ],
    blastMeta: blastCount > 0 ? [
      { label: `${blastCount} unlimited spenders`, cls:"bad" },
      { label: "Revoke to reduce exposure", cls:"warn" }
    ] : [{ label: "No unlimited approvals âœ“", cls:"ok" }],
    drainMeta: drainFast ? [
      { label: "Unlimited + active spenders", cls:"bad" }
    ] : [{ label: "Low drain risk", cls:"ok" }]
  };
}

// â”€â”€ APPKIT INTEGRATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APPKIT_PROJECT_ID = "7886bcb95105e9e47337cec481d5de75";
let _appkitLoadPromise = null;

async function fwLoadAppKit() {
  if (window.CxAppKitModal) return window.CxAppKitModal;
  if (_appkitLoadPromise) return _appkitLoadPromise;
  _appkitLoadPromise = (async () => {
    const [{ createAppKit }, { EthersAdapter }, { bsc, mainnet }] = await Promise.all([
      import("https://esm.sh/@reown/appkit@1.8.15"),
      import("https://esm.sh/@reown/appkit-adapter-ethers@1.8.15"),
      import("https://esm.sh/@reown/appkit/networks"),
    ]);
    const appkit = createAppKit({
      adapters: [new EthersAdapter()],
      networks: [bsc, mainnet],
      defaultNetwork: bsc,
      projectId: APPKIT_PROJECT_ID,
      analytics: false,
      metadata: {
        name: "CycleX Firewall",
        description: "CycleX Wallet Firewall",
        url: window.location.origin,
        icons: [`${window.location.origin}/logo.png`]
      }
    });
    window.CxAppKitModal = appkit;
    if (!window.E && window.ethers) window.E = window.ethers;
    return appkit;
  })();
  return _appkitLoadPromise;
}

async function fwWaitForWallet(timeoutMs = 16000) {
  const start = Date.now();
  while (Date.now() - start < timeoutMs) {
    if (window.wallet?.address) return window.wallet.address;
    try {
      const p = window.CxAppKitModal?.getWalletProvider?.();
      if (p) {
        const Eth = window.E || window.ethers;
        if (Eth) {
          const web3Provider = new Eth.BrowserProvider(p);
          const signer = await web3Provider.getSigner();
          const address = await signer.getAddress();
          if (address) {
            if (!window.wallet) window.wallet = {};
            window.wallet.address     = address;
            window.wallet.signer      = signer;
            window.wallet.providerRaw = p;
            return address;
          }
        }
      }
    } catch {}
    await wait(350);
  }
  return null;
}

// â”€â”€ ACCESS GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setGateStatus(msg, color="#a0a0b0") {
  const el = document.getElementById("gateStatus");
  if (el) { el.textContent = msg; el.style.color = color; }
}

async function checkCycxPass() {
  const Eth = getE() || window.ethers;
  if (!Eth?.Contract) return { eligible:false, reason:"ethers_missing" };
  const addr = window.wallet?.address;
  if (!addr) return { eligible:false, reason:"no_wallet" };

  try {
    const runCheck = async (provider) => {
      const cycxC = new Eth.Contract(CYCX_BSC, GATE_ABI, provider);
      const passC = new Eth.Contract(PASS_BSC, GATE_ABI, provider);
      let cycxDec = 18n;
      try { cycxDec = BigInt(await cycxC.decimals()); } catch {}
      const [cycxBal, passBal] = await Promise.all([
        cycxC.balanceOf(addr).catch(()=>0n),
        passC.balanceOf(addr).catch(()=>0n)
      ]);
      const cycxMin = CYCX_MIN * (10n ** cycxDec);
      return {
        eligible: BigInt(passBal) >= PASS_MIN || BigInt(cycxBal) >= cycxMin,
        hasPass:  BigInt(passBal) >= PASS_MIN,
        hasCycx:  BigInt(cycxBal) >= cycxMin
      };
    };

    if (typeof withRpcFallback === "function") {
      const r = await withRpcFallback("bsc", runCheck, { timeoutMs:9000 });
      if (!r.ok) return { eligible:false, reason:"rpc_failed" };
      return { ok:true, ...r.res };
    }
    const provider = getRPC("bsc");
    if (!provider) return { eligible:false, reason:"no_rpc" };
    return { ok:true, ...(await runCheck(provider)) };
  } catch(e) {
    return { eligible:false, reason: e.message };
  }
}

async function requestFullAccess() {
  if (fwAccessTier === "full") return;
  setGateStatus("Loading wallet moduleâ€¦", "#a87eff");

  let appkit;
  try {
    appkit = await fwLoadAppKit();
  } catch(e) {
    setGateStatus("Could not load wallet module. Check your connection.", "#ff7a8a");
    return;
  }

  if (!window.wallet?.address) {
    try {
      setGateStatus("Opening wallet connectâ€¦", "#a87eff");
      await appkit.open();
      const addr = await fwWaitForWallet(20000);
      if (!addr) { setGateStatus("Wallet not connected. Please try again.", "#ff9a6b"); return; }
    } catch(e) {
      setGateStatus("Connect cancelled or failed.", "#ff9a6b");
      return;
    }
  }

  setGateStatus("Checking CYCX / PASS on BSCâ€¦", "#a87eff");
  const res = await checkCycxPass();
  const eligible = res.eligible === true || (res.ok && res.eligible);

  if (eligible) {
    const why = res.hasPass ? "PASS âœ“" : `${Number(CYCX_MIN)} CYCX âœ“`;
    setGateStatus(`Eligible (${why}) â€” unlocking!`, "#5dffb2");
    await wait(700);
    unlockFull();
    if (fwScanData) renderDashboard(fwWallet, fwScanData, "full");
    return;
  }

  const msg =
    res.reason === "no_wallet"      ? "Wallet not detected." :
    res.reason === "ethers_missing" ? "Ethers.js not loaded. Refresh and try again." :
    res.reason === "rpc_failed"     ? "BSC RPC check failed. Try again." :
    res.reason === "no_rpc"         ? "BSC RPC unavailable. Try again." :
    `Not eligible. Need â‰¥${Number(CYCX_MIN)} CYCX or 1 PASS on BSC.`;
  setGateStatus(msg, "#ff7a8a");
}

// â”€â”€ PASS POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPassPopup()  { const el = document.getElementById("passPopup"); if(el) el.style.display="flex"; }
function closePassPopup() { const el = document.getElementById("passPopup"); if(el) el.style.display="none"; }

function unlockFull() {
  fwAccessTier = "full";
  document.getElementById("accessGateOverlay")?.style && (document.getElementById("accessGateOverlay").style.display = "none");
  document.getElementById("tierBadge") && (document.getElementById("tierBadge").style.display = "flex");
  document.getElementById("btnTopAccess") && (document.getElementById("btnTopAccess").style.display = "none");
  // Remove lock overlays
  document.getElementById("fixLockOverlay")    && (document.getElementById("fixLockOverlay").style.display    = "none");
  document.getElementById("passportLockOverlay")&& (document.getElementById("passportLockOverlay").style.display = "none");
  // Remove passport watermark
  document.getElementById("ppWatermark") && (document.getElementById("ppWatermark").style.display = "none");
}

// â”€â”€ LOADING SEQUENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runLoadSequence(walletAddr, net, isDemo) {
  fwWallet = walletAddr;
  fwNet    = net;

  const hero    = document.getElementById("heroSection");
  const loadWrap= document.getElementById("loadWrap");
  const dash    = document.getElementById("dashboard");

  hero.style.transition = "opacity .3s ease, transform .3s ease";
  hero.style.opacity = "0";
  hero.style.transform = "translateY(-12px)";
  await wait(320);
  hero.style.display = "none";

  loadWrap.style.display = "block";
  document.getElementById("loadLabel").textContent = `Scanning ${fwShort(walletAddr)}â€¦`;

  const steps = ["step1","step2","step3","step4"];
  const fill  = document.getElementById("loadBarFill");

  // Step 1: fetch logs (real or demo)
  const s1 = document.getElementById("step1");
  s1.classList.add("active");
  fill.style.width = "25%";

  let approvals = [];
  let scanError = null;

  if (!isDemo) {
    try {
      approvals = await fetchApprovals(net, walletAddr);
    } catch(e) {
      scanError = e;
      // fall through with empty array â€” will show error
    }
  } else {
    approvals = getDemoApprovals();
    await wait(700);
  }
  s1.classList.remove("active"); s1.classList.add("done");
  s1.querySelector(".step-icon").textContent = "âœ“";

  // Steps 2-4: visual only
  for (let i = 1; i < 4; i++) {
    const el = document.getElementById(steps[i]);
    el.classList.add("active");
    fill.style.width = ((i+1)/4*100) + "%";
    await wait(600 - i*80);
    el.classList.remove("active"); el.classList.add("done");
    el.querySelector(".step-icon").textContent = "âœ“";
  }

  await wait(250);
  loadWrap.style.display = "none";
  dash.style.display = "block";

  if (scanError) {
    const notice = document.getElementById("demoNotice");
    if (notice) {
      notice.style.display = "block";
      notice.innerHTML = scanError.status === 429
        ? "<strong>Rate limit:</strong> Max 2 scans per hour per IP. Try again in a moment."
        : `<strong>Scan failed (${scanError.status || "network"}):</strong> Using demo data. Backend may be offline.`;
    }
    approvals = getDemoApprovals();
  }

  // Show notices
  const scanNotice = document.getElementById("scanNotice");
  const demoNotice = document.getElementById("demoNotice");
  if (!isDemo && !scanError) {
    if (scanNotice) scanNotice.style.display = "block";
    if (demoNotice) demoNotice.style.display = "none";
  } else if (isDemo) {
    if (demoNotice) demoNotice.style.display = "block";
    if (scanNotice) scanNotice.style.display = "none";
  }

  fwScanData = computeMetrics(approvals);
  fixApprovals = fwScanData.fixTargets;

  // Show access gate in free tier
  if (fwAccessTier === "free") {
    const gate = document.getElementById("accessGateOverlay");
    if (gate) gate.style.display = "block";
  }

  renderDashboard(walletAddr, fwScanData, fwAccessTier);
}

// â”€â”€ RENDER DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(wallet, d, tier) {
  fwCurrentScore = d.score;
  fixDone = [false, false, false];

  // Wallet badge
  document.getElementById("walletBadge").textContent = fwShort(wallet);
  document.getElementById("netBadge").textContent = fwNet.toUpperCase();

  // Score gauge (always visible)
  animateScore(d.score, d.scoreLabel, d.scoreMeta);

  // Blast Radius (free = count/text, full = detailed)
  document.getElementById("blastAmt").textContent = d.blastDisplay;
  renderMeta("blastMeta", d.blastMeta);

  // Time-to-Drain (always visible)
  setTimeout(() => {
    const el = document.getElementById("drainTime");
    el.textContent = d.drainTime;
    el.classList.toggle("drain-fast", !!d.drainFast);
    renderMeta("drainMeta", d.drainMeta);
  }, 600);

  // Exposure Map
  setTimeout(() => renderExposureMap(wallet, d.threats, tier), 400);

  // Threats
  setTimeout(() => renderThreats(d.threats, tier), 600);

  // Fix Mode
  if (tier === "full") {
    setTimeout(() => renderFixMode(d), 300);
  } else {
    renderFixGainPreview(d.score);
  }

  // Passport
  renderPassport(wallet, d, tier);

  // Rules
  renderRuleTemplates();
}

// â”€â”€ SCORE GAUGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animateScore(target, label, meta) {
  const circumference = 226.2;
  const fill  = document.getElementById("gaugeFill");
  const numEl = document.getElementById("scoreNum");
  const labEl = document.getElementById("scoreLabel");
  const dotEl = document.getElementById("scoreDot");

  const color = target < 45 ? "#ff4757" : target < 70 ? "#ffd166" : "#3cffb0";
  fill.style.stroke = color;
  dotEl.style.background = color;

  let cur = 0;
  const step = target / 35;
  const timer = setInterval(() => {
    cur = Math.min(cur + step, target);
    numEl.textContent = Math.round(cur);
    fill.style.strokeDashoffset = circumference - (circumference * cur / 100);
    if (cur >= target) {
      clearInterval(timer);
      labEl.textContent = label;
      renderMeta("scoreMeta", meta);
    }
  }, 28);
}

function renderMeta(id, items) {
  const el = document.getElementById(id);
  if (!el || !items) return;
  el.innerHTML = items.map(i => `<div class="meta-chip ${i.cls}">${esc(i.label)}</div>`).join("");
}

// â”€â”€ EXPOSURE MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderExposureMap(wallet, threats, tier) {
  const svg = document.getElementById("exposureMap");
  const W = 480, H = 260, cx = W/2, cy = H/2;
  const riskColor = { bad:"#ff4757", warn:"#ffd166", ok:"#3cffb0" };

  // In free tier, show max 3 threats; full shows all 5
  const visible = tier === "free" ? threats.slice(0, 3) : threats;
  const n = visible.length;
  if (!n) { svg.innerHTML = `<text x="${W/2}" y="${H/2}" text-anchor="middle" fill="rgba(244,246,255,.35)" font-size="13" font-family="system-ui">No spenders detected</text>`; return; }

  const pos = visible.map((_, i) => {
    const a = (i/n) * Math.PI*2 - Math.PI/2;
    return { x: cx + 98*Math.cos(a), y: cy + 98*Math.sin(a) };
  });

  const tokPos = [];
  visible.forEach((t, ti) => {
    t.tokens.forEach((tok, ki) => {
      const a = ((ti + ki*.28)/n)*Math.PI*2 - Math.PI/2;
      tokPos.push({ x: cx + 168*Math.cos(a + ki*.32), y: cy + 168*Math.sin(a + ki*.32), name:tok, ti });
    });
  });

  let h = `<defs>
    <radialGradient id="gC" cx="50%" cy="50%" r="50%">
      <stop offset="0%" stop-color="rgba(0,229,255,.4)"/>
      <stop offset="100%" stop-color="rgba(0,229,255,.05)"/>
    </radialGradient>
    <filter id="glow"><feGaussianBlur stdDeviation="2.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
  </defs>`;

  visible.forEach((t, i) => {
    const p = pos[i];
    const col = riskColor[t.risk] || "#888";
    h += `<line x1="${cx}" y1="${cy}" x2="${p.x}" y2="${p.y}" stroke="${col}" stroke-width="${t.risk==="bad"?2:1.2}" stroke-opacity=".5" stroke-dasharray="4 3"/>`;
  });
  tokPos.forEach(tp => {
    const sp = pos[tp.ti];
    if (!sp) return;
    h += `<line x1="${sp.x}" y1="${sp.y}" x2="${tp.x}" y2="${tp.y}" stroke="rgba(255,255,255,.15)" stroke-width="1"/>`;
  });
  tokPos.forEach(tp => {
    h += `<circle cx="${tp.x}" cy="${tp.y}" r="11" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.18)" stroke-width="1"/>
      <text x="${tp.x}" y="${tp.y}" text-anchor="middle" dominant-baseline="middle" fill="rgba(244,246,255,.75)" font-size="8" font-family="system-ui" font-weight="700">${esc(tp.name).slice(0,6)}</text>`;
  });
  visible.forEach((t, i) => {
    const p = pos[i];
    const col = riskColor[t.risk] || "#888";
    const r   = t.risk === "bad" ? 22 : 17;
    h += `<circle cx="${p.x}" cy="${p.y}" r="${r+8}" fill="${col}" fill-opacity=".06"/>
      <circle cx="${p.x}" cy="${p.y}" r="${r}" fill="rgba(5,6,10,.9)" stroke="${col}" stroke-width="1.5" filter="url(#glow)"/>
      <text x="${p.x}" y="${p.y}" text-anchor="middle" dominant-baseline="middle" fill="${col}" font-size="8" font-family="system-ui" font-weight="800">${esc(t.label).split(" ").map(w=>w[0]).join("").slice(0,4)}</text>`;
  });

  // Greyed-out locked spots for free tier
  if (tier === "free" && threats.length > 3) {
    for (let i = 3; i < Math.min(threats.length, 5); i++) {
      const a = (i/threats.length)*Math.PI*2 - Math.PI/2;
      const x = cx + 98*Math.cos(a), y = cy + 98*Math.sin(a);
      h += `<circle cx="${x}" cy="${y}" r="17" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" stroke-width="1" stroke-dasharray="3 3"/>
        <text x="${x}" y="${y}" text-anchor="middle" dominant-baseline="middle" fill="rgba(255,255,255,.22)" font-size="12">ğŸ”’</text>`;
    }
  }

  h += `<circle cx="${cx}" cy="${cy}" r="36" fill="url(#gC)"/>
    <circle cx="${cx}" cy="${cy}" r="28" fill="rgba(0,229,255,.10)" stroke="rgba(0,229,255,.45)" stroke-width="1.5"/>
    <text x="${cx}" y="${cy-5}" text-anchor="middle" dominant-baseline="middle" fill="rgba(0,229,255,.95)" font-size="9" font-family="system-ui" font-weight="900">WALLET</text>
    <text x="${cx}" y="${cy+8}" text-anchor="middle" dominant-baseline="middle" fill="rgba(0,229,255,.65)" font-size="7.5" font-family="ui-monospace,monospace">${esc(fwShort(wallet))}</text>`;

  svg.innerHTML = h;
}

// â”€â”€ THREATS LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderThreats(threats, tier) {
  const el = document.getElementById("threatsList");
  if (!el) return;
  if (!threats.length) {
    el.innerHTML = `<div style="text-align:center;color:var(--muted);padding:24px;font-size:13px">âœ… No significant threats detected.</div>`;
    return;
  }
  el.innerHTML = threats.map((t, i) => {
    const isLocked = tier === "free" && i >= 3;
    return `
    <div class="threat-item" style="${isLocked ? "filter:blur(5px);pointer-events:none;user-select:none" : ""}">
      <div class="threat-top">
        <div>
          <div class="threat-name">${esc(t.name)}</div>
          <div class="threat-meta">
            <span class="sig ${t.risk}"><span class="sig-dot"></span>${esc(t.label)}</span>
            ${t.tokens.map(tk=>`<span class="meta-chip" style="font-size:10px;padding:3px 7px">${esc(tk)}</span>`).join("")}
          </div>
        </div>
        <div style="text-align:right;flex:0 0 auto">
          <div class="threat-damage">${t.isUnlimited ? "âˆ Unlimited" : "Capped"}</div>
          ${(tier === "full" && t.canRevoke) ? `<button class="btn-fix-small" onclick="revokeSpender('${esc(t.fullSpender)}','${esc(t.token)}',this)">Revoke â†—</button>` : (tier === "free" ? `<button class="btn-fix-small" onclick="requestFullAccess()" style="border-color:rgba(124,92,255,.4);color:#a87eff">Unlock â†—</button>` : "")}
        </div>
      </div>
      <div class="threat-why">${esc(t.why)}</div>
    </div>`;
  }).join("");
}

// â”€â”€ FIX MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFixMode(d) {
  // Update step descriptions to show real spenders
  if (fixApprovals[0]) {
    const el = document.querySelector("#fixStep1 .fix-step-desc");
    if (el) el.textContent = `Remove unlimited allowance from ${fwShort(fixApprovals[0].spender)} (top-risk spender on ${fixApprovals[0].symbol}).`;
  }
  if (fwScanData?.unlimitedCount > 0) {
    const el = document.querySelector("#fixStep2 .fix-step-desc");
    if (el) el.textContent = `Revoke all ${fwScanData.unlimitedCount} unlimited approval(s) on this wallet â€” one on-chain tx each.`;
  }

  // Update button 1 to direct revoke if wallet connected
  const btn1 = document.getElementById("btnFix1");
  if (btn1 && window.wallet?.address && fixApprovals[0]) {
    btn1.textContent = `Revoke ${fixApprovals[0].symbol} spender`;
  }

  renderFixGainPreview(d.score);
}

function renderFixGainPreview(score) {
  const total = scoreIncrements.reduce((a,b)=>a+b,0);
  const newScore = Math.min(100, score + total);
  const el = document.getElementById("fixGain");
  if (el) el.style.display = "flex";
  const ns = document.getElementById("fixNewScore");
  if (ns) ns.textContent = newScore;
  const fd = document.getElementById("fixDelta");
  if (fd) fd.textContent = total;
}

// â”€â”€ SHARED: score update after fix step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwUpdateScoreAfterFix(step) {
  fwCurrentScore = Math.min(100, fwCurrentScore + scoreIncrements[step]);
  document.getElementById("scoreNum").textContent = fwCurrentScore;
  const c = 226.2;
  document.getElementById("gaugeFill").style.strokeDashoffset = c - (c * fwCurrentScore / 100);
  const col = fwCurrentScore < 45 ? "#ff4757" : fwCurrentScore < 70 ? "#ffd166" : "#3cffb0";
  document.getElementById("gaugeFill").style.stroke = col;
  document.getElementById("scoreDot").style.background = col;
  document.getElementById("scoreLabel").textContent = fwCurrentScore >= 85 ? "Protected" : fwCurrentScore >= 70 ? "Exposed" : "Vulnerable";
  const pp = document.getElementById("ppScore");
  if (pp) { pp.textContent = fwCurrentScore; pp.style.color = col; }
  if (fixDone.every(Boolean)) {
    const fc = document.getElementById("fixComplete"); if (fc) fc.style.display = "flex";
    const fs = document.getElementById("finalScore");  if (fs) fs.textContent = fwCurrentScore;
  }
}

async function applyFix(step) {
  if (fixDone[step]) return;
  if (fwAccessTier !== "full") { requestFullAccess(); return; }

  const el  = document.getElementById(`fixStep${step+1}`);
  const btn = document.getElementById(`btnFix${step+1}`);
  if (!el || !btn) return;

  const target = fixApprovals[step];

  // â”€â”€ STEP 0: Revoke top spender on-chain (approve â†’ 0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (step === 0) {
    if (!window.wallet?.signer) { requestFullAccess(); return; }
    if (!target?.token || !target?.spender) {
      btn.textContent = "âœ“ No target found"; btn.disabled = true; el.classList.add("step-done");
      fixDone[0] = true; fwUpdateScoreAfterFix(0); return;
    }
    btn.disabled = true; btn.textContent = "Sending revoke txâ€¦";
    try {
      const E = getE();
      await fwEnsureBsc(window.wallet.providerRaw);
      const c = new E.Contract(fwNorm(target.token), ERC20_APPROVE_ABI, window.wallet.signer);
      const tx = await c.approve(fwNorm(target.spender), 0n);
      btn.textContent = `Pendingâ€¦ ${tx.hash?.slice(0,10)}`;
      await tx.wait();
      btn.textContent = "âœ“ Revoked";
    } catch(e) {
      if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
        btn.disabled = false; btn.textContent = "Revoke (retry)"; return;
      }
      btn.textContent = "âœ— Failed â€” retry"; btn.disabled = false;
      showPassportMsg(`âš  Revoke failed: ${e.message?.slice(0,80)}`); return;
    }

  // â”€â”€ STEP 1: Revoke ALL unlimited approvals (like DNA revokeAll) â”€â”€â”€
  } else if (step === 1) {
    if (!window.wallet?.signer) { requestFullAccess(); return; }
    const rows = fwScanData?.rows || [];
    const unlimitedRows = rows.filter(r => isUnlimitedAllow(r.allow) && r.token && r.spender);
    if (!unlimitedRows.length) {
      btn.textContent = "âœ“ No unlimited to revoke"; btn.disabled = true; el.classList.add("step-done");
      fixDone[1] = true; fwUpdateScoreAfterFix(1); return;
    }
    btn.disabled = true;
    await fwEnsureBsc(window.wallet.providerRaw);
    const E = getE();
    let done = 0, failed = 0;
    for (let i = 0; i < unlimitedRows.length; i++) {
      const r = unlimitedRows[i];
      try {
        btn.textContent = `Revoking ${i+1}/${unlimitedRows.length}â€¦`;
        const c = new E.Contract(fwNorm(r.token), ERC20_APPROVE_ABI, window.wallet.signer);
        const tx = await c.approve(fwNorm(r.spender), 0n);
        btn.textContent = `Pending ${i+1}/${unlimitedRows.length}â€¦`;
        await tx.wait();
        done++;
      } catch(e) {
        if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
          btn.disabled = false; btn.textContent = `Revoke All (${done} done â€” retry)`;
          showPassportMsg(`âš  Cancelled after ${done} revokes. Press again to continue.`);
          // Store undo data for what was done so far
          window.__fwUndoData = window.__fwUndoData || {};
          window.__fwUndoData[1] = { all: unlimitedRows.slice(0, done) };
          if (done > 0) {
            const undoBtn1 = document.getElementById("undoFix2");
            if (undoBtn1) undoBtn1.style.display = "block";
          }
          return;
        }
        failed++;
      }
    }
    btn.textContent = failed === 0
      ? `âœ“ All ${done} revoked`
      : `âœ“ ${done} revoked (${failed} failed)`;
    // Store undo data
    window.__fwUndoData = window.__fwUndoData || {};
    window.__fwUndoData[1] = { all: unlimitedRows };
    showPassportMsg(`âœ… Revoke All: ${done} approval(s) revoked${failed>0?`, ${failed} failed`:""}. Re-scan to verify.`);

  // â”€â”€ STEP 2: Flag top risky to local watchlist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  } else if (step === 2) {
    const watchTarget = fixApprovals[2] || fixApprovals[1] || fixApprovals[0];
    if (watchTarget?.spender) {
      try {
        const existing = JSON.parse(localStorage.getItem("cx_watchlist") || "[]");
        const key = `${fwNet}:${watchTarget.spender}`;
        if (!existing.find(x => `${x.net}:${x.spender}` === key))
          existing.unshift({ spender: watchTarget.spender, token: watchTarget.token,
            symbol: watchTarget.symbol, addedAt: new Date().toISOString(), net: fwNet });
        localStorage.setItem("cx_watchlist", JSON.stringify(existing.slice(0, 50)));
      } catch {}
    }
    btn.textContent = "âœ“ Added to local watchlist";
    btn.disabled = true; el.classList.add("step-done"); fixDone[2] = true;
    const undoBtn3 = document.getElementById("undoFix3");
    if (undoBtn3) undoBtn3.style.display = "block";
    fwUpdateScoreAfterFix(2);
    return;
  }

  fixDone[step] = true;
  btn.disabled = true; btn.classList.add("done"); el.classList.add("step-done");

  // Show undo button
  const undoBtn = document.getElementById(`undoFix${step+1}`);
  if (undoBtn) {
    undoBtn.style.display = "block";
    window.__fwUndoData = window.__fwUndoData || {};
    if (!window.__fwUndoData[step])
      window.__fwUndoData[step] = target
        ? { spender: target.spender, token: target.token, decimals: Number(target.decimals)||18 }
        : null;
  }

  fwUpdateScoreAfterFix(step);
}

// â”€â”€ UNDO FIX STEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function undoFix(step) {
  const undoBtn = document.getElementById(`undoFix${step+1}`);
  const fixBtn  = document.getElementById(`btnFix${step+1}`);
  const el      = document.getElementById(`fixStep${step+1}`);

  // Step 2 = localStorage â€” no wallet needed
  if (step === 2) {
    try { localStorage.removeItem("cx_watchlist"); } catch {}
    if (undoBtn) undoBtn.style.display = "none";
    fixDone[2] = false;
    el?.classList.remove("step-done");
    if (fixBtn) { fixBtn.textContent = "Add to Watchlist"; fixBtn.disabled = false; fixBtn.classList.remove("done"); }
    fwCurrentScore = Math.max(0, fwCurrentScore - scoreIncrements[2]);
    document.getElementById("scoreNum").textContent = fwCurrentScore;
    showPassportMsg("â†© Watchlist entry removed.");
    return;
  }

  if (!window.wallet?.signer) { requestFullAccess(); return; }
  const data = window.__fwUndoData?.[step];
  const MAX_UINT = 2n**256n - 1n;

  // Build targets list: step 1 = all array, step 0 = single item
  const targets = (step === 1 && data?.all?.length) ? data.all
    : (data?.token && data?.spender) ? [data] : [];

  if (!targets.length) { showPassportMsg("âš  No undo data for this step."); return; }

  if (undoBtn) { undoBtn.disabled = true; undoBtn.textContent = `Restoring ${targets.length === 1 ? "approval" : targets.length + " approvals"}â€¦`; }
  const E = getE();
  let done = 0, failed = 0;

  for (const t of targets) {
    try {
      if (undoBtn && targets.length > 1) undoBtn.textContent = `Restoring ${done+1}/${targets.length}â€¦`;
      const c = new E.Contract(fwNorm(t.token), ERC20_APPROVE_ABI, window.wallet.signer);
      const tx = await c.approve(fwNorm(t.spender), MAX_UINT);
      await tx.wait();
      done++;
    } catch(e) {
      if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
        if (undoBtn) { undoBtn.disabled = false; undoBtn.textContent = `â†© Retry undo (${done} done)`; }
        showPassportMsg(`â†© Cancelled. ${done} approval(s) restored.`);
        return;
      }
      failed++;
    }
  }

  if (undoBtn) undoBtn.style.display = "none";
  fixDone[step] = false;
  el?.classList.remove("step-done");
  if (fixBtn) {
    fixBtn.textContent = step === 0 ? "Revoke Top Spender" : "Revoke All Unlimited";
    fixBtn.disabled = false; fixBtn.classList.remove("done");
  }
  fwCurrentScore = Math.max(0, fwCurrentScore - scoreIncrements[step]);
  document.getElementById("scoreNum").textContent = fwCurrentScore;
  const col2 = fwCurrentScore < 45 ? "#ff4757" : fwCurrentScore < 70 ? "#ffd166" : "#3cffb0";
  document.getElementById("gaugeFill").style.stroke = col2;
  document.getElementById("scoreDot").style.background = col2;
  delete window.__fwUndoData[step];
  showPassportMsg(`â†© Undo: ${done} approval(s) restored to unlimited${failed>0?`, ${failed} failed`:""}. Re-scan to verify.`);
}

async function revokeSpender(spender, token, btn) {
  if (!window.wallet?.signer) { requestFullAccess(); return; }
  btn.disabled = true; btn.textContent = "Sendingâ€¦";
  try {
    const E = getE();
    const c = new E.Contract(fwNorm(token), ERC20_APPROVE_ABI, window.wallet.signer);
    const tx = await c.approve(fwNorm(spender), 0n);
    btn.textContent = "Pendingâ€¦";
    await tx.wait();
    btn.textContent = "âœ“ Revoked";
    btn.classList.add("done");
  } catch(e) {
    btn.disabled = false;
    btn.textContent = "Retry â†—";
    showPassportMsg(`âš  Revoke failed: ${e.message?.slice(0,80)}`);
    // Note: revoke.cash line removed â€” all revokes happen on-chain via this site
  }
}

// â”€â”€ PASSPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPassport(wallet, d, tier) {
  document.getElementById("ppWallet").textContent = fwShort(wallet) + " Â· " + fwNet.toUpperCase();
  document.getElementById("ppScore").textContent = d.score;
  document.getElementById("ppApprovals").textContent = d.riskyApprovals;
  document.getElementById("ppBlast").textContent = d.unlimitedCount > 0 ? `${d.unlimitedCount} unlimited` : "Clean";
  document.getElementById("ppDrain").textContent = d.drainTime;
  document.getElementById("ppDate").textContent = "Scanned: " + today();
  document.getElementById("ppChain").textContent = fwNet.toUpperCase();

  const sc = d.score;
  const scoreEl = document.getElementById("ppScore");
  if (scoreEl) scoreEl.style.color = sc < 45 ? "#ff4757" : sc < 70 ? "#ffd166" : "#3cffb0";

  const statusEl = document.getElementById("ppStatus");
  if (sc < 45) {
    statusEl.textContent = "ğŸ§¨ Critical";
    statusEl.style.cssText = "border-color:rgba(255,71,87,.4);color:#ff6b6b;background:rgba(255,71,87,.10)";
  } else if (sc < 70) {
    statusEl.textContent = "âš  Exposed";
    statusEl.style.cssText = "border-color:rgba(255,193,7,.35);color:#ffd166;background:rgba(255,193,7,.10)";
  } else {
    statusEl.textContent = "âœ… Protected";
    statusEl.style.cssText = "border-color:rgba(93,255,178,.35);color:var(--green);background:rgba(93,255,178,.08)";
  }

  // Watermark: show for free, hide for full
  const wm = document.getElementById("ppWatermark");
  if (wm) wm.style.display = tier === "free" ? "flex" : "none";
}

function getPassportText() {
  const score   = document.getElementById("ppScore")?.textContent || "â€”";
  const blast   = document.getElementById("ppBlast")?.textContent || "â€”";
  const drain   = document.getElementById("ppDrain")?.textContent || "â€”";
  const net     = document.getElementById("ppChain")?.textContent || fwNet.toUpperCase();
  const risky   = document.getElementById("ppApprovals")?.textContent || "â€”";
  return `ğŸ”¥ CycleX Firewall Scan â€” ${today()}

Wallet: ${fwShort(fwWallet)}
Network: ${net}

ğŸ›¡ Firewall Score: ${score}/100
ğŸ’¥ Blast Radius: ${blast}
â± Drain Time: ${drain}
ğŸ¯ Risky Approvals: ${risky}

Scan your wallet â†’ https://cyclex.io/firewall
#CycleX #WalletSecurity #DeFi`;
}

// â”€â”€ RULE TEMPLATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RULES = [
  {
    name:"ğŸ”’ Strict",
    desc:"No unlimited. Revoke all unlimited approvals on your wallet now.",
    action:"revoke_all_unlimited"
  },
  {
    name:"âš– Balanced",
    desc:"Cap unlimited approvals for unknown spenders to 200 tokens.",
    action:"cap_unknown_200"
  },
  {
    name:"ğŸ“ˆ Trader",
    desc:"Allow known DEX unlimited. Flag new unknown spenders to watchlist.",
    action:"watchlist_only"
  }
];

function renderRuleTemplates() {
  const el = document.getElementById("ruleTemplates");
  if (!el) return;
  el.innerHTML = RULES.map((r, i) => `
    <div style="background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:16px 14px">
      <div style="font-size:14px;font-weight:800;margin-bottom:6px">${r.name}</div>
      <div style="font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:12px">${r.desc}</div>
      <button class="btn-action" id="ruleBtn${i}" onclick="applyRule(${i})" style="font-size:10px">Apply Template</button>
    </div>
  `).join("");
}

async function applyRule(i) {
  const rule = RULES[i];
  const btn = document.getElementById(`ruleBtn${i}`);
  if (!btn || btn.disabled) return;

  // â”€â”€ Watchlist-only (Trader) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (rule.action === "watchlist_only") {
    try {
      localStorage.setItem("cx_rule_profile", JSON.stringify({
        profile: rule.name, appliedAt: new Date().toISOString(), net: fwNet
      }));
    } catch {}
    btn.textContent = "âœ“ Profile saved locally"; btn.classList.add("done"); btn.disabled = true;
    showPassportMsg(`âœ… Rule "${rule.name}" saved as local profile.`);
    return;
  }

  // â”€â”€ On-chain rules: need wallet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!window.wallet?.signer) { requestFullAccess(); return; }
  if (!fwScanData?.rows || fwScanData.rows.length === 0) {
    showPassportMsg("âš  No approval data loaded. Run a scan first."); return;
  }

  btn.disabled = true;
  btn.textContent = "Preparingâ€¦";

  const E = getE();
  let targets = [];

  if (rule.action === "revoke_all_unlimited") {
    targets = fwScanData.rows.filter(r => isUnlimitedAllow(r.allow));
  } else if (rule.action === "cap_unknown_200") {
    targets = fwScanData.rows.filter(r => isUnlimitedAllow(r.allow) && r.verified === false);
  }

  if (targets.length === 0) {
    btn.textContent = "âœ“ Nothing to fix"; btn.classList.add("done");
    showPassportMsg(`âœ… No matching approvals found for "${rule.name}".`);
    return;
  }

  let done = 0, failed = 0;
  for (const t of targets) {
    try {
      btn.textContent = `Sending ${done+1}/${targets.length}â€¦`;
      const decimals = Number(t.decimals) || 18;
      const amount = rule.action === "revoke_all_unlimited" ? 0n
        : BigInt(200) * (10n ** BigInt(decimals));
      const c = new E.Contract(fwNorm(t.token), ERC20_APPROVE_ABI, window.wallet.signer);
      const tx = await c.approve(fwNorm(t.spender), amount);
      await tx.wait();
      done++;
    } catch(e) {
      if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
        btn.disabled = false;
        btn.textContent = "Cancelled â€” retry";
        showPassportMsg(`âš  Transaction cancelled (${done} done, ${targets.length - done} remaining).`);
        return;
      }
      failed++;
    }
  }

  btn.textContent = failed === 0 ? `âœ“ Done (${done} txs)` : `âœ“ Done (${done}/${targets.length})`;
  btn.classList.add("done");
  showPassportMsg(`âœ… Rule "${rule.name}": ${done} approval(s) updated${failed>0?`, ${failed} failed`:""}. Re-scan to verify.`);

  // Store undo data & show undo button after a short delay
  window.__fwRuleUndoData = window.__fwRuleUndoData || {};
  window.__fwRuleUndoData[i] = { targets, rule };
  await wait(800);
  btn.textContent = "â†© Undo Rule";
  btn.disabled = false;
  btn.classList.remove("done");
  btn.style.background = "rgba(255,100,50,.08)";
  btn.style.borderColor = "rgba(255,100,50,.3)";
  btn.style.color = "#ff9a6b";
  btn.onclick = () => undoRule(i);
}

// â”€â”€ UNDO RULE TEMPLATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function undoRule(i) {
  if (!window.wallet?.signer) { requestFullAccess(); return; }
  const undoData = window.__fwRuleUndoData?.[i];
  if (!undoData?.targets?.length) {
    showPassportMsg("âš  No undo data for this rule."); return;
  }
  const btn = document.getElementById(`ruleBtn${i}`);
  if (btn) { btn.disabled = true; btn.textContent = "Undoingâ€¦"; }

  const MAX_UINT = 2n**256n - 1n;
  const E = getE();
  let done = 0, failed = 0;

  for (const t of undoData.targets) {
    try {
      if (btn) btn.textContent = `Restoring ${done+1}/${undoData.targets.length}â€¦`;
      const c = new E.Contract(fwNorm(t.token), ERC20_APPROVE_ABI, window.wallet.signer);
      const tx = await c.approve(fwNorm(t.spender), MAX_UINT);
      await tx.wait();
      done++;
    } catch(e) {
      if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
        if (btn) { btn.disabled = false; btn.textContent = "â†© Retry undo"; }
        showPassportMsg(`âš  Undo cancelled (${done} done).`);
        return;
      }
      failed++;
    }
  }

  // Reset button to original "Apply Template" state
  if (btn) {
    btn.textContent = "Apply Template";
    btn.disabled = false;
    btn.style.background = "";
    btn.style.borderColor = "";
    btn.style.color = "";
    btn.onclick = () => applyRule(i);
  }
  delete window.__fwRuleUndoData[i];
  showPassportMsg(`â†© Undo complete: ${done} approval(s) restored to unlimited${failed>0?`, ${failed} failed`:""}. Re-scan to verify.`);
}

window.undoFix  = undoFix;
window.undoRule = undoRule;
function getDemoApprovals() {
  return [
    { token:"0xdAC17F958D2ee523a2206206994597C13D831ec7", spender:"0x1111111254eeb25477b68fb85ed929f73a960582", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"USDT", risk:"medium", verified:true,  decimals:6 },
    { token:"0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c",  spender:"0x10ED43C718714eb63d5aA57B78B54704E256024E", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"WBNB", risk:"low",    verified:true,  decimals:18 },
    { token:"0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82", spender:"0x6B175474E89094C44Da98b954EedeAC495271d0F", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"CAKE", risk:"high",   verified:false, decimals:18 },
    { token:"0x2170Ed0880ac9A755fd29B2688956BD959F933F8", spender:"0xDef1C0ded9bec7F1a1670819833240f027b25EfF", allowance:"500000000000000000000", symbol:"ETH",  risk:"low",    verified:true,  decimals:18 },
    { token:"0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56",  spender:"0x44aD3F17960f0da287c3acEE50fe7f3c5D5B9B8E", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"BUSD", risk:"high",   verified:false, decimals:18 },
    { token:"0x55d398326f99059fF775485246999027B3197955", spender:"0xba12222222228d8ba445958a75a0704d566bf2c8", allowance:"50000000000000000000000", symbol:"USDT", risk:"low",    verified:true,  decimals:18 },
    { token:"0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d", spender:"0xFD14567eaf9ba941cB8c8a94eEC14831ca7fD1b4", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"USDC", risk:"medium", verified:null,  decimals:18 }
  ];
}

// â”€â”€ UI EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPassportMsg(msg) {
  const el = document.getElementById("passportShared");
  if (!el) return;
  el.textContent = msg; el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 5000);
}

function startScan() {
  let wallet = document.getElementById("walletInput").value.trim();
  const net  = document.getElementById("netSelect").value;
  const isDemo = !wallet || !fwIsAddr(wallet);
  if (!wallet) wallet = DEMO_WALLET;
  if (!fwIsAddr(wallet)) { alert("Please enter a valid wallet address (0x...)"); return; }
  runLoadSequence(wallet, net, isDemo);
}

function resetLoadSteps() {
  ["step1","step2","step3","step4"].forEach(s => {
    const el = document.getElementById(s);
    el?.classList.remove("active","done");
    const icon = el?.querySelector(".step-icon");
    if (icon) icon.textContent = "âŸ³";
  });
  const fill = document.getElementById("loadBarFill");
  if (fill) fill.style.width = "0%";
}

// Button bindings
document.getElementById("btnFix1").addEventListener("click", () => applyFix(0));
document.getElementById("btnFix2").addEventListener("click", () => applyFix(1));
document.getElementById("btnFix3").addEventListener("click", () => applyFix(2));

document.getElementById("btnShareX").addEventListener("click", () => {
  if (fwAccessTier !== "full") { requestFullAccess(); return; }
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(getPassportText())}`, "_blank");
});

document.getElementById("btnCopyPassport").addEventListener("click", () => {
  if (fwAccessTier !== "full") { requestFullAccess(); return; }
  navigator.clipboard.writeText(getPassportText())
    .then(() => showPassportMsg("âœ… Passport text copied!"))
    .catch(() => showPassportMsg("Copy failed â€” try manually."));
});

document.getElementById("btnCopyLink").addEventListener("click", () => {
  const url = `${location.origin}/firewall?wallet=${fwWallet}&net=${fwNet}`;
  navigator.clipboard.writeText(url)
    .then(() => showPassportMsg("âœ… Share link copied!"))
    .catch(() => showPassportMsg("Copy failed."));
});

document.getElementById("btnRescan").addEventListener("click", () => {
  document.getElementById("dashboard").style.display = "none";
  resetLoadSteps();
  runLoadSequence(fwWallet, fwNet, !fwWallet || fwWallet === DEMO_WALLET);
});

document.getElementById("btnNewScan").addEventListener("click", () => {
  document.getElementById("dashboard").style.display = "none";
  const hero = document.getElementById("heroSection");
  hero.style.display = "block"; hero.style.opacity = "1"; hero.style.transform = "none";
  document.getElementById("walletInput").value = "";
  document.getElementById("walletInput").focus();
  resetLoadSteps();
  fixDone = [false, false, false];
  // hide gate again until next scan
  const gate = document.getElementById("accessGateOverlay");
  if (gate) gate.style.display = "none";
});

document.getElementById("btnRunFirewall").addEventListener("click", startScan);
document.getElementById("walletInput").addEventListener("keydown", e => { if (e.key === "Enter") startScan(); });

document.getElementById("demoHint").addEventListener("click", () => {
  document.getElementById("walletInput").value = DEMO_WALLET;
  document.getElementById("netSelect").value = "bsc";
  runLoadSequence(DEMO_WALLET, "bsc", true);
});

// Top bar access button
document.getElementById("btnTopAccess")?.addEventListener("click", () => window.requestFullAccess());
document.getElementById("btnCheckAccess")?.addEventListener("click", () => window.requestFullAccess());

// PASS popup
document.getElementById("btnBuyPass")?.addEventListener("click", openPassPopup);
// closePassPopup, passPopup click, btnCopyPassAddr, btnGetCycx handled in footer script

// Auto-run from URL params
(function checkAutoRun() {
  const p = new URLSearchParams(location.search);
  const w = p.get("wallet");
  const n = p.get("net");
  if (w && fwIsAddr(w)) {
    document.getElementById("walletInput").value = w;
    if (n) document.getElementById("netSelect").value = n;
    startScan();
  }
})();

// Expose for onclick handlers
window.requestFullAccess = requestFullAccess;
window.revokeSpender     = revokeSpender;
window.applyRule         = applyRule;
window.applyFix          = applyFix;
</script>
<!-- â”€â”€ PASS PURCHASE MODAL (fixed, centered, outside page flow) â”€â”€ -->
<div id="passPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);align-items:center;justify-content:center">
  <div style="
    background:linear-gradient(135deg,rgba(12,14,28,.98),rgba(18,10,40,.98));
    border:1px solid rgba(0,229,255,.3);border-radius:24px;padding:32px;
    max-width:440px;width:calc(100% - 32px);position:relative;max-height:90vh;overflow-y:auto;
    box-shadow:0 24px 80px rgba(0,0,0,.8),0 0 50px rgba(0,229,255,.12);
    animation:dashIn .3s ease-out
  ">
    <button id="closePassPopup" style="position:absolute;top:14px;right:16px;background:none;border:none;color:rgba(244,246,255,.55);font-size:22px;cursor:pointer;line-height:1;z-index:1" aria-label="Close">âœ•</button>

    <div style="font-size:11px;letter-spacing:.2em;text-transform:uppercase;color:var(--cyan);margin-bottom:10px;font-weight:800">ğŸ« CycleX Access Pass</div>
    <div style="font-size:21px;font-weight:950;margin-bottom:8px;line-height:1.25">Unlock firewall tools<br>in seconds.</div>
    <div style="font-size:13px;color:var(--muted);line-height:1.75;margin-bottom:20px">
      Your access pass is <strong style="color:var(--cyan)">non-tradable (soulbound)</strong>. Later you can convert it to CYCX when the public sale begins.
    </div>

    <!-- What's included -->
    <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.09);border-radius:14px;padding:14px;margin-bottom:20px">
      <div style="font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">What's included</div>
      <div style="display:flex;flex-direction:column;gap:7px">
        <div style="font-size:12px;display:flex;align-items:center;gap:8px"><span style="color:var(--green)">âœ“</span> Firewall Fix Mode + real on-chain revoke</div>
        <div style="font-size:12px;display:flex;align-items:center;gap:8px"><span style="color:var(--green)">âœ“</span> Full Blast Radius breakdown</div>
        <div style="font-size:12px;display:flex;align-items:center;gap:8px"><span style="color:var(--green)">âœ“</span> Wallet Passport (verified, no watermark)</div>
        <div style="font-size:12px;display:flex;align-items:center;gap:8px"><span style="color:var(--green)">âœ“</span> DNA Scanner + export</div>
        <div style="font-size:12px;display:flex;align-items:center;gap:8px"><span style="color:var(--green)">âœ“</span> All future premium features</div>
      </div>
    </div>

    <!-- Price -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding:12px 16px;border-radius:14px;background:rgba(0,229,255,.06);border:1px solid rgba(0,229,255,.18)">
      <span style="font-size:13px;color:var(--muted)">Price</span>
      <span style="font-size:18px;font-weight:950;color:var(--cyan)">$9 <span style="font-size:12px;font-weight:600;opacity:.75">USDT or ~BNB equiv</span></span>
    </div>

    <!-- Payment buttons -->
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
      <button id="passBtnBnb" style="
        display:flex;align-items:center;justify-content:center;gap:10px;
        padding:14px;border-radius:999px;
        background:linear-gradient(135deg,#f3a01a,#f0c040);color:#0a0500;
        font-weight:900;font-size:13px;letter-spacing:.06em;text-transform:uppercase;
        border:none;cursor:pointer;transition:transform .2s,box-shadow .2s;
        box-shadow:0 12px 40px rgba(243,160,26,.35)
      ">
        ğŸŸ¡ Pay with BNB
      </button>
      <button id="passBtnUsdt" style="
        display:flex;align-items:center;justify-content:center;gap:10px;
        padding:14px;border-radius:999px;
        background:rgba(255,255,255,.06);color:var(--text);
        font-weight:900;font-size:13px;letter-spacing:.06em;text-transform:uppercase;
        border:1px solid rgba(255,255,255,.18);cursor:pointer;transition:all .2s ease
      ">
        ğŸ’² Pay with USDT
      </button>
    </div>

    <!-- Status -->
    <div id="passPayStatus" style="font-size:12px;color:var(--muted);text-align:center;min-height:18px;margin-bottom:10px;line-height:1.5"></div>

    <!-- Contract info -->
    <div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:10px 14px">
      <span style="font-size:10px;color:var(--muted);white-space:nowrap">PASS Contract (BSC):</span>
      <span style="font-family:var(--mono);font-size:10px;color:var(--cyan);flex:1;word-break:break-all">0x718bc4E915fF66249C1eB86Eb566Ce4fefCA801e</span>
      <button id="btnCopyPassAddr" style="background:none;border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:11px;cursor:pointer;flex:0 0 auto;padding:3px 8px;border-radius:6px">Copy</button>
    </div>
    <div style="font-size:10px;color:var(--muted);text-align:center;margin-top:10px;opacity:.6">BSC network only Â· Verify contract on BscScan before buying</div>
  </div>
</div>

<script>
// â”€â”€ PASS PAYMENT CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PASS_SALE_RECEIVER = "0x1993b2D333713cdA3C6166bb02F71E304A14471f";
const PASS_USDT_BSC      = "0x55d398326f99059fF775485246999027B3197955";
const PASS_USD_PRICE     = 9;
const PASS_CONTRACT_ADDR = "0x718bc4E915fF66249C1eB86Eb566Ce4fefCA801e";
const BSC_CHAIN_ID       = "0x38";
const BSC_READ_RPCS = [
  "https://bsc-rpc.publicnode.com",
  "https://bsc-dataseed.binance.org/",
  "https://bsc-dataseed1.binance.org/",
  "https://bsc-dataseed2.binance.org/",
  "https://rpc.ankr.com/bsc",
  "https://bsc-dataseed1.defibit.io/",
  "https://bsc-dataseed1.ninicoin.io/",
  "https://1rpc.io/bnb"
];

// â”€â”€ PASS POPUP HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPassPopup()  {
  const el = document.getElementById("passPopup");
  if (el) { el.style.display = "flex"; setPassStatus(""); }
}
function closePassPopup() {
  const el = document.getElementById("passPopup");
  if (el) el.style.display = "none";
}
function setPassStatus(msg, color) {
  const el = document.getElementById("passPayStatus");
  if (!el) return;
  el.textContent = msg || "";
  el.style.color = color || "var(--muted)";
}

window.openPassPopup  = openPassPopup;
window.closePassPopup = closePassPopup;

// â”€â”€ RPC JSON-RPC HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwRpcRequest(url, method, params, timeoutMs = 8000) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ jsonrpc:"2.0", id:1, method, params }),
      signal: ctrl.signal
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message || "RPC error");
    return data.result;
  } finally {
    clearTimeout(timer);
  }
}

// â”€â”€ BSC PROVIDER WITH FALLBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwGetBscProvider() {
  const Eth = window.E || window.ethers;
  if (!Eth) return null;
  for (const rpc of BSC_READ_RPCS) {
    try {
      const p = new Eth.JsonRpcProvider(rpc);
      await Promise.race([
        p.getBlockNumber(),
        new Promise((_, r) => setTimeout(() => r(new Error("timeout")), 6000))
      ]);
      return p;
    } catch { /* try next */ }
  }
  return null;
}

// Override checkCycxPass to use local BSC provider
async function checkCycxPassRobust() {
  const Eth = window.E || window.ethers;
  if (!Eth?.Contract) return { eligible: false, reason: "ethers_missing" };
  const addr = window.wallet?.address;
  if (!addr) return { eligible: false, reason: "no_wallet" };

  const provider = await fwGetBscProvider();
  if (!provider) return { eligible: false, reason: "rpc_failed" };

  try {
    const GATE_ABI_MIN = [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ];
    const cycxC = new Eth.Contract(CYCX_BSC, GATE_ABI_MIN, provider);
    const passC = new Eth.Contract(PASS_BSC, GATE_ABI_MIN, provider);

    let cycxDec = 18n;
    try { cycxDec = BigInt(await cycxC.decimals()); } catch {}

    const [cycxBal, passBal] = await Promise.all([
      cycxC.balanceOf(addr).catch(() => 0n),
      passC.balanceOf(addr).catch(() => 0n)
    ]);

    const cycxMin = CYCX_MIN * (10n ** cycxDec);
    const eligible = BigInt(passBal) >= PASS_MIN || BigInt(cycxBal) >= cycxMin;
    return {
      ok: true,
      eligible,
      hasPass:  BigInt(passBal) >= PASS_MIN,
      hasCycx:  BigInt(cycxBal) >= cycxMin
    };
  } catch (e) {
    return { eligible: false, reason: e.message };
  }
}

// â”€â”€ BNB PRICE QUOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwQuoteBnbWei(usdPrice) {
  // Try to get BNB/USD from BSC oracle (WBNB/USDT PancakeSwap pair)
  const WBNB  = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
  const USDT  = "0x55d398326f99059fF775485246999027B3197955";
  const PAIR_FACTORY = "0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73";

  const Eth = window.E || window.ethers;
  if (!Eth) throw new Error("ethers not loaded");

  const provider = await fwGetBscProvider();
  if (!provider) throw new Error("No BSC RPC");

  const factoryAbi = ["function getPair(address,address) view returns (address)"];
  const pairAbi    = [
    "function token0() view returns (address)",
    "function getReserves() view returns (uint112,uint112,uint32)"
  ];

  const factory = new Eth.Contract(PAIR_FACTORY, factoryAbi, provider);
  const pairAddr = await factory.getPair(WBNB, USDT);
  const pair = new Eth.Contract(pairAddr, pairAbi, provider);
  const [t0, [r0, r1]] = await Promise.all([pair.token0(), pair.getReserves()]);

  const isWbnbT0 = t0.toLowerCase() === WBNB.toLowerCase();
  const wbnbR = isWbnbT0 ? BigInt(r0) : BigInt(r1);
  const usdtR = isWbnbT0 ? BigInt(r1) : BigInt(r0);

  // USDT has 18 decimals on BSC, WBNB 18 decimals
  // bnbPriceUSD = usdtR / wbnbR
  // weiNeeded = usdPrice / bnbPriceUSD * 1e18
  const weiNeeded = (BigInt(usdPrice) * wbnbR * 10n**18n) / (usdtR);
  // Add 2% slippage
  return (weiNeeded * 102n) / 100n;
}

// â”€â”€ ENSURE BSC CHAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwEnsureBsc(provider) {
  try {
    const chainId = await provider.request({ method: "eth_chainId" });
    if (chainId === BSC_CHAIN_ID) return true;
    await provider.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: BSC_CHAIN_ID }]
    });
    return true;
  } catch (err) {
    const code = Number(err?.code);
    if (code === 4902) {
      await provider.request({
        method: "wallet_addEthereumChain",
        params: [{ chainId: BSC_CHAIN_ID, chainName: "BNB Smart Chain",
          nativeCurrency: { name:"BNB", symbol:"BNB", decimals:18 },
          rpcUrls: ["https://bsc-dataseed.binance.org/"],
          blockExplorerUrls: ["https://bscscan.com/"] }]
      });
      return true;
    }
    return false;
  }
}

// â”€â”€ WAIT FOR TX CONFIRM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwWaitTxConfirm(rawProvider, txHash, maxMs = 120000) {
  const start = Date.now();
  while (Date.now() - start < maxMs) {
    try {
      const r = await rawProvider.request({
        method: "eth_getTransactionReceipt",
        params: [txHash]
      });
      if (r?.status != null) {
        return r.status === "0x1" || r.status === 1 || r.status === true;
      }
    } catch {}
    await new Promise(res => setTimeout(res, 2000));
  }
  return false;
}

// â”€â”€ PASS BUY FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _passBuyRunning = false;

async function passBuyFlow(kind) {
  if (_passBuyRunning) return;
  _passBuyRunning = true;

  const bnbBtn  = document.getElementById("passBtnBnb");
  const usdtBtn = document.getElementById("passBtnUsdt");
  if (bnbBtn)  bnbBtn.disabled  = true;
  if (usdtBtn) usdtBtn.disabled = true;

  try {
    setPassStatus("Loading wallet moduleâ€¦", "#a87eff");

    // Connect wallet via AppKit
    let appkit;
    try { appkit = await fwLoadAppKit(); }
    catch { setPassStatus("Could not load wallet module. Check connection.", "#ff7a8a"); return; }

    if (!window.wallet?.address) {
      setPassStatus("Opening wallet connectâ€¦", "#a87eff");
      try {
        await appkit.open();
        const addr = await fwWaitForWallet(20000);
        if (!addr) { setPassStatus("Wallet not connected. Try again.", "#ff9a6b"); return; }
      } catch { setPassStatus("Connect cancelled.", "#ff9a6b"); return; }
    }

    // Get raw provider
    const rawProvider =
      window.wallet?.providerRaw?.request  && window.wallet.providerRaw ||
      appkit.getWalletProvider?.()?.request && appkit.getWalletProvider() ||
      window.ethereum;

    if (!rawProvider?.request) {
      setPassStatus("Provider not available. Try reconnecting wallet.", "#ff7a8a");
      return;
    }

    const from = window.wallet.address;
    setPassStatus("Switching to BSCâ€¦", "#a87eff");
    const chainOk = await fwEnsureBsc(rawProvider);
    if (!chainOk) { setPassStatus("Please switch to BNB Chain.", "#ff9a6b"); return; }

    // â”€â”€ BNB payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (kind === "bnb") {
      setPassStatus("Fetching BNB priceâ€¦", "#a87eff");
      let valueWei;
      try {
        valueWei = await fwQuoteBnbWei(PASS_USD_PRICE);
      } catch {
        // Fallback: assume $300/BNB
        valueWei = (BigInt(PASS_USD_PRICE) * 10n**18n) / 300n;
        valueWei = (valueWei * 105n) / 100n;
      }

      const BUY_BNB_SELECTOR = "0x20f1fc61";
      setPassStatus("Confirm in your walletâ€¦", "#a87eff");
      let txHash;
      try {
        txHash = await rawProvider.request({
          method: "eth_sendTransaction",
          params: [{ from, to: PASS_SALE_RECEIVER, value: "0x" + valueWei.toString(16), data: BUY_BNB_SELECTOR }]
        });
      } catch (e) {
        const msg = String(e?.message || "");
        if (/reject|cancel|denied|4001/i.test(msg)) {
          setPassStatus("Transaction cancelled.", "#ff9a6b");
        } else {
          setPassStatus("Transaction failed: " + msg.slice(0, 80), "#ff7a8a");
        }
        return;
      }

      setPassStatus("â³ Waiting for confirmationâ€¦", "#ffd166");
      const ok = await fwWaitTxConfirm(rawProvider, txHash);
      if (ok) {
        setPassStatus("âœ… Purchase confirmed! Reloading accessâ€¦", "#5dffb2");
        setTimeout(() => { closePassPopup(); requestFullAccess(); }, 1500);
      } else {
        setPassStatus("Pending on-chain. Close and try 'Check Access' in a moment.", "#ffd166");
      }
      return;
    }

    // â”€â”€ USDT payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (kind === "usdt") {
      const Eth = window.E || window.ethers;
      if (!Eth) { setPassStatus("Ethers.js not loaded.", "#ff7a8a"); return; }

      const web3Provider = new Eth.BrowserProvider(rawProvider);
      const signer = await web3Provider.getSigner();

      const usdtAbi = [
        "function decimals() view returns (uint8)",
        "function approve(address,uint256) returns (bool)"
      ];
      const saleAbi = ["function buyWithUSDT() external"];

      const usdtC = new Eth.Contract(PASS_USDT_BSC, usdtAbi, signer);
      const saleC = new Eth.Contract(PASS_SALE_RECEIVER, saleAbi, signer);

      const dec = Number(await usdtC.decimals());
      const amount = Eth.parseUnits(String(PASS_USD_PRICE), dec);

      setPassStatus("Step 1/2: Approve USDT in walletâ€¦", "#a87eff");
      try {
        const tx1 = await usdtC.approve(PASS_SALE_RECEIVER, amount);
        await tx1.wait();
      } catch (e) {
        setPassStatus("USDT approval cancelled or failed.", "#ff9a6b");
        return;
      }

      setPassStatus("Step 2/2: Confirm purchaseâ€¦", "#a87eff");
      try {
        const tx2 = await saleC.buyWithUSDT();
        setPassStatus("â³ Waiting for confirmationâ€¦", "#ffd166");
        const receipt = await tx2.wait();
        if (receipt?.status === 1) {
          setPassStatus("âœ… Purchase confirmed! Reloading accessâ€¦", "#5dffb2");
          setTimeout(() => { closePassPopup(); requestFullAccess(); }, 1500);
        } else {
          setPassStatus("Tx failed on-chain. Try again.", "#ff7a8a");
        }
      } catch (e) {
        setPassStatus("Purchase cancelled or failed.", "#ff9a6b");
      }
      return;
    }

  } catch (e) {
    setPassStatus("Error: " + String(e?.message || e).slice(0, 100), "#ff7a8a");
  } finally {
    if (bnbBtn)  bnbBtn.disabled  = false;
    if (usdtBtn) usdtBtn.disabled = false;
    _passBuyRunning = false;
  }
}

// â”€â”€ BIND MODAL EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("closePassPopup")?.addEventListener("click", closePassPopup);
document.getElementById("passPopup")?.addEventListener("click", e => {
  if (e.target.id === "passPopup") closePassPopup();
});
document.getElementById("passBtnBnb")?.addEventListener("click", () => passBuyFlow("bnb"));
document.getElementById("passBtnUsdt")?.addEventListener("click", () => passBuyFlow("usdt"));
document.getElementById("btnCopyPassAddr")?.addEventListener("click", () => {
  navigator.clipboard.writeText(PASS_CONTRACT_ADDR).then(() => {
    const btn = document.getElementById("btnCopyPassAddr");
    if (btn) { const prev = btn.textContent; btn.textContent = "Copied!"; setTimeout(() => btn.textContent = prev, 1500); }
  }).catch(() => {});
});

// â”€â”€ PATCH requestFullAccess to use robust RPC check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.requestFullAccess = async function() {
  if (fwAccessTier === "full") return;
  setGateStatus("Loading wallet moduleâ€¦", "#a87eff");

  let appkit;
  try { appkit = await fwLoadAppKit(); }
  catch { setGateStatus("Could not load wallet module. Check connection.", "#ff7a8a"); return; }

  if (!window.wallet?.address) {
    try {
      setGateStatus("Opening wallet connectâ€¦", "#a87eff");
      await appkit.open();
      const addr = await fwWaitForWallet(20000);
      if (!addr) { setGateStatus("Wallet not connected. Try again.", "#ff9a6b"); return; }
    } catch { setGateStatus("Connect cancelled.", "#ff9a6b"); return; }
  }

  setGateStatus("Checking PASS on BSCâ€¦", "#a87eff");
  const res = await checkCycxPassRobust();
  const eligible = res.eligible === true || (res.ok && res.eligible);

  if (eligible) {
    const why = res.hasPass ? "PASS âœ“" : "CYCX âœ“";
    setGateStatus(`Eligible (${why}) â€” unlocking!`, "#5dffb2");
    await new Promise(r => setTimeout(r, 700));
    unlockFull();
    if (fwScanData) renderDashboard(fwWallet, fwScanData, "full");
    return;
  }

  const msg =
    res.reason === "no_wallet"      ? "Wallet not detected." :
    res.reason === "ethers_missing" ? "Ethers.js not loaded. Refresh and try again." :
    res.reason === "rpc_failed"     ? "BSC RPC unavailable. Try again in a moment." :
    "Not eligible. You need 1 PASS token on BSC.";
  setGateStatus(msg, "#ff7a8a");
};

// Remove old CYCX disabled tooltip listener if any
// (btnGetCycx was removed from HTML)
</script>
</body>
</html>
