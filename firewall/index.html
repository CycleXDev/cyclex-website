
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CycleX Firewall â€” Wallet Protection</title>
  <meta name="description" content="Turn any wallet into a protected wallet in 60 seconds. Scan approvals, see your Blast Radius, get a Fix Plan." />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="theme-color" content="#05060a">

  <!-- Ethers (same version as main site) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js" defer></script>
<style>
  :root {
    --bg:#05060a;
    --cyan:#00e5ff;
    --green:#5dffb2;
    --purple:#7c5cff;
    --red:#ff4757;
    --yellow:#ffd166;
    --text:rgba(244,246,255,1);
    --muted:rgba(244,246,255,.65);
    --card:rgba(255,255,255,.055);
    --border:rgba(255,255,255,.12);
    --radius:22px;
    --radius-sm:14px;
    --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    --sans:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{min-height:100%;overflow-x:hidden}
  html{font-size:16px;background:#05060a!important}
  body{
    font-family:var(--sans);
    background:
      radial-gradient(1200px 720px at 14% 10%,rgba(124,92,255,.20),transparent 58%),
      radial-gradient(1200px 720px at 86% 12%,rgba(0,229,255,.18),transparent 56%),
      radial-gradient(980px 680px at 55% 120%,rgba(0,58,76,.42),transparent 62%),
      linear-gradient(160deg,#05060a,#0b0a18,#021b24)!important;
    background-repeat:no-repeat!important;
    background-attachment:fixed!important;
    background-size:cover!important;
    color:var(--text);
    min-height:100vh;
    -webkit-font-smoothing:antialiased;
  }
  body::before{
    content:"";position:fixed;inset:0;pointer-events:none;
    background:
      radial-gradient(740px 640px at 20% 14%,rgba(0,229,255,.10),transparent 60%),
      radial-gradient(940px 780px at 78% 18%,rgba(124,92,255,.09),transparent 62%),
      radial-gradient(820px 700px at 52% 78%,rgba(93,255,178,.06),transparent 64%);
    background-size:auto,auto,auto;
    background-repeat:no-repeat,no-repeat,no-repeat;
    opacity:.10;z-index:0
    /* feTurbulence SVG removed â€” caused Chrome GPU process crash */
  }
  a{color:inherit;text-decoration:none}

  /* â”€â”€ PAGE SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page-shell{width:100%;max-width:1160px;margin:0 auto;padding:32px 20px 80px;position:relative;z-index:1}

  /* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .top-bar{
    position:sticky;top:14px;z-index:999;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:12px 16px;margin:0 auto 36px;
    width:min(1160px,calc(100% - 24px));
    border-radius:999px;
    background:rgba(10,12,22,.55);
    border:1px solid rgba(255,255,255,.14);
    backdrop-filter:blur(18px) saturate(1.12);
    -webkit-backdrop-filter:blur(18px) saturate(1.12);
    box-shadow:0 14px 50px rgba(0,0,0,.50),inset 0 1px 0 rgba(255,255,255,.06);
  }
  .top-bar::before{
    content:"";position:absolute;inset:0;border-radius:999px;padding:1px;
    background:linear-gradient(120deg,rgba(0,229,255,.22),rgba(124,92,255,.16),rgba(255,255,255,.10));
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;opacity:.55
  }
  .brand{display:flex;align-items:center;gap:10px;position:relative;z-index:1}
  .brand-logo{width:42px;height:42px;border-radius:14px;object-fit:contain;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);box-shadow:0 12px 32px rgba(0,0,0,.7);flex:0 0 auto}
  .brand-text{display:flex;flex-direction:column;gap:2px}
  .brand-title{font-weight:950;letter-spacing:.10em;font-size:13px;text-transform:uppercase;white-space:nowrap}
  .brand-sub{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:rgba(244,246,255,.56);white-space:nowrap}
  .top-right{display:flex;align-items:center;gap:10px;position:relative;z-index:1}
  .lang-switch{display:inline-flex;align-items:center;padding:4px;border-radius:999px;
    background:rgba(255,255,255,.045);border:1px solid rgba(255,255,255,.12);
    backdrop-filter:blur(12px);gap:2px;flex:0 0 auto}
  .lang-btn{border:none;background:transparent;color:rgba(244,246,255,.56);
    font-size:11px;padding:5px 9px;border-radius:999px;cursor:pointer;
    transition:background .18s,color .18s,transform .18s;white-space:nowrap}
  .lang-btn:hover{transform:translateY(-1px)}
  .lang-btn.active{background:rgba(0,229,255,.14);color:rgba(0,229,255,.95)}
  body.lang-rtl{direction:rtl}
  body.lang-switching{animation:langFade .24s ease}
  @keyframes langFade{from{opacity:.5;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
  .back-link{
    font-size:11px;letter-spacing:.16em;text-transform:uppercase;
    color:rgba(244,246,255,.72);padding:8px 14px;border-radius:999px;
    border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);
    transition:all .18s ease;cursor:pointer
  }
  .back-link:hover{background:rgba(255,255,255,.08);color:var(--text)}
  .firewall-badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 12px;border-radius:999px;
    border:1px solid rgba(255,80,80,.35);background:rgba(255,80,80,.10);
    font-size:11px;font-weight:800;letter-spacing:.10em;text-transform:uppercase;
    color:#ff6b6b
  }
  .firewall-badge .dot{width:7px;height:7px;border-radius:50%;background:#ff4757;animation:pulse 1.8s infinite}
  @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.85)}}

  /* â”€â”€ HERO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hero{position:relative;max-width:1100px;margin:10px auto 32px;padding:10px 0 24px;text-align:center;z-index:1}
  .hero-kicker{
    display:inline-flex;align-items:center;gap:8px;
    font-size:11px;letter-spacing:.24em;text-transform:uppercase;
    color:rgba(255,100,100,.92);margin-bottom:18px;
    padding:6px 14px;border-radius:999px;border:1px solid rgba(255,80,80,.22);background:rgba(255,80,80,.08)
  }
  .hero-title{
    font-size:clamp(42px,5vw,80px);line-height:1.10;font-weight:950;letter-spacing:-.04em;
    margin-bottom:14px;
    background:linear-gradient(110deg,rgba(244,246,255,1) 0%,rgba(255,150,100,.95) 35%,rgba(255,80,80,.90) 65%,rgba(124,92,255,.88) 100%);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    background-size:200% 200%;animation:titleSheen 10s ease-in-out infinite
  }
  @keyframes titleSheen{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
  @media (prefers-reduced-motion: reduce) {
    .hero-title, .firewall-badge .dot, .drain-fast, .load-step.active .step-icon { animation: none !important; }
  }
  .hero-sub{max-width:68ch;margin:0 auto 28px;font-size:16px;line-height:1.75;color:var(--muted)}

  /* â”€â”€ WALLET INPUT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .scan-bar{
    display:flex;align-items:center;gap:10px;max-width:760px;margin:0 auto;
    background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.16);
    border-radius:999px;padding:7px 7px 7px 22px;
    box-shadow:0 18px 60px rgba(0,0,0,.50),inset 0 1px 0 rgba(255,255,255,.06);
    transition:border-color .22s ease,box-shadow .22s ease
  }
  .scan-bar:focus-within{border-color:rgba(255,100,80,.45);box-shadow:0 18px 60px rgba(0,0,0,.50),0 0 0 3px rgba(255,80,80,.10)}
  .scan-bar input{
    flex:1;background:transparent;border:none;outline:none;
    font-family:var(--mono);font-size:14px;color:var(--text);
  }
  .scan-bar input::placeholder{color:var(--muted)}
  .scan-net{
    background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);
    color:var(--text);font-size:12px;padding:8px 12px;border-radius:999px;outline:none;cursor:pointer
  }
  .btn-scan{
    background:linear-gradient(135deg,#ff4757,#ff6b6b);color:#fff;
    border:none;border-radius:999px;padding:12px 22px;
    font-size:13px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
    cursor:pointer;white-space:nowrap;transition:transform .2s ease,box-shadow .2s ease;
    box-shadow:0 14px 42px rgba(255,71,87,.38)
  }
  .btn-scan:hover{transform:translateY(-1px);box-shadow:0 20px 60px rgba(255,71,87,.52)}
  .btn-scan:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .hero-micro{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px;margin:14px 0 0;font-size:12px;color:var(--muted)}
  .micro-dot{opacity:.38;margin:0 2px}
  .demo-hint{
    margin-top:12px;font-size:12px;color:rgba(255,160,100,.75);cursor:pointer;
    text-decoration:underline;text-underline-offset:3px;opacity:.85;transition:opacity .2s
  }
  .demo-hint:hover{opacity:1}

  /* â”€â”€ LOADING BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #loadWrap{display:none;max-width:760px;margin:28px auto 0;text-align:center}
  .load-label{font-size:13px;color:var(--muted);margin-bottom:12px;letter-spacing:.04em}
  .load-steps{display:flex;flex-direction:column;gap:8px;max-width:420px;margin:0 auto 16px}
  .load-step{
    display:flex;align-items:center;gap:12px;padding:10px 14px;
    border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);
    font-size:13px;color:var(--muted);opacity:.45;transition:opacity .3s,border-color .3s
  }
  .load-step.active{opacity:1;border-color:rgba(255,100,80,.35);color:var(--text)}
  .load-step.done{opacity:.8;color:var(--green)}
  .load-step .step-icon{width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:10px;flex:0 0 auto}
  .load-step.active .step-icon{border-color:rgba(255,100,80,.6);animation:spin .8s linear infinite}
  .load-step.done .step-icon{border-color:var(--green);background:rgba(93,255,178,.12)}
  @keyframes spin{to{transform:rotate(360deg)}}
  .load-bar{height:3px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;max-width:420px;margin:0 auto}
  .load-bar-fill{height:100%;background:linear-gradient(90deg,#ff4757,#ff9a6b,#ffcc5c);border-radius:999px;width:0%;transition:width .4s ease}

  /* â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #dashboard{display:none;animation:dashIn .5s ease-out forwards}
  @keyframes dashIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

  .section-title{
    font-size:11px;letter-spacing:.20em;text-transform:uppercase;
    color:var(--muted);margin-bottom:14px;margin-top:28px;
    display:flex;align-items:center;gap:10px
  }
  #dashboard > .section-title:first-of-type,
  #dashboard > *:first-child > .section-title{margin-top:0}
  .section-title::after{content:"";flex:1;height:1px;background:rgba(255,255,255,.08)}

  /* Score bar (top 3) */
  .top3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px}
  .score-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:22px 20px;box-shadow:0 20px 55px rgba(0,0,0,.55),inset 0 1px 0 rgba(255,255,255,.05);
    position:relative;overflow:hidden;transition:transform .18s ease,border-color .18s ease
  }
  .score-card:hover{transform:translateY(-2px)}
  .score-card::before{content:"";position:absolute;inset:0;border-radius:var(--radius);opacity:.12;pointer-events:none}
  .score-card.card-score::before{background:radial-gradient(circle at 50% -20%,rgba(255,71,87,.6),transparent 60%)}
  .score-card.card-blast::before{background:radial-gradient(circle at 50% -20%,rgba(255,193,7,.5),transparent 60%)}
  .score-card.card-drain::before{background:radial-gradient(circle at 50% -20%,rgba(0,229,255,.4),transparent 60%)}
  .sc-kicker{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:10px}
  .sc-big{font-size:clamp(38px,4vw,56px);font-weight:950;letter-spacing:-.02em;line-height:1}
  .sc-unit{font-size:16px;font-weight:700;opacity:.7;margin-left:4px}
  .sc-label{margin-top:10px;font-size:13px;display:flex;align-items:center;gap:8px}
  .sc-dot{width:10px;height:10px;border-radius:50%;flex:0 0 auto}
  .gauge-wrap{position:relative;width:90px;height:90px;margin:0 auto 6px}
  .gauge-svg{transform:rotate(-90deg)}
  .gauge-track{fill:none;stroke:rgba(255,255,255,.08);stroke-width:8}
  .gauge-fill{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.2s cubic-bezier(.22,1,.36,1)}
  .gauge-num{
    position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    font-size:22px;font-weight:950;letter-spacing:-.02em
  }
  .gauge-num small{font-size:9px;font-weight:700;opacity:.6;letter-spacing:.14em;text-transform:uppercase;margin-top:1px}
  .blast-amount{font-size:clamp(30px,3.5vw,46px);font-weight:950;letter-spacing:-.02em;color:#ffd166}
  .drain-time{font-size:clamp(30px,3.5vw,46px);font-weight:950;letter-spacing:-.02em;color:var(--red)}
  .drain-fast{animation:drainPulse 2s ease-in-out infinite}
  @keyframes drainPulse{0%,100%{opacity:1}50%{opacity:.7}}
  .card-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:14px}
  .meta-chip{
    display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;
    font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);
    color:var(--muted)
  }
  .meta-chip.warn{border-color:rgba(255,193,7,.3);background:rgba(255,193,7,.08);color:#ffd166}
  .meta-chip.bad{border-color:rgba(255,71,87,.3);background:rgba(255,71,87,.09);color:#ff6b6b}
  .meta-chip.ok{border-color:rgba(93,255,178,.3);background:rgba(93,255,178,.09);color:var(--green)}

  /* â”€â”€ MAIN GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main-grid{display:grid;grid-template-columns:1.3fr 1fr;gap:16px;margin-bottom:16px}

  /* Exposure Map */
  .exp-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:20px;box-shadow:0 20px 55px rgba(0,0,0,.55)
  }
  .exp-title{font-size:14px;font-weight:800;margin-bottom:4px}
  .exp-sub{font-size:12px;color:var(--muted);margin-bottom:16px}
  #exposureMap{width:100%;height:280px;background:rgba(0,0,0,.2);border-radius:16px;border:1px solid rgba(255,255,255,.06);overflow:hidden}

  /* Top Threats */
  .threats-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:20px;box-shadow:0 20px 55px rgba(0,0,0,.55)
  }
  .threat-item{
    padding:13px 14px;border-radius:12px;margin-bottom:8px;
    background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.07);
    display:flex;flex-direction:column;gap:7px;transition:border-color .2s
  }
  .threat-item:last-child{margin-bottom:0}
  .threat-item.t-critical{background:rgba(255,71,87,.06);border-color:rgba(255,71,87,.2)}
  .threat-item.t-high{background:rgba(255,150,50,.04);border-color:rgba(255,150,50,.18)}
  .threat-item.t-info{background:rgba(255,255,255,.015);border-color:rgba(255,255,255,.06)}

  /* âœ… FIX: ×”×™×” ××¦×œ×š ×©×‘×•×¨ ×‘×ª×•×š .t-info */
  .threat-item.locked-card{opacity:.35;pointer-events:none;user-select:none;position:relative}
  .threat-item.locked-card::after{content:'ğŸ”’';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:18px}

  .threat-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
  .threat-name{font-size:12px;font-weight:800;font-family:var(--mono);color:var(--text)}
  .threat-damage{font-size:11px;font-weight:900;color:#ff6b6b;white-space:nowrap}
  .threat-meta{display:flex;flex-wrap:wrap;gap:5px;align-items:center}
  .threat-why{font-size:11px;color:var(--muted);line-height:1.55}
  .threat-drain{
    font-size:10px;padding:3px 9px;border-radius:999px;font-weight:700;display:inline-block
  }
  .threat-drain.bad{background:rgba(255,71,87,.12);color:#ff7a8a;border:1px solid rgba(255,71,87,.25)}
  .threat-drain.warn{background:rgba(255,193,7,.10);color:#ffd166;border:1px solid rgba(255,193,7,.22)}
  .threat-drain.ok{background:rgba(93,255,178,.07);color:#5dffb2;border:1px solid rgba(93,255,178,.18)}
  .threat-info-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .threat-chip{font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,.05);color:var(--muted);font-family:var(--mono)}
  .btn-fix-small{
    padding:5px 12px;border-radius:999px;font-size:11px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;
    border:1px solid rgba(255,193,7,.4);background:rgba(255,193,7,.10);color:#ffd166;
    cursor:pointer;transition:all .18s ease;white-space:nowrap
  }
  .btn-fix-small:hover{background:rgba(255,193,7,.18);border-color:rgba(255,193,7,.6)}
  .btn-fix-small.fixed{border-color:rgba(93,255,178,.4);background:rgba(93,255,178,.10);color:var(--green);cursor:default}

  /* â”€â”€ FIX MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .fix-card{
    background:var(--card);border:1px solid rgba(255,193,7,.22);border-radius:var(--radius);
    padding:22px;box-shadow:0 20px 55px rgba(0,0,0,.55),0 0 0 1px rgba(255,193,7,.10),0 0 28px rgba(255,193,7,.08);
    margin-bottom:16px
  }
  .fix-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px}
  .fix-steps{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .fix-step{
    background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:16px;
    padding:16px 14px;position:relative;overflow:hidden;transition:all .22s ease
  }
  .fix-step.step-done{border-color:rgba(93,255,178,.25);background:rgba(93,255,178,.06)}
  .fix-step.step-done::before{
    content:"âœ“";position:absolute;top:10px;right:12px;font-size:14px;font-weight:900;
    color:var(--green);opacity:.8
  }
  .fix-step-num{
    width:28px;height:28px;border-radius:50%;
    background:linear-gradient(135deg,rgba(255,71,87,.3),rgba(255,150,80,.3));
    border:1px solid rgba(255,100,80,.3);display:flex;align-items:center;justify-content:center;
    font-size:12px;font-weight:900;color:#ff9a6b;margin-bottom:10px
  }
  .fix-step.step-done .fix-step-num{
    background:rgba(93,255,178,.15);border-color:rgba(93,255,178,.3);color:var(--green)
  }
  .fix-step-title{font-size:13px;font-weight:800;margin-bottom:4px}
  .fix-step-desc{font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:10px}
  .btn-action{
    width:100%;padding:9px 12px;border-radius:999px;font-size:11px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
    border:1px solid rgba(255,100,80,.4);background:rgba(255,80,80,.10);color:#ff8080;
    cursor:pointer;transition:all .2s ease
  }
  .btn-action:hover{background:rgba(255,80,80,.18);transform:translateY(-1px)}
  .btn-action:disabled{opacity:.45;cursor:not-allowed;transform:none}
  .btn-action.done{border-color:rgba(93,255,178,.35);background:rgba(93,255,178,.10);color:var(--green);cursor:default}
  .fix-score-gain{
    margin-top:16px;padding:12px 16px;border-radius:12px;
    background:rgba(93,255,178,.06);border:1px solid rgba(93,255,178,.18);
    font-size:13px;color:var(--green);display:flex;align-items:center;gap:10px
  }
  .fix-score-gain strong{font-size:18px;font-weight:950}
    /* â”€â”€ PASSPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .passport-wrap{
    background:var(--card);border:1px solid rgba(0,229,255,.22);border-radius:var(--radius);
    padding:22px;box-shadow:0 20px 55px rgba(0,0,0,.55),0 0 28px rgba(0,229,255,.08);
    margin-bottom:16px
  }
  .passport-inner{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}
  .passport-card-preview{
    background:linear-gradient(135deg,rgba(5,6,10,1),rgba(20,10,38,1));
    border:1px solid rgba(0,229,255,.3);border-radius:18px;padding:20px;
    box-shadow:0 12px 40px rgba(0,0,0,.6),0 0 60px rgba(0,229,255,.08);
    position:relative;overflow:hidden
  }
  .passport-card-preview::before{
    content:"";position:absolute;top:-40px;right:-40px;width:160px;height:160px;
    border-radius:50%;background:radial-gradient(circle,rgba(0,229,255,.12),transparent 70%)
  }
  .pp-logo{font-size:11px;font-weight:900;letter-spacing:.2em;text-transform:uppercase;color:var(--cyan);margin-bottom:14px;display:flex;align-items:center;gap:8px}
  .pp-logo-dot{width:8px;height:8px;border-radius:50%;background:var(--cyan);box-shadow:0 0 10px var(--cyan)}
  .pp-wallet{font-family:var(--mono);font-size:11px;color:var(--muted);margin-bottom:14px;word-break:break-all}
  .pp-score-row{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .pp-score-big{font-size:40px;font-weight:950;letter-spacing:-.03em}
  .pp-score-label{font-size:10px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
  .pp-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
  .pp-stat{
    background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
    border-radius:10px;padding:10px 10px 8px;
    display:flex;flex-direction:column;justify-content:center;min-height:52px
  }
  .pp-stat-val{font-size:15px;font-weight:900;line-height:1.2;word-break:break-word}
  .pp-stat-key{font-size:9px;letter-spacing:.10em;text-transform:uppercase;color:var(--muted);margin-top:3px;line-height:1.2}
  .pp-status{
    display:inline-flex;align-items:center;gap:6px;padding:6px 12px;
    border-radius:999px;font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;
    border:1px solid rgba(255,193,7,.35);background:rgba(255,193,7,.10);color:#ffd166
  }
  .pp-date{font-size:10px;color:var(--muted);margin-top:10px;font-family:var(--mono)}

  .passport-actions{display:flex;flex-direction:column;gap:10px;padding-top:2px}
  .passport-actions h3{font-size:16px;font-weight:800;margin:0 0 2px}
  .passport-actions p{font-size:13px;color:var(--muted);line-height:1.6;margin:0 0 6px}
  .btn-passport{
    padding:12px 18px;border-radius:999px;font-size:13px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;
    cursor:pointer;transition:all .2s ease;width:100%;text-align:center;
    border:1px solid rgba(0,229,255,.35);background:rgba(0,229,255,.10);color:var(--cyan);
    box-shadow:0 8px 24px rgba(0,229,255,.12)
  }
  .btn-passport:hover{background:rgba(0,229,255,.18);transform:translateY(-1px);box-shadow:0 14px 34px rgba(0,229,255,.20)}
  .btn-passport.secondary{border-color:rgba(255,255,255,.16);background:rgba(255,255,255,.04);color:var(--text)}
  .passport-shared{
    padding:10px 14px;border-radius:12px;border:1px solid rgba(93,255,178,.25);
    background:rgba(93,255,178,.07);color:var(--green);font-size:12px;
    display:none;margin-top:4px;line-height:1.5
  }
  .passport-shared.show{display:block}

  /* â”€â”€ GENERAL SHARED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    border-radius:999px;border:1px solid transparent;padding:11px 22px;
    font-size:13px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
    cursor:pointer;transition:all .22s ease;user-select:none;white-space:nowrap
  }
  .btn-primary{background:linear-gradient(135deg,#00e5ff,#7df2ff);color:#03040a;box-shadow:0 14px 50px rgba(0,229,255,.32)}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 22px 70px rgba(0,229,255,.48)}
  .btn-ghost{background:rgba(255,255,255,.04);color:var(--text);border-color:rgba(255,255,255,.14);backdrop-filter:blur(14px)}
  .btn-ghost:hover{background:rgba(255,255,255,.08);border-color:rgba(0,229,255,.24);transform:translateY(-1px)}

  .sig{display:inline-flex;align-items:center;gap:6px;padding:4px 9px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--muted)}
  .sig.bad{border-color:rgba(220,53,69,.25);background:rgba(220,53,69,.10);color:#ff7a8a}
  .sig.warn{border-color:rgba(255,193,7,.25);background:rgba(255,193,7,.08);color:#ffd166}
  .sig.ok{border-color:rgba(0,230,118,.25);background:rgba(0,230,118,.08);color:#78ffbf}
  .sig-dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.9;flex:0 0 auto}

  /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .footer{border-top:1px solid rgba(255,255,255,.06);margin-top:32px;padding-top:18px;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted)}
  .footer-brand{color:var(--cyan);font-weight:700}
  .footer-note{font-size:11px;opacity:.7;max-width:580px;line-height:1.5}

  /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width:900px){.top3{grid-template-columns:1fr 1fr}.top3 .score-card.card-score{grid-column:1/-1}}
  @media (max-width:780px){.main-grid{grid-template-columns:1fr}.fix-steps{grid-template-columns:1fr}.passport-inner{grid-template-columns:1fr}.top3{grid-template-columns:1fr}}
  @media (max-width:640px){.scan-bar{flex-wrap:wrap;border-radius:20px;padding:12px 14px}.scan-bar input{width:100%;flex:1 1 100%}.scan-net,.btn-scan{flex:1 1 calc(50% - 5px)}}
  @media (min-width:901px){html{zoom:1.10}}

  /* â”€â”€ PERF: contain layout on heavy sections â”€â”€â”€ */
  #dashboard .score-card,
  #dashboard .exp-card,
  #dashboard .threats-card,
  #fwRelSection,
  #fwWatchSection,
  #fwThreatFeedSection { contain: layout style; }
  #dashboard .exp-card svg { contain: strict; }
  .firewall-badge .dot { will-change: opacity, transform; }

  /* â”€â”€ MOBILE (â‰¤600px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width:600px) {
    html { zoom: 1 !important; }
    body { font-size: 14px; }
    .top-bar { flex-wrap: wrap; padding: 10px 12px; border-radius: 18px; gap: 8px; margin-bottom: 18px; }
    .brand-sub { display: none; }
    .top-right { gap: 6px; flex-wrap: wrap; }
    .back-link { display: none; }
    .firewall-badge { font-size: 9px; padding: 4px 8px; }
    .lang-switch { order: -1; }
    .btn-full-access-top { font-size: 10px; padding: 6px 10px; }
    .hero { padding: 6px 0 16px; }
    .hero-title { font-size: 24px !important; line-height: 1.2; }
    .hero-sub { font-size: 12px; }
    .scan-bar { gap: 8px; }
    #dashboard { padding: 0 2px; }
    .section-title { font-size: 12px; letter-spacing: .14em; }
    .top3, .main-grid, .fix-steps, .passport-inner { grid-template-columns: 1fr !important; }
    .score-card { padding: 18px; }
    .card-score .score-ring { width: 100px; height: 100px; }
    .card-num { font-size: 36px; }
    .threat-item { padding: 12px; }
    .threat-name { font-size: 12px; }
    .threat-meta { flex-wrap: wrap; gap: 4px; }
    .rel-grid { grid-template-columns: 1fr !important; }
    .rel-card { padding: 14px; }
    .fw-watch-grid { grid-template-columns: 1fr !important; }
    .fw-watch-row { flex-wrap: wrap; gap: 6px; }
    .fix-step { padding: 14px; }
    #fwExportSection .export-btns { flex-direction: column; }
    .access-gate { padding: 24px 16px !important; }
    .access-gate-title { font-size: 18px !important; }
    #fwPassportSection .passport-inner > div { padding: 16px; }
    #ppWallet { font-size: 11px; }
    #passPopup > div { padding: 18px 16px !important; border-radius: 18px !important; }
    /* Force AppKit modal above passPopup */
w3m-modal, wcm-modal, appkit-w3m-router,
[data-testid="w3m-modal"], .w3m-overlay {
  z-index: 999999 !important;
  position: relative;
}
    .tfd-item { flex-direction: column; gap: 8px; }
    #fwTimelineModal > div { width: calc(100% - 16px) !important; max-height: 85vh !important; }
  }

  /* â”€â”€ SMALL TABLET (601-900px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 900px) and (min-width: 601px) {
    html { zoom: 1 !important; }
    .rel-grid { grid-template-columns: 1fr 1fr; }
    .fw-watch-grid { grid-template-columns: 1fr 1fr !important; }
    .top-bar { border-radius: 20px; }
  }

  /* â”€â”€ NOTICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notice{
    max-width:760px;margin:0 auto 24px;padding:12px 18px;border-radius:14px;
    border:1px solid rgba(255,193,7,.22);background:rgba(255,193,7,.07);
    font-size:12px;color:rgba(244,246,255,.72);line-height:1.5;text-align:center
  }
  .notice strong{color:#ffd166}

  /* â”€â”€ FULL ACCESS BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn-full-access{
    background:linear-gradient(135deg,#7c5cff,#a87eff);color:#fff;
    border:none;border-radius:999px;padding:13px 24px;
    font-size:13px;font-weight:900;letter-spacing:.06em;text-transform:uppercase;
    cursor:pointer;white-space:nowrap;transition:transform .2s ease,box-shadow .2s ease;
    box-shadow:0 14px 42px rgba(124,92,255,.42)
  }
  .btn-full-access:hover{transform:translateY(-1px);box-shadow:0 20px 60px rgba(124,92,255,.58)}
  .btn-full-access-top{
    background:rgba(124,92,255,.15);border:1px solid rgba(124,92,255,.35);color:#a87eff;
    border-radius:999px;padding:8px 14px;font-size:11px;font-weight:800;letter-spacing:.10em;text-transform:uppercase;
    cursor:pointer;transition:all .2s ease
  }
  .btn-full-access-top:hover{background:rgba(124,92,255,.28);color:#c4a6ff}
  .coming-soon-badge{
    position:absolute;top:-8px;right:-4px;
    background:linear-gradient(135deg,#ff9a6b,#ffd166);color:#03040a;
    font-size:8px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;
    padding:2px 6px;border-radius:999px;white-space:nowrap
  }

  /* â”€â”€ LOCKED SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .locked-section{position:relative}
  .locked-section .lock-overlay{
    position:absolute;inset:0;border-radius:var(--radius);z-index:5;
    background:linear-gradient(180deg,rgba(5,6,10,.05) 0%,rgba(5,6,10,.92) 55%,rgba(5,6,10,.98) 100%);
    display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:24px;
    backdrop-filter:blur(2px)
  }
  .lock-overlay-inner{text-align:center}
  .lock-overlay-inner .lock-icon{font-size:22px;margin-bottom:6px}
  .lock-overlay-inner p{font-size:12px;color:var(--muted);margin-bottom:12px}
  .pp-watermark{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:15px;font-weight:900;letter-spacing:.3em;text-transform:uppercase;
    color:rgba(255,255,255,.08);pointer-events:none;transform:rotate(-18deg);
    text-shadow:none;z-index:2
  }
    /* â”€â”€ WALLET RELATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .rel-section-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px 22px 18px}
  .rel-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:14px;max-width:100%}
  .rel-card{
    background:rgba(255,255,255,.035);border-radius:16px;padding:15px 16px;
    border:1px solid rgba(255,255,255,.10);transition:border-color .22s,transform .18s;
    display:flex;flex-direction:column;
  }
  .rel-card-body{flex:1}
  .rel-card:hover{border-color:rgba(0,229,255,.32);transform:translateY(-1px)}
  .rel-card.cex {border-left:3px solid rgba(93,255,178,.65)}
  .rel-card.dex {border-left:3px solid rgba(0,229,255,.65)}
  .rel-card.bridge{border-left:3px solid rgba(124,92,255,.65)}
  .rel-card.lending{border-left:3px solid rgba(255,193,7,.65)}
  .rel-card.staking{border-left:3px solid rgba(255,174,71,.65)}
  .rel-entity-name{font-size:13px;font-weight:800;margin-bottom:6px;line-height:1.3}
  .rel-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
  .rel-tag{font-size:9px;padding:2px 8px;border-radius:999px;font-weight:800;letter-spacing:.07em;text-transform:uppercase}
  .rel-tag.cex{background:rgba(93,255,178,.10);color:#5dffb2;border:1px solid rgba(93,255,178,.22)}
  .rel-tag.dex{background:rgba(0,229,255,.08);color:#00e5ff;border:1px solid rgba(0,229,255,.20)}
  .rel-tag.bridge{background:rgba(124,92,255,.10);color:#a87eff;border:1px solid rgba(124,92,255,.25)}
  .rel-tag.lending{background:rgba(255,193,7,.08);color:#ffd166;border:1px solid rgba(255,193,7,.22)}
  .rel-tag.staking{background:rgba(255,174,71,.08);color:#ffc04a;border:1px solid rgba(255,174,71,.22)}
  .rel-tag.trusted{background:rgba(93,255,178,.06);color:#5dffb2;border:1px solid rgba(93,255,178,.15)}
  .rel-tag.verified{background:rgba(0,229,255,.06);color:#00e5ff;border:1px solid rgba(0,229,255,.14)}
  .rel-tag.aggregator{background:rgba(255,174,71,.06);color:#ffc04a;border:1px solid rgba(255,174,71,.14)}
  .rel-stats-row{display:flex;gap:10px;margin-bottom:10px}
  .rel-stat{flex:1;text-align:center;background:rgba(255,255,255,.03);border-radius:8px;padding:6px 4px}
  .rel-stat-val{font-size:18px;font-weight:900;line-height:1}
  .rel-stat-key{font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-top:2px}
  .rel-timeline-btn{
    font-size:10px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;
    background:rgba(0,229,255,.06);border:1px solid rgba(0,229,255,.2);
    color:var(--cyan);border-radius:8px;padding:5px 12px;cursor:pointer;
    width:100%;transition:all .2s;margin-top:4px
  }
  .rel-timeline-btn:hover{background:rgba(0,229,255,.14);border-color:rgba(0,229,255,.4)}
  .rel-empty{text-align:center;color:var(--muted);padding:32px;font-size:13px;letter-spacing:.02em}
  .rel-loading{text-align:center;color:var(--cyan);padding:24px;font-size:12px;letter-spacing:.1em;text-transform:uppercase}

  /* â”€â”€ EXPORT SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .fw-export-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px}
  .fw-export-btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:11px 22px;border-radius:12px;border:1px solid;
    font-size:12px;font-weight:800;letter-spacing:.07em;text-transform:uppercase;
    cursor:pointer;transition:all .2s
  }
  .fw-export-btn:hover{transform:translateY(-1px);filter:brightness(1.15)}
  .fw-export-btn.csv {background:rgba(93,255,178,.07);border-color:rgba(93,255,178,.28);color:#5dffb2}
  .fw-export-btn.json{background:rgba(0,229,255,.06);border-color:rgba(0,229,255,.26);color:#00e5ff}
  .fw-export-btn.copy{background:rgba(124,92,255,.07);border-color:rgba(124,92,255,.26);color:#a87eff}
  #fwExportSection.hidden{display:none}

  /* â”€â”€ TIMELINE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #fwTimelineModal{
    position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:9999;
    display:flex;align-items:center;justify-content:center;
    backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)
  }
  #fwTimelineModal .tm-box{
    background:linear-gradient(145deg,rgba(12,14,28,.98),rgba(8,10,22,.98));
    border:1px solid rgba(255,255,255,.14);border-radius:22px;padding:24px;
    max-width:460px;width:calc(100% - 32px);max-height:82vh;overflow-y:auto;
    box-shadow:0 24px 80px rgba(0,0,0,.7)
  }
  .tm-entry{
    padding:9px 12px;border-left:3px solid;margin-bottom:7px;
    border-radius:0 10px 10px 0;background:rgba(255,255,255,.03);font-size:12px
  }
  .tm-entry.in {border-color:#5dffb2}
  .tm-entry.out{border-color:#ff9a6b}
  .tm-hash{font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:3px}

  /* â”€â”€ EXPORT LOCK OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #fwExportSection{display:none}
  #fwExportSection.fw-visible{display:block}
  .fw-export-locked .fw-export-btns-wrap{position:relative;pointer-events:none}
  .fw-export-locked .fw-export-btns-wrap::after{
    content:"";
    position:absolute;inset:0;border-radius:12px;
    background:linear-gradient(180deg,rgba(5,6,10,.0) 0%,rgba(5,6,10,.88) 60%,rgba(5,6,10,.97) 100%);
    backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);
    pointer-events:all;z-index:2
  }
  .fw-export-unlock-cta{
    margin-top:14px;padding:14px;border-radius:14px;
    background:linear-gradient(135deg,rgba(124,92,255,.10),rgba(0,229,255,.07));
    border:1px solid rgba(124,92,255,.28);text-align:center
  }

  /* â”€â”€ RULE CONFIRM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #fwRuleConfirmModal{
    position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:99990;
    display:flex;align-items:center;justify-content:center;
    backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)
  }
  #fwRuleConfirmModal .rc-box{
    background:linear-gradient(145deg,rgba(12,14,28,.98),rgba(8,10,22,.98));
    border:1px solid rgba(255,193,7,.28);border-radius:22px;padding:28px 28px 22px;
    max-width:440px;width:calc(100% - 32px);
    box-shadow:0 24px 80px rgba(0,0,0,.7),0 0 40px rgba(255,193,7,.07)
  }
  .rc-warning{
    background:rgba(255,193,7,.08);border:1px solid rgba(255,193,7,.25);
    border-radius:12px;padding:12px 14px;font-size:12px;color:#ffd166;
    line-height:1.65;margin-bottom:16px
  }
  .rc-tx-list{
    background:rgba(0,0,0,.3);border-radius:10px;padding:10px 12px;
    font-size:11px;color:var(--muted);line-height:1.8;
    max-height:120px;overflow-y:auto;margin-bottom:16px;
    font-family:var(--mono)
  }
  .rc-btns{display:flex;gap:10px;margin-top:4px}
  .rc-btn-cancel{
    flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);color:var(--text);font-size:12px;
    font-weight:800;letter-spacing:.07em;text-transform:uppercase;cursor:pointer;transition:all .2s
  }
  .rc-btn-cancel:hover{background:rgba(255,255,255,.1)}
  .rc-btn-confirm{
    flex:2;padding:12px;border-radius:12px;border:none;
    background:linear-gradient(135deg,#7c5cff,#a87eff);color:#fff;
    font-size:12px;font-weight:900;letter-spacing:.07em;text-transform:uppercase;
    cursor:pointer;transition:all .2s;box-shadow:0 8px 28px rgba(124,92,255,.35)
  }
  .rc-btn-confirm:hover{transform:translateY(-1px);box-shadow:0 14px 40px rgba(124,92,255,.5)}

  /* â”€â”€ SCAN HISTORY BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #fwHistoryBanner{
    display:none;
    background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.09);
    border-radius:16px;padding:14px 18px;margin-bottom:20px;
    animation:dashIn .4s ease-out
  }
  #fwHistoryBanner.show{display:block}
  .fwh-row{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
  .fwh-label{font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-weight:700;white-space:nowrap}
  .fwh-delta{
    display:inline-flex;align-items:center;gap:5px;
    padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;
    letter-spacing:.04em;white-space:nowrap
  }
  .fwh-delta.up  {background:rgba(93,255,178,.10);color:#5dffb2;border:1px solid rgba(93,255,178,.22)}
  .fwh-delta.down{background:rgba(255,71,87,.10); color:#ff7a8a;border:1px solid rgba(255,71,87,.22)}
  .fwh-delta.same{background:rgba(255,255,255,.05);color:var(--muted);border:1px solid rgba(255,255,255,.10)}
  .fwh-detail{font-size:11px;color:var(--muted);line-height:1.6}
  .fwh-detail strong{color:var(--text)}
  .fwh-sparkline{display:flex;align-items:flex-end;gap:3px;height:28px;margin-left:auto}
  .fwh-bar{
    width:8px;border-radius:3px 3px 0 0;
    background:rgba(0,229,255,.3);
    transition:background .2s;cursor:default;position:relative
  }
  .fwh-bar.current{background:var(--cyan)}
  .fwh-bar:hover{background:rgba(0,229,255,.7)}
  .fwh-multi{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .fwh-wallet-chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:5px 10px;border-radius:10px;
    background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);
    font-size:11px;cursor:pointer;transition:all .2s;font-family:var(--mono)
  }
  .fwh-wallet-chip:hover{border-color:rgba(0,229,255,.3);background:rgba(0,229,255,.06)}
  .fwh-wallet-chip .fwh-dot{width:7px;height:7px;border-radius:50%;flex:0 0 auto}

  /* â”€â”€ SIGNED PASSPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn-passport.sign{
    background:linear-gradient(135deg,rgba(124,92,255,.15),rgba(0,229,255,.10));
    border:1px solid rgba(124,92,255,.45);color:#c4b5fd;
    font-weight:900;position:relative;overflow:hidden
  }
  .btn-passport.sign:hover{
    background:linear-gradient(135deg,rgba(124,92,255,.25),rgba(0,229,255,.18));
    border-color:rgba(124,92,255,.7);transform:translateY(-1px);
    box-shadow:0 12px 40px rgba(124,92,255,.3)
  }
  .pp-signed-badge{
    display:none;
    background:linear-gradient(135deg,rgba(93,255,178,.12),rgba(0,229,255,.08));
    border:1px solid rgba(93,255,178,.3);border-radius:10px;
    padding:8px 12px;font-size:11px;color:#5dffb2;line-height:1.6;
    margin-top:10px;word-break:break-all;font-family:var(--mono)
  }
  .pp-signed-badge.visible{display:block}
  .pp-sig-chip{
    display:inline-flex;align-items:center;gap:5px;
    background:rgba(93,255,178,.12);border:1px solid rgba(93,255,178,.25);
    border-radius:999px;padding:3px 10px;font-size:10px;
    color:#5dffb2;font-weight:900;letter-spacing:.06em;
    position:absolute;top:12px;right:12px
  }

  /* â”€â”€ VERIFY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #fwVerifyModal{
    position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:99995;
    display:none;align-items:center;justify-content:center;
    backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)
  }
  #fwVerifyModal.open{display:flex}
  .fv-box{
    background:linear-gradient(145deg,rgba(10,12,26,.99),rgba(6,8,18,.99));
    border-radius:24px;padding:32px;max-width:460px;width:calc(100% - 32px);
    text-align:center;position:relative
  }
  .fv-icon{font-size:52px;margin-bottom:12px;line-height:1}
  .fv-title{font-size:22px;font-weight:900;margin-bottom:8px}
  .fv-sub{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.6}
  .fv-card{
    background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);
    border-radius:16px;padding:18px;text-align:left;margin-bottom:20px
  }
  .fv-row{display:flex;justify-content:space-between;padding:5px 0;font-size:12px}
  .fv-row:not(:last-child){border-bottom:1px solid rgba(255,255,255,.06)}
  .fv-key{color:var(--muted)}
  .fv-val{font-weight:700;font-family:var(--mono);font-size:11px}
  .fv-close{
    margin-top:4px;padding:10px 24px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);color:var(--text);font-size:12px;
    font-weight:800;cursor:pointer;letter-spacing:.07em
  }
  .fv-close:hover{background:rgba(255,255,255,.1)}
  .fv-valid  .fv-box{border:1px solid rgba(93,255,178,.3);box-shadow:0 0 60px rgba(93,255,178,.08)}
  .fv-invalid .fv-box{border:1px solid rgba(255,71,87,.3);box-shadow:0 0 60px rgba(255,71,87,.08)}
  .fv-expired .fv-box{border:1px solid rgba(255,193,7,.3); box-shadow:0 0 60px rgba(255,193,7,.08)}

  /* â•â•â• WALLET WATCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .fw-watch-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:16px;flex-wrap:wrap}
  .fw-watch-header-text{flex:1;min-width:0}
  .fw-watch-header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start;flex:0 0 auto}
  #fwWatchSection{display:none}
  #fwWatchSection.fw-visible{display:block}
  .fw-watch-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
  @media(max-width:640px){.fw-watch-grid{grid-template-columns:1fr}}
  .fw-watch-row{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:11px 14px;border-radius:13px;
    background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.09);
    transition:border-color .2s
  }
  .fw-watch-row:hover{border-color:rgba(0,229,255,.22)}
  .fw-watch-info{flex:1;min-width:0}
  .fw-watch-addr{font-size:12px;font-family:var(--mono);font-weight:700;color:var(--text)}
  .fw-watch-sub{font-size:10px;color:var(--muted);margin-top:2px}
  .fw-watch-dot{width:8px;height:8px;border-radius:50%;flex:0 0 auto;margin-right:4px}
  .fw-watch-score{font-size:18px;font-weight:900;line-height:1}
  .fw-watch-actions{display:flex;gap:6px;flex:0 0 auto}
  .fw-watch-btn{
    padding:5px 10px;border-radius:8px;font-size:10px;font-weight:800;
    letter-spacing:.06em;text-transform:uppercase;border:1px solid;
    cursor:pointer;transition:all .18s;background:transparent
  }
  .fw-watch-btn.scan{border-color:rgba(0,229,255,.3);color:var(--cyan)}
  .fw-watch-btn.scan:hover{background:rgba(0,229,255,.08)}
  .fw-watch-btn.del{border-color:rgba(255,71,87,.2);color:#ff7a8a}
  .fw-watch-btn.del:hover{background:rgba(255,71,87,.08)}
  .fw-watch-add{display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap}
  .fw-watch-input{
    flex:1;min-width:180px;padding:9px 14px;border-radius:11px;
    background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);
    color:var(--text);font-size:12px;font-family:var(--mono);outline:none;
    transition:border-color .2s
  }
  .fw-watch-input:focus{border-color:rgba(0,229,255,.4)}
  .fw-watch-submit{
    padding:9px 16px;border-radius:11px;font-size:11px;font-weight:900;
    letter-spacing:.07em;text-transform:uppercase;
    background:linear-gradient(135deg,rgba(0,229,255,.12),rgba(0,229,255,.06));
    border:1px solid rgba(0,229,255,.3);color:var(--cyan);cursor:pointer;
    transition:all .2s;white-space:nowrap
  }
  .fw-watch-submit:hover{background:rgba(0,229,255,.18);transform:translateY(-1px)}
  .fw-notif-row{
    display:flex;align-items:center;gap:10px;margin-top:10px;
    padding:10px 14px;border-radius:11px;
    background:rgba(124,92,255,.06);border:1px solid rgba(124,92,255,.18)
  }
  .fw-notif-row .fw-notif-icon{font-size:16px}
  .fw-notif-row .fw-notif-text{font-size:11px;color:var(--muted);flex:1;line-height:1.5}
  .fw-notif-btn{
    padding:6px 12px;border-radius:9px;font-size:10px;font-weight:900;
    letter-spacing:.07em;text-transform:uppercase;cursor:pointer;
    background:rgba(124,92,255,.12);border:1px solid rgba(124,92,255,.3);
    color:#a87eff;transition:all .2s;white-space:nowrap
  }
  .fw-notif-btn:hover{background:rgba(124,92,255,.2)}
  .fw-alert-banner{
    display:none;padding:14px 18px;border-radius:14px;margin-bottom:12px;
    background:linear-gradient(135deg,rgba(255,71,87,.12),rgba(255,71,87,.06));
    border:1px solid rgba(255,71,87,.3);
    animation:pulseBorder 2s infinite;
  }
  /* âœ… FIX: ×œ× ×œ×“×¨×•×¡ ××ª pulse ×©×œ ×”×“×•×˜ ×œ××¢×œ×” */
  @keyframes pulseBorder{0%,100%{border-color:rgba(255,71,87,.3)}50%{border-color:rgba(255,71,87,.7)}}
  .fw-alert-banner.show{display:block}

  /* â•â•â• THREAT FEED â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #fwThreatFeedSection{display:none}
  #fwThreatFeedSection.fw-visible{display:block}
  .tfd-item{
    display:flex;align-items:flex-start;gap:12px;
    padding:14px 16px;border-radius:14px;margin-bottom:8px;
    background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.09);
    transition:border-color .2s;cursor:default
  }
  .tfd-item:hover{border-color:rgba(255,71,87,.2)}
  .tfd-item.affected{background:rgba(255,71,87,.06);border-color:rgba(255,71,87,.25)}
  .tfd-severity{
    width:32px;height:32px;border-radius:10px;flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;font-size:15px
  }
  .tfd-severity.critical{background:rgba(255,71,87,.12)}
  .tfd-severity.high{background:rgba(255,120,50,.12)}
  .tfd-severity.medium{background:rgba(255,193,7,.10)}
  .tfd-body{flex:1;min-width:0}
  .tfd-title{font-size:13px;font-weight:800;margin-bottom:3px}
  .tfd-desc{font-size:11px;color:var(--muted);line-height:1.55}
  .tfd-meta{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center}
  .tfd-tag{font-size:10px;padding:2px 8px;border-radius:999px;font-weight:700;letter-spacing:.05em}
  .tfd-tag.date{background:rgba(255,255,255,.06);color:var(--muted)}
  .tfd-tag.affected-you{background:rgba(255,71,87,.15);color:#ff7a8a;border:1px solid rgba(255,71,87,.3)}
  .tfd-tag.chain-bsc{background:rgba(255,193,7,.10);color:#ffd166}
  .tfd-tag.chain-eth{background:rgba(0,229,255,.08);color:var(--cyan)}
  .tfd-tag.chain-polygon{background:rgba(130,71,229,.12);color:#a87eff}
  .tfd-link{font-size:10px;color:var(--cyan);text-decoration:none;font-weight:700;opacity:.7;transition:opacity .2s}
  .tfd-link:hover{opacity:1}
  .tfd-affected-badge{font-size:10px;font-weight:900;letter-spacing:.06em;color:#ff7a8a;margin-bottom:6px;text-transform:uppercase}

  /* â•â•â• PUBLIC API â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #fwApiSection{display:block}
  .api-endpoint{
    background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.09);
    border-radius:13px;padding:14px 16px;margin-bottom:10px;
    font-family:var(--mono);font-size:12px
  }
  .api-method{
    display:inline-block;padding:2px 9px;border-radius:6px;
    font-size:10px;font-weight:900;letter-spacing:.1em;margin-right:8px
  }
  .api-method.get{background:rgba(93,255,178,.12);color:var(--green)}
  .api-endpoint-url{color:var(--cyan);word-break:break-all}
  .api-endpoint-desc{font-size:11px;color:var(--muted);margin-top:4px;font-family:var(--sans);line-height:1.5}
  .api-copy-btn{
    float:right;padding:3px 10px;border-radius:7px;font-size:10px;
    font-weight:800;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);color:var(--muted);
    cursor:pointer;transition:all .18s;font-family:var(--sans)
  }
  .api-copy-btn:hover{border-color:rgba(0,229,255,.3);color:var(--cyan)}
  .api-response{
    margin-top:10px;padding:10px;border-radius:9px;
    background:rgba(0,0,0,.4);font-size:10px;color:rgba(93,255,178,.75);
    line-height:1.7;max-height:90px;overflow:auto
  }
</style>
</head>
<body>
<div class="page-shell">

  <!-- TOP BAR -->
  <header class="top-bar">
    <a class="brand" href="/" title="Back to CycleX">
      <picture>
        <source srcset="/logo.webp" type="image/webp">
        <img src="/logo.png" alt="CycleX" class="brand-logo" width="42" height="42" onerror="this.style.display='none'">
      </picture>
      <div class="brand-text">
        <div class="brand-title">CYCLEX</div>
        <div class="brand-sub">Wallet Firewall</div>
      </div>
    </a>
    <div class="top-right">
      <!-- Language switcher -->
      <div class="lang-switch" aria-label="Language selector">
        <button class="lang-btn active" data-lang="en" type="button">ğŸ‡ºğŸ‡¸ EN</button>
        <button class="lang-btn" data-lang="zh" type="button">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="ar" type="button">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨ÙŠ</button>
        <button class="lang-btn" data-lang="ru" type="button">ğŸ‡·ğŸ‡º RU</button>
      </div>
      <div id="tierBadge" style="display:none;font-size:10px;letter-spacing:.14em;text-transform:uppercase;padding:6px 12px;border-radius:999px;border:1px solid rgba(93,255,178,.3);background:rgba(93,255,178,.08);color:var(--green);font-weight:800">âœ“ FULL ACCESS</div>
      <div class="firewall-badge"><span class="dot"></span><span data-i18n="fw_badge">FIREWALL</span></div>
      <button class="btn-full-access-top" id="btnTopAccess" title="Unlock full features" data-i18n="btn_full_access">ğŸ”‘ Full Access</button>
      <a class="back-link" href="/" data-i18n="btn_back">â† Back to Hub</a>
    </div>
  </header>

  <main>

    <!-- â”€â”€ HERO / LANDING â”€â”€ -->
    <section class="hero" id="heroSection">
      <div class="hero-kicker" data-i18n="hero_kicker">ğŸ”¥ Wallet Firewall</div>
      <h1 class="hero-title" data-i18n="hero_title">Turn any wallet into<br>a protected wallet.</h1>
      <p class="hero-sub" data-i18n="hero_sub">
        Scan your approvals, reveal your Blast Radius, get a guided Fix Plan â€”
        and generate a shareable Proof Passport. In 60 seconds.
      </p>

      <div class="scan-bar">
        <input id="walletInput" class="mono" placeholder="0x... wallet address" spellcheck="false" autocomplete="off" />
        <select id="netSelect" class="scan-net">
          <option value="bsc">BSC</option>
          <option value="eth">ETH</option>
          <option value="polygon">POLYGON</option>
        </select>
        <button class="btn-scan" id="btnRunFirewall" data-i18n="btn_run">Run Firewall</button>
      </div>

      <span class="demo-hint" id="demoHint">â†— Try with demo wallet</span>

      <div class="hero-micro">
        <span>No signature required</span>
        <span class="micro-dot">Â·</span>
        <span>No transactions</span>
        <span class="micro-dot">Â·</span>
        <span>Read-only scan</span>
        <span class="micro-dot">Â·</span>
        <span>BSC + ETH + Polygon</span>
      </div>
    </section>

    <!-- â”€â”€ LOADING STATE â”€â”€ -->
   <div id="loadWrap">
  <div class="load-label" id="loadLabel">Initializing Firewall Scanâ€¦</div>

  <div class="load-steps">
    <div class="load-step" id="step1">
      <div class="step-icon">âŸ³</div>
      <span data-i18n="step1">Fetching approval logs</span>
    </div>

    <div class="load-step" id="step2">
      <div class="step-icon">âŸ³</div>
      <span data-i18n="step2">Analyzing spender risk</span>
    </div>

    <div class="load-step" id="step3">
      <div class="step-icon">âŸ³</div>
      <span data-i18n="step3">Calculating Blast Radius</span>
    </div>

    <div class="load-step" id="step4">
      <div class="step-icon">âŸ³</div>
      <span data-i18n="step4">Building Fix Plan</span>
    </div>
  </div>

  <div class="load-bar">
    <div class="load-bar-fill" id="loadBarFill"></div>
  </div>
</div>

    <!-- â”€â”€ DASHBOARD â”€â”€ -->
    <div id="dashboard">

      <div class="notice" id="scanNotice" style="display:none">
        <strong data-i18n="notice_live_title">Live scan.</strong> <span data-i18n="notice_live_body">Read-only on-chain data. No transactions made.</span>
      </div>
      <div class="notice" id="demoNotice">
        <strong data-i18n="notice_demo_title">Demo mode:</strong> <span data-i18n="notice_demo_body">Showing sample data. Enter a real wallet address and click "Run Firewall" to scan live.</span>
      </div>

      <!-- ACCESS GATE OVERLAY -->
      <div id="accessGateOverlay" style="display:none;position:relative;z-index:10;margin-bottom:24px">
        <div style="
          background:linear-gradient(135deg,rgba(124,92,255,.12),rgba(0,229,255,.08));
          border:1px solid rgba(124,92,255,.35);border-radius:22px;padding:28px;
          text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.55),0 0 30px rgba(124,92,255,.12)
        ">
          <div style="font-size:32px;margin-bottom:12px">ğŸ”’</div>
          <div style="font-size:18px;font-weight:900;margin-bottom:8px">Full Access Required</div>
          <div style="font-size:13px;color:var(--muted);line-height:1.7;max-width:52ch;margin:0 auto 20px">
            <span data-i18n="gate_msg">Hold <strong style="color:var(--cyan)">1 PASS token</strong> to unlock Fix Mode, full Blast Radius, Wallet Passport, and real revoke actions.</span>
          </div>
          <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
            <!-- Connect & Check â€” triggers AppKit modal -->
            <button class="btn btn-full-access" id="btnCheckAccess">
              ğŸ”‘ Connect &amp; Check Access
            </button>
            <!-- PASS: opens purchase popup -->
            <button class="btn btn-ghost" id="btnBuyPass" style="font-size:12px">
              ğŸ« Get PASS â†—
            </button>
          </div>
          <div id="gateStatus" style="margin-top:14px;font-size:12px;color:var(--muted);min-height:18px"></div>
        </div>
      </div>

      <!-- Wallet badge -->
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="meta-chip" style="font-family:var(--mono);font-size:12px;padding:8px 14px" id="walletBadge">0x...</div>
          <div class="meta-chip" id="netBadge">BSC</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-ghost" id="btnRescan" style="padding:9px 16px;font-size:12px">â†º Rescan</button>
          <button class="btn btn-ghost" id="btnNewScan" style="padding:9px 16px;font-size:12px">New wallet</button>
        </div>
      </div>

      <!-- TOP 3 CARDS -->
      <!-- â”€â”€ SCAN HISTORY BANNER â”€â”€ -->
      <div id="fwHistoryBanner" style="margin-bottom:20px">
        <div class="fwh-row">
          <span class="fwh-label">ğŸ“ˆ Scan History</span>
          <div id="fwHistoryDelta"></div>
          <div id="fwHistoryDetail" class="fwh-detail"></div>
          <div class="fwh-sparkline" id="fwHistorySparkline"></div>
        </div>
        <div class="fwh-multi" id="fwHistoryWallets" style="display:none"></div>
      </div>

      <div class="section-title" style="margin-top:0" data-i18n="sec_status">Firewall Status</div>
      <div class="top3">

        <!-- Score -->
        <div class="score-card card-score">
          <div class="sc-kicker" data-i18n="kicker_score">Firewall Score</div>
          <div class="gauge-wrap">
            <svg class="gauge-svg" width="90" height="90" viewBox="0 0 90 90">
              <circle class="gauge-track" cx="45" cy="45" r="36"/>
              <circle class="gauge-fill" id="gaugeFill" cx="45" cy="45" r="36"
                stroke="#ff4757"
                stroke-dasharray="226.2"
                stroke-dashoffset="226.2"/>
            </svg>
            <div class="gauge-num">
              <span id="scoreNum">â€”</span>
              <small>/100</small>
            </div>
          </div>
          <div class="sc-label">
            <div class="sc-dot" id="scoreDot" style="background:#ff4757"></div>
            <span id="scoreLabel" style="font-weight:800">Scanningâ€¦</span>
          </div>
          <div class="card-meta" id="scoreMeta"></div>
        </div>

        <!-- Blast Radius -->
        <div class="score-card card-blast">
          <div class="sc-kicker" data-i18n="kicker_blast">ğŸ’¥ Blast Radius</div>
          <div class="blast-amount" id="blastAmt">â€”</div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px" data-i18n="blast_sub">max drainable if top spender exploited</div>
          <div class="card-meta" id="blastMeta"></div>
        </div>

        <!-- Time to Drain -->
        <div class="score-card card-drain">
          <div class="sc-kicker" data-i18n="kicker_drain">â± Time-to-Drain</div>
          <div class="drain-time" id="drainTime">â€”</div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px" data-i18n="drain_sub">estimated drain time for exposed assets</div>
          <div class="card-meta" id="drainMeta"></div>
        </div>

      </div>

      <!-- MAIN GRID: Map + Threats -->
      <div class="main-grid">

        <!-- Exposure Map -->
        <div class="exp-card">
          <div class="exp-title" data-i18n="title_map">ğŸ—º Exposure Map</div>
          <div class="exp-sub" data-i18n="map_sub">Wallet â†’ Spenders â†’ Tokens. Node size = risk weight.</div>
          <svg id="exposureMap" viewBox="0 0 480 260" xmlns="http://www.w3.org/2000/svg">
            <!-- rendered by JS -->
          </svg>
        </div>

        <!-- Top Threats -->
        <div class="threats-card">
          <div class="exp-title" style="margin-bottom:14px" data-i18n="title_threats">ğŸ¯ Top Threats</div>
          <div id="threatsList"></div>
        </div>

      </div>

      <!-- FIX MODE -->
      <div class="section-title" data-i18n="sec_fix">Fix Mode</div>
      <div class="fix-card locked-section" id="fixCard">
        <!-- Lock overlay (shown in free tier) -->
        <div class="lock-overlay" id="fixLockOverlay">
          <div class="lock-overlay-inner">
            <div class="lock-icon">ğŸ”’</div>
            <p data-i18n="fix_lock_msg">Fix Mode requires Full Access<br>(hold 1 PASS token)</p>
            <button class="btn-full-access" onclick="requestFullAccess()" style="font-size:11px;padding:10px 18px" data-i18n="btn_unlock_fix">Unlock Fix Mode</button>
          </div>
        </div>
        <div class="fix-header">
          <div>
            <div style="font-size:16px;font-weight:800;margin-bottom:4px" data-i18n="fix_title">ğŸ›  3-Step Fix Plan</div>
            <div style="font-size:13px;color:var(--muted)" data-i18n="fix_sub">Complete these actions to improve your Firewall Score.</div>
          </div>
          <div class="fix-score-gain" id="fixGain" style="display:none">
            After fix: <strong id="fixNewScore">â€”</strong>/100 <span style="opacity:.7;font-size:12px">(+<span id="fixDelta">â€”</span> pts)</span>
          </div>
        </div>

        <div class="fix-steps">
          <div class="fix-step" id="fixStep1">
            <div class="fix-step-num">1</div>
            <div class="fix-step-title" data-i18n="fix1_title">Revoke Top Spender</div>
            <div class="fix-step-desc">Remove unlimited allowance from the highest-risk spender detected on your wallet.</div>
            <button class="btn-action" id="btnFix1" onclick="applyFix(0)">Revoke Top Spender</button>
            <button class="btn-action btn-undo" id="undoFix1" style="display:none;margin-top:6px;background:rgba(255,100,50,.08);border-color:rgba(255,100,50,.3);color:#ff9a6b;font-size:10px" onclick="undoFix(0)">â†© Undo â€” Restore approval</button>
          </div>
          <div class="fix-step" id="fixStep2">
            <div class="fix-step-num">2</div>
            <div class="fix-step-title" data-i18n="fix2_title">Revoke All Unlimited</div>
            <div class="fix-step-desc">Revoke every unlimited approval on your wallet in one go â€” one on-chain tx per spender.</div>
            <button class="btn-action" id="btnFix2" onclick="applyFix(1)">Revoke All Unlimited</button>
            <button class="btn-action btn-undo" id="undoFix2" style="display:none;margin-top:6px;background:rgba(255,100,50,.08);border-color:rgba(255,100,50,.3);color:#ff9a6b;font-size:10px" onclick="undoFix(1)">â†© Undo â€” Restore all unlimited</button>
          </div>
          <div class="fix-step" id="fixStep3">
            <div class="fix-step-num">3</div>
            <div class="fix-step-title" data-i18n="fix3_title">Lock Risky dApp</div>
            <div class="fix-step-desc">Flag and monitor the unverified spender contract to receive alerts on new activity.</div>
            <button class="btn-action" id="btnFix3" onclick="applyFix(2)">Add to Watchlist</button>
            <button class="btn-action btn-undo" id="undoFix3" style="display:none;margin-top:6px;background:rgba(255,100,50,.08);border-color:rgba(255,100,50,.3);color:#ff9a6b;font-size:10px" onclick="undoFix(2)">â†© Undo â€” Remove from watchlist</button>
          </div>
        </div>

        <div class="fix-score-gain" id="fixComplete" style="display:none">
          âœ… Fix complete! Your estimated score after applying all fixes: <strong id="finalScore">â€”</strong>/100
        </div>
      </div>

      <!-- WALLET PASSPORT -->
      <div class="section-title" data-i18n="sec_passport">Wallet Passport</div>
      <div class="passport-wrap locked-section" id="passportWrap">
        <div class="lock-overlay" id="passportLockOverlay">
          <div class="lock-overlay-inner">
            <div class="lock-icon">ğŸ”’</div>
            <p data-i18n="passport_lock_msg">Wallet Passport requires Full Access</p>
            <button class="btn-full-access" onclick="requestFullAccess()" style="font-size:11px;padding:10px 18px">Unlock Passport</button>
          </div>
        </div>
        <div style="margin-bottom:18px">
          <div style="font-size:16px;font-weight:800;margin-bottom:4px">ğŸªª Proof Passport</div>
          <div style="font-size:13px;color:var(--muted)">A shareable, verifiable snapshot of your wallet's security state. Tweet it, share it, flex it.</div>
        </div>
        <div class="passport-inner">

          <!-- Card Preview -->
          <div class="passport-card-preview" id="passportCard">
            <div class="pp-watermark" id="ppWatermark">PREVIEW</div>
            <div class="pp-logo"><div class="pp-logo-dot"></div>CycleX Firewall</div>
            <div class="pp-wallet" id="ppWallet">0x...</div>
            <div class="pp-score-row">
              <div>
                <div class="pp-score-big" id="ppScore" style="color:#ffd166">â€”</div>
                <div class="pp-score-label">Firewall Score</div>
              </div>
              <div class="pp-status" id="ppStatus">âš  Exposed</div>
            </div>
            <div class="pp-stats">
              <div class="pp-stat">
                <div class="pp-stat-val" id="ppApprovals" style="color:#ff6b6b">â€”</div>
                <div class="pp-stat-key">Risky Approvals</div>
              </div>
              <div class="pp-stat">
                <div class="pp-stat-val" id="ppBlast" style="color:#ffd166">â€”</div>
                <div class="pp-stat-key">Blast Radius</div>
              </div>
              <div class="pp-stat">
                <div class="pp-stat-val" id="ppDrain" style="color:#ff4757">â€”</div>
                <div class="pp-stat-key">Drain Time</div>
              </div>
              <div class="pp-stat">
                <div class="pp-stat-val" id="ppChain">BSC</div>
                <div class="pp-stat-key">Network</div>
              </div>
            </div>
            <div class="pp-date" id="ppDate">Scanned: â€”</div>
            <div class="pp-sig-chip" id="ppSigChip" style="display:none">âœ Signed</div>
          </div>

          <!-- Actions -->
          <div class="passport-actions">
            <h3 data-i18n="passport_share_title">Share your Wallet Passport</h3>
            <p>Sign a cryptographic proof of your wallet's security state â€” verifiable by anyone, no KYC, no gas.</p>
            <button class="btn-passport sign" id="btnSignPassport">âœ Sign Passport (EIP-712)</button>
            <div class="pp-signed-badge" id="ppSignedBadge">
              <div style="font-size:10px;letter-spacing:.08em;font-weight:900;color:#5dffb2;margin-bottom:6px;font-family:var(--sans)">âœ… SIGNED â€” CRYPTOGRAPHIC PROOF</div>
              <div id="ppSigShort" style="color:var(--muted)"></div>
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn-passport secondary" id="btnCopyVerifyLink" style="font-size:10px;padding:7px 14px;margin:0">ğŸ”— Copy Verify Link</button>
                <button class="btn-passport secondary" id="btnShareXSigned" style="font-size:10px;padding:7px 14px;margin:0">ğŸ¦ Share to X</button>
              </div>
            </div>
            <button class="btn-passport" id="btnShareX" style="margin-top:10px">ğŸ¦ Share to X (Twitter)</button>
            <button class="btn-passport secondary" id="btnCopyPassport">ğŸ“‹ Copy Passport Text</button>
            <button class="btn-passport secondary" id="btnCopyLink">ğŸ”— Copy Share Link</button>
            <div class="passport-shared" id="passportShared"></div>
          </div>
        </div>
      </div>

      <!-- SPEND RULES TEMPLATES -->
      <div class="section-title" data-i18n="sec_rules">Firewall Rules</div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:16px">
        <div style="font-size:16px;font-weight:800;margin-bottom:4px">ğŸ”’ Spend Limit Templates</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:18px">Apply a spending rule profile to minimize future exposure.</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px" id="ruleTemplates">
          <!-- rendered by JS -->
        </div>
      </div>


      <!-- â”€â”€ WALLET RELATIONS SECTION â”€â”€ -->
      <div id="fwRelSection" style="display:none">
        <div class="section-title" data-i18n="sec_relations">ğŸ”— Wallet Relations</div>
        <div class="rel-section-wrap">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:4px">
            <div>
              <div style="font-size:16px;font-weight:800;margin-bottom:4px" data-i18n="rel_title">Protocol &amp; Exchange Relationships</div>
              <div style="font-size:13px;color:var(--muted)">
                Detected interactions with known DEXes, CEXes, bridges &amp; protocols on <span id="fwRelNetLabel" style="color:var(--cyan);font-weight:700">â€”</span>.
              </div>
            </div>
            <div id="fwRelSummary" style="font-size:12px;color:var(--muted);text-align:right;line-height:1.6"></div>
          </div>
          <div id="fwRelContent"><div class="rel-loading">ğŸ” Analyzing wallet relationshipsâ€¦</div></div>
        </div>
      </div>

      <!-- â”€â”€ EXPORT SECTION â€” locked preview until full access â”€â”€ -->
      <div id="fwExportSection">
        <div class="section-title" data-i18n="sec_export">ğŸ“Š Export Report</div>
        <div class="fw-export-card fw-export-locked" id="fwExportCard">
          <div style="font-size:16px;font-weight:800;margin-bottom:4px">Download Scan Data</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:16px;line-height:1.65">
            Export your full approval &amp; relationship report for investigation, compliance, or record-keeping.
          </div>
          <!-- Buttons wrap â€” blurred when locked -->
          <div class="fw-export-btns-wrap">
            <div style="display:flex;gap:10px;flex-wrap:wrap;opacity:.45;align-items:center">
              <button class="fw-export-btn csv" id="fwBtnExportCSV" disabled>ğŸ“„ Export CSV</button>
              <button class="fw-export-btn json" id="fwBtnExportJSON" disabled>ğŸ—ƒ Export JSON</button>
              <button class="fw-export-btn copy" id="fwBtnCopyReport" disabled>ğŸ“‹ Copy Report</button>
            </div>
          </div>
          <!-- CTA shown when locked -->
          <div class="fw-export-unlock-cta" id="fwExportCTA">
            <div style="font-size:12px;color:var(--muted);margin-bottom:10px">
              ğŸ”’ Export requires <strong style="color:var(--cyan)">Full Access</strong> â€” hold 1 PASS token to unlock CSV, JSON &amp; report export.
            </div>
            <button class="btn-full-access" style="font-size:11px;padding:9px 20px" onclick="requestFullAccess()">
              ğŸ”‘ Unlock Export
            </button>
          </div>
          <div id="fwExportStatus" style="margin-top:12px;font-size:12px;color:var(--muted);min-height:18px;line-height:1.5;display:none;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07)"></div>
        </div>
      </div>


      <!-- â•â•â• WALLET WATCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="fwWatchSection">
        <div class="section-title" data-i18n="sec_watch">ğŸ‘ Wallet Watch</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:16px">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px">
            <div class="fw-watch-header-text">
              <div style="font-size:16px;font-weight:800;margin-bottom:4px" data-i18n="watch_title">Track Multiple Wallets</div>
              <div style="font-size:13px;color:var(--muted);line-height:1.6">Monitor scores across BSC, ETH &amp; Polygon. Each wallet scans individually and saves its score history. <span id="watchLimitLabel" data-i18n="watch_limit_label" style="color:var(--muted);font-size:11px">(Free: 2 wallets max â€” Unlock for up to 10)</span></div>
            </div>
            <div class="fw-watch-header-actions">
              <button class="fw-watch-submit" id="fwBtnScanAll" onclick="fwWatchScanAll()" style="background:rgba(93,255,178,.10);border-color:rgba(93,255,178,.3);color:var(--green)">â†» Scan All</button>
              <button class="fw-watch-submit" id="fwBtnEnableNotif" onclick="fwRequestNotifications()">ğŸ”” Alerts</button>
            </div>
          </div>
          <!-- Alert banner â€” shown when score drops on a watched wallet -->
          <div class="fw-alert-banner" id="fwAlertBanner">
            <div style="font-size:13px;font-weight:800;color:#ff7a8a;margin-bottom:4px" id="fwAlertTitle">âš  Score Drop Detected</div>
            <div style="font-size:12px;color:var(--muted)" id="fwAlertDesc"></div>
          </div>
          <!-- Watched wallets grid -->
          <div class="fw-watch-grid" id="fwWatchGrid">
            <div style="font-size:12px;color:var(--muted);grid-column:1/-1;padding:12px 0">No wallets watched yet. Add your first wallet below.</div>
          </div>
          <!-- Add wallet row -->
          <div class="fw-watch-add">
            <input class="fw-watch-input" id="fwWatchInput" placeholder="0x... wallet address" spellcheck="false" autocomplete="off">
            <select class="fw-watch-input" id="fwWatchNet" style="flex:0 0 auto;min-width:0;width:100px">
              <option value="bsc">BSC</option>
              <option value="eth">ETH</option>
              <option value="polygon">Polygon</option>
            </select>
            <button class="fw-watch-submit" id="fwWatchAddBtn" onclick="fwWatchAdd()">+ Watch</button>
          </div>
          <div class="fw-notif-row" id="fwNotifRow">
            <span class="fw-notif-icon">ğŸ””</span>
            <span class="fw-notif-text" id="fwNotifText">Enable browser alerts to get notified when a watched wallet's score drops below your threshold.</span>
            <button class="fw-notif-btn" id="fwNotifBtn" onclick="fwRequestNotifications()">Enable</button>
          </div>
          <!-- On-chain subscription â€” FULL ACCESS ONLY -->
          <div class="fw-notif-row" id="fwOnchainNotifRow" style="margin-top:8px;border-color:rgba(0,229,255,.18);background:rgba(0,229,255,.04)">
            <span class="fw-notif-icon">â›“</span>
            <div class="fw-notif-text">
              <strong style="color:var(--cyan)">On-chain approval monitor</strong> â€” 
              Sign a read-only subscription (no gas) to enable real-time Approval event monitoring for your wallet.
              <span id="fwOnchainStatus" style="display:block;margin-top:3px;font-size:10px;color:var(--muted)">Not subscribed</span>
            </div>
            <!-- shown/hidden by JS based on tier -->
            <button class="fw-notif-btn" id="fwOnchainBtn" onclick="fwSubscribeOnchain()" style="border-color:rgba(0,229,255,.3);color:var(--cyan);display:none">Subscribe</button>
            <button class="fw-notif-btn" id="fwOnchainLockBtn" onclick="requestFullAccess()" style="border-color:rgba(124,92,255,.3);color:#a87eff">ğŸ”’ Full Access</button>
          </div>
        </div>
      </div>

      <!-- â•â•â• THREAT FEED â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="fwThreatFeedSection">
        <div class="section-title" data-i18n="sec_threats">ğŸš¨ Threat Feed</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:16px">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px">
            <div>
              <div style="font-size:16px;font-weight:800;margin-bottom:4px">Recent Exploits & Threats</div>
              <div style="font-size:13px;color:var(--muted)">Known hacks, rug pulls and suspicious contracts across BSC, ETH & Polygon. <span id="fwThreatAffectedBadge" style="display:none;color:#ff7a8a;font-weight:800"></span></div>
            </div>
            <div style="font-size:11px;color:var(--muted);text-align:right">Updated Feb 2026</div>
          </div>
          <div id="fwThreatList"></div>
        </div>
      </div>

      <!-- â•â•â• PUBLIC API â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="fwApiSection">
        <div class="section-title" data-i18n="sec_api">ğŸ”Œ Developer API</div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:32px 22px;margin-bottom:16px;text-align:center">
          <div style="font-size:28px;margin-bottom:10px">ğŸš§</div>
          <div style="font-size:16px;font-weight:800;margin-bottom:6px">Coming Soon</div>
          <div style="font-size:13px;color:var(--muted);line-height:1.65;max-width:360px;margin:0 auto">
            The CycleX Public API is under development â€” score lookups, approval lists, and passport verification will be available soon. Stay tuned.
          </div>
        </div>
      </div>

    </div><!-- end #dashboard -->
  </main>

  <footer class="footer">
    <div>
      <span class="footer-brand">CycleX Firewall</span>
      <span style="margin:0 8px;opacity:.35">Â·</span>
      <span>Wallet Protection Tool</span>
    </div>
    <div class="footer-note">
      Informational only. No signatures. No transactions. Always verify contracts independently.
      All revoke actions happen on-chain directly from this site.
    </div>
  </footer>

</div><!-- .page-shell -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CycleX Firewall â€” LIVE ENGINE v2.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMO_WALLET = "0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD";
const CYCX_BSC    = "0xda63b65825AE30532a507B0C091B0bD9F8204F7E";
const PASS_BSC    = "0x718bc4E915fF66249C1eB86Eb566Ce4fefCA801e";
const CYCX_MIN    = 100n;   // minimum CYCX
const PASS_MIN    = 1n;     // minimum PASS
const API_BASE    = window.CYCLEX_API_BASE || location.origin;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WALLET RELATIONS ENGINE â€” Tagged Entities (90+ protocols)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var FW_TAGGED_ENTITIES = {
  eth: {
    // CEX
    "0x28c6c06298d514db089934071355e5743bf21d60": {name:"Binance 14",       type:"cex",     tags:["trusted"]},
    "0x21a31ee1afc51d94c2efccaa2092ad1028285549": {name:"Binance 15",       type:"cex",     tags:["trusted"]},
    "0x5a52e96bacdabb82fd05763e25335261b270efcb": {name:"Binance 16",       type:"cex",     tags:["trusted"]},
    "0x267be1c1d684f78cb4f6a176c4911b741e4ffdc0": {name:"Kraken Hot",       type:"cex",     tags:["trusted"]},
    "0xe853c56864a2ebe4576a807d26fdc4a0ada51919": {name:"Kraken 2",         type:"cex",     tags:["trusted"]},
    "0x503828976d22510aad0201ac7ec88293211d23da": {name:"Coinbase Hot",     type:"cex",     tags:["trusted"]},
    "0xa9d1e08c7793af67e9d92fe308d5697fb81d3e43": {name:"Coinbase 2",       type:"cex",     tags:["trusted"]},
    "0xa7efae728d2936e78bda97dc267687568dd593f3": {name:"OKX",              type:"cex",     tags:["trusted"]},
    "0x98ec059dc3adfbdd63429454aeb0c990fba4a128": {name:"OKX 2",            type:"cex",     tags:["trusted"]},
    "0xfe24cdd8648121a43a7c86d289be4dd2951ed49f": {name:"Gemini",           type:"cex",     tags:["trusted"]},
    "0xf89d7b9c864f589bbf53a82105107622b35eaa40": {name:"Bybit",            type:"cex",     tags:["trusted"]},
    "0x1151314c646ce4e0efd76d1af4760ae66a9fe30f": {name:"Bitfinex",         type:"cex",     tags:["trusted"]},
    "0x2b5634c42055806a59e9107ed44d43c426e58258": {name:"KuCoin",           type:"cex",     tags:["trusted"]},
    "0x4c6007e38ce164ed80ff8ff94192225fcdac1b9" : {name:"Huobi ETH",        type:"cex",     tags:["trusted"]},
    "0x46705dfff24256421a05d056c29e81bdc09723b8": {name:"Crypto.com ETH",   type:"cex",     tags:["trusted"]},
    // DEX / Aggregator
    "0x7a250d5630b4cf539739df2c5dacb4c659f2488d": {name:"Uniswap V2 Router",       type:"dex",  tags:["verified","defi"]},
    "0xe592427a0aece92de3edee1f18e0157c05861564": {name:"Uniswap V3 Router",       type:"dex",  tags:["verified","defi"]},
    "0x68b3465833fb72a70ecdf485e0e4c7bd8665fc45": {name:"Uniswap Universal Router", type:"dex", tags:["verified","defi"]},
    "0x1111111254eeb25477b68fb85ed929f73a960582": {name:"1inch V5",                type:"dex",  tags:["aggregator","defi"]},
    "0x1111111254fb6c44bac0bed2854e76f90643097d": {name:"1inch V4",                type:"dex",  tags:["aggregator","defi"]},
    "0x111111125421ca6dc452d289314280a0f8842a65": {name:"1inch V6",                type:"dex",  tags:["aggregator","defi"]},
    "0xd9e1ce17f2641f24ae83637ab66a2cca9c378b9f": {name:"SushiSwap Router",        type:"dex",  tags:["verified","defi"]},
    "0xdef1c0ded9bec7f1a1670819833240f027b25eff": {name:"0x Exchange Proxy",       type:"dex",  tags:["aggregator","defi"]},
    "0xba12222222228d8ba445958a75a0704d566bf2c8": {name:"Balancer Vault",           type:"dex",  tags:["verified","defi"]},
    "0xe66b31678d6c16e9ebf358268a790b763c133750": {name:"0x Settler",              type:"dex",  tags:["aggregator","defi"]},
    "0x3fc91a3afd70395cd496c647d5a6cc9d4b2b7fad": {name:"Uniswap Universal Router 2",type:"dex",tags:["verified","defi"]},
    // Lending
    "0x3d9819210a31b4961b30ef54be2aed79b9c9cd3b": {name:"Compound",         type:"lending", tags:["verified","defi"]},
    "0x7d2768de32b0b80b7a3454c06bdac94a69ddc7a9": {name:"Aave V2",          type:"lending", tags:["verified","defi"]},
    "0x87870bca3f3fd6335c3f4ce8392d69350b4fa4e2": {name:"Aave V3",          type:"lending", tags:["verified","defi"]},
    "0x397ff1542f962076d0bfe58ea045ffa2d347aca0": {name:"SushiSwap Lending",type:"lending", tags:["defi"]},
    // Staking / LST
    "0x00000000219ab540356cbb839cbe05303d7705fa": {name:"ETH2 Deposit",      type:"staking", tags:["verified"]},
    "0xae7ab96520de3a18e5e111b5eaab095312d7fe84": {name:"Lido stETH",        type:"staking", tags:["verified","defi"]},
    "0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0": {name:"Lido wstETH",       type:"staking", tags:["verified","defi"]},
    "0xa35b1b31ce002fbf2058d22f30f95d405200a15b": {name:"StakeWise",         type:"staking", tags:["defi"]},
    // Bridges
    "0x99c9fc46f92e8a1c0dec1b1747d010903e884be1": {name:"Optimism Bridge",   type:"bridge",  tags:["verified"]},
    "0x4dbd4fc535ac27206064b68ffcf827b0a60bab3f": {name:"Arbitrum Bridge",   type:"bridge",  tags:["verified"]},
    "0x40ec5b33f54e0e8a33a975908c5ba1c14e5bbbdf": {name:"Polygon Bridge",    type:"bridge",  tags:["verified"]},
    "0x3154cf16ccdb4c6d922629664174b904d80f2c35": {name:"Stargate ETH",      type:"bridge",  tags:["trusted"]},
    "0xc564ee9f21ed8a2d8e7e76c085740d5e4c5fafbe": {name:"Multichain ETH",    type:"bridge",  tags:["trusted"]},
  },
  bsc: {
    // CEX
    "0x8894e0a0c962cb723c1976a4421c95949be2d4e3": {name:"Binance BSC Hot",   type:"cex",     tags:["trusted"]},
    "0x3f5ce5fbfe3e9af3971dd833d26ba9b5c936f0be": {name:"Binance Cold",      type:"cex",     tags:["trusted"]},
    "0x21d45650db732ce5df77685d6021d7d5d1da807b": {name:"Binance BSC 2",     type:"cex",     tags:["trusted"]},
    "0x1fbe2acee135d991592f167ac371f3dd893a508b": {name:"KuCoin BSC",        type:"cex",     tags:["trusted"]},
    "0x6f31d347457962c9811ff9537428707a6c9f6d46": {name:"Gate.io BSC",       type:"cex",     tags:["trusted"]},
    "0x0d0707963952f2fba59dd06f2b425ace40b492fe": {name:"Huobi BSC",         type:"cex",     tags:["trusted"]},
    "0xd8f0af0c27e84adb4adb1c3d15bf89e4ea2e57f3": {name:"OKX BSC",           type:"cex",     tags:["trusted"]},
    "0xa180fe01b906a1be37be6c534a3300785b20d947": {name:"Crypto.com BSC",    type:"cex",     tags:["trusted"]},
    "0x1c954e8fe737f99f68fa1ccda3e51ebdb291948c": {name:"Bybit BSC",         type:"cex",     tags:["trusted"]},
    "0x2354ef4df11afacb85a5c7f98b624072ec3428f5": {name:"Binance BSC 3",     type:"cex",     tags:["trusted"]},
    // DEX
    "0x10ed43c718714eb63d5aa57b78b54704e256024e": {name:"PancakeSwap V2",    type:"dex",     tags:["verified","defi"]},
    "0x13f4ea83d0bd40e75c8222255bc855a974568dd4": {name:"PancakeSwap V3",    type:"dex",     tags:["verified","defi"]},
    "0xd99d1c33f9fc3444f8101754abc46c52416550d1": {name:"PancakeSwap Testnet",type:"dex",    tags:["defi"]},
    "0x1b02da8cb0d097eb8d57a175b88c7d8b47997506": {name:"SushiSwap BSC",     type:"dex",     tags:["verified","defi"]},
    "0x1111111254eeb25477b68fb85ed929f73a960582": {name:"1inch V5 BSC",      type:"dex",     tags:["aggregator","defi"]},
    "0x1111111254fb6c44bac0bed2854e76f90643097d": {name:"1inch V4 BSC",      type:"dex",     tags:["aggregator","defi"]},
    "0x111111125421ca6dc452d289314280a0f8842a65": {name:"1inch V6 BSC",      type:"dex",     tags:["aggregator","defi"]},
    "0xdef1c0ded9bec7f1a1670819833240f027b25eff": {name:"0x BSC",            type:"dex",     tags:["aggregator","defi"]},
    "0x0bf68e4a1c3b5dbbab4f11b5b9a71af24278bc3d": {name:"ApeSwap Router",    type:"dex",     tags:["defi"]},
    "0xcf0febd3f17cef5b47b0cd257acf6025c5bff3b7": {name:"ApeSwap V2",        type:"dex",     tags:["defi"]},
    "0x4f3afec4e5a3f2a6a1a411def7d7dfe50ee057bf": {name:"DODO BSC",          type:"dex",     tags:["defi"]},
    "0xba12222222228d8ba445958a75a0704d566bf2c8": {name:"Balancer BSC",       type:"dex",     tags:["verified","defi"]},
    "0x05ff2b0db69458a0750badebc4f9e13add608c7f": {name:"PancakeSwap V1",    type:"dex",     tags:["defi"]},
    // Lending
    "0xd41b24bba51fac0e4827b6f94c0d6ddeb183cd64": {name:"Venus Protocol",    type:"lending", tags:["verified","defi"]},
    "0xfd36e2c2a6789db23113685031d7f16329158384": {name:"Venus Unitroller",   type:"lending", tags:["verified","defi"]},
    // Bridges
    "0xf0b456250dc9990662a6f25808cc74a6d1131ea9": {name:"Multichain BSC",    type:"bridge",  tags:["trusted"]},
    "0xac98d8d1bb07d04f7e4e015f09bd2f1cb0c13ca1": {name:"Stargate BSC",      type:"bridge",  tags:["trusted"]},
    "0xf3c091ed43de9c270593445163a41a876a0bb3dd": {name:"cBridge BSC",       type:"bridge",  tags:["trusted"]},
    "0x22f9dcf4647084d6c31b2765f6910cd85c178c18": {name:"Wormhole BSC",      type:"bridge",  tags:["trusted"]},
  },
  polygon: {
    // CEX
    "0xf977814e90da44bfa03b6295a0616a897441acec": {name:"Binance Polygon",   type:"cex",     tags:["trusted"]},
    "0xe7804c37c13166ff0b37f5ae0bb07a3aebb6e245": {name:"Binance Polygon 2", type:"cex",     tags:["trusted"]},
    "0x0d0707963952f2fba59dd06f2b425ace40b492fe": {name:"Huobi Polygon",     type:"cex",     tags:["trusted"]},
    "0xb0b0f6a5f048a4b62966a1e5b3555f98c4b9c69b": {name:"OKX Polygon",       type:"cex",     tags:["trusted"]},
    // DEX
    "0xa5e0829caced8ffdd4de3c43696c57f7d7a678ff": {name:"QuickSwap Router",  type:"dex",     tags:["verified","defi"]},
    "0xf5b509bb0909a69b1c207e495f687a596c168e12": {name:"QuickSwap V3",      type:"dex",     tags:["verified","defi"]},
    "0x1b02da8cb0d097eb8d57a175b88c7d8b47997506": {name:"SushiSwap Polygon", type:"dex",     tags:["verified","defi"]},
    "0x1111111254eeb25477b68fb85ed929f73a960582": {name:"1inch V5 Polygon",  type:"dex",     tags:["aggregator","defi"]},
    "0x111111125421ca6dc452d289314280a0f8842a65": {name:"1inch V6 Polygon",  type:"dex",     tags:["aggregator","defi"]},
    "0xe592427a0aece92de3edee1f18e0157c05861564": {name:"Uniswap V3 Polygon",type:"dex",     tags:["verified","defi"]},
    "0x68b3465833fb72a70ecdf485e0e4c7bd8665fc45": {name:"Uniswap Universal Polygon",type:"dex",tags:["verified","defi"]},
    "0xba12222222228d8ba445958a75a0704d566bf2c8": {name:"Balancer Polygon",   type:"dex",     tags:["verified","defi"]},
    "0xdef1c0ded9bec7f1a1670819833240f027b25eff": {name:"0x Polygon",        type:"dex",     tags:["aggregator","defi"]},
    "0x4c60051384bd2d3c01bfc845cf5f4b44bcbe9de5": {name:"ParaSwap Polygon",  type:"dex",     tags:["aggregator","defi"]},
    "0x35ec0f4d81f4e1edd5abb58688c6b34a15fd7e8b": {name:"Gamma Strategies",  type:"dex",     tags:["defi"]},
    // Lending
    "0x8dff5e27ea6b7ac08ebfdf9eb090f32ee9a30fcf": {name:"Aave V2 Polygon",   type:"lending", tags:["verified","defi"]},
    "0x794a61358d6845594f94dc1db02a252b5b4814ad": {name:"Aave V3 Polygon",   type:"lending", tags:["verified","defi"]},
    // Bridges
    "0xa0c68c638235ee32657e8f720a23cec1bfc77c77": {name:"Polygon Bridge",    type:"bridge",  tags:["verified"]},
    "0xfe5e5d361b2ad62c541bab87c45a0b9b018389a2": {name:"Polygon PoS Bridge",type:"bridge",  tags:["verified"]},
    "0x45a01e4e04f14f7a4a6702c74187c5f6222033cd": {name:"Stargate Polygon",  type:"bridge",  tags:["trusted"]},
    "0xf3c091ed43de9c270593445163a41a876a0bb3dd": {name:"cBridge Polygon",   type:"bridge",  tags:["trusted"]},
  }
};

// â”€â”€ MULTI-CHAIN CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var FW_CHAINS = {
  bsc: {
    chainId:"0x38", name:"BNB Smart Chain",
    nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},
    rpcUrls:["https://bsc-rpc.publicnode.com","https://bsc-dataseed.binance.org/","https://rpc.ankr.com/bsc","https://1rpc.io/bnb"],
    blockExplorerUrls:["https://bscscan.com/"],
    explorerTx: h=>`https://bscscan.com/tx/${h}`
  },
  eth: {
    chainId:"0x1", name:"Ethereum",
    nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},
    rpcUrls:["https://eth.llamarpc.com","https://rpc.ankr.com/eth","https://cloudflare-eth.com","https://ethereum.publicnode.com","https://1rpc.io/eth"],
    blockExplorerUrls:["https://etherscan.io/"],
    explorerTx: h=>`https://etherscan.io/tx/${h}`
  },
polygon: {
    chainId:"0x89", name:"Polygon",
    nativeCurrency:{name:"MATIC",symbol:"MATIC",decimals:18},
   rpcUrls:[
  "https://polygon.publicnode.com",
  "https://1rpc.io/matic",
  "https://polygon-bor-rpc.publicnode.com"
],
    blockExplorerUrls:["https://polygonscan.com/"],
    explorerTx: h=>`https://polygonscan.com/tx/${h}`
  }
};
// â”€â”€ ENSURE CHAIN (multi-network aware) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwEnsureChain(net, provider) {
  const chain = FW_CHAINS[net];
  if (!chain || !provider) return false;
  try {
    const current = await provider.request({method:"eth_chainId"});
    if (current === chain.chainId) return true;
    try {
      await provider.request({method:"wallet_switchEthereumChain",params:[{chainId:chain.chainId}]});
      return true;
    } catch(se) {
      if (Number(se?.code) === 4902) {
        await provider.request({method:"wallet_addEthereumChain",params:[{
          chainId:chain.chainId, chainName:chain.name,
          nativeCurrency:chain.nativeCurrency,
          rpcUrls:chain.rpcUrls, blockExplorerUrls:chain.blockExplorerUrls
        }]});
        return true;
      }
    }
    return false;
  } catch { return false; }
}
window.fwEnsureChain = fwEnsureChain;

// â”€â”€ FETCH WALLET TX HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwFetchWalletTxs(net, address) {
  try {
    const u = new URL("/api/getWalletTxs", API_BASE);
    u.searchParams.set("net", net);
    u.searchParams.set("address", address);
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), 14000);
    try {
      const res = await fetch(u.toString(), {method:"GET", signal:ctrl.signal});
      if (!res.ok) return [];
      const data = await res.json();
      return Array.isArray(data) ? data : (data?.result || data?.data || []);
    } finally { clearTimeout(timer); }
  } catch { return []; }
}

// â”€â”€ ANALYSE RELATIONSHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwAnalyzeRelations(net, walletAddr, txs) {
  const tagged = FW_TAGGED_ENTITIES[net] || {};
  const map = {};
  const walletNorm = (walletAddr||"").toLowerCase().trim();

  for (const tx of txs) {
    const from = (tx.from||"").toLowerCase().trim();
    const to   = (tx.to||"").toLowerCase().trim();
    const ts   = Number(tx.timeStamp||tx.timestamp||0) * 1000;
    if (!from || !to) continue;

    let addr=null, dir=null;
    if (from===walletNorm && tagged[to])   { addr=to;   dir="out"; }
    else if (to===walletNorm && tagged[from]) { addr=from; dir="in";  }
    if (!addr) continue;

    if (!map[addr]) map[addr]={
      entity:tagged[addr], address:addr, in:0, out:0, txs:[],
      firstSeen:ts||Date.now(), lastSeen:ts||Date.now()
    };
    const r=map[addr];
    r[dir]++;
    if (ts){r.firstSeen=Math.min(r.firstSeen,ts);r.lastSeen=Math.max(r.lastSeen,ts);}
    if (r.txs.length<25) r.txs.push({hash:tx.hash,dir,ts,value:tx.value||"0"});
  }
  return Object.values(map).sort((a,b)=>(b.in+b.out)-(a.in+a.out));
}

// â”€â”€ RENDER RELATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwRenderRelations(net, relations) {
  const section  = document.getElementById("fwRelSection");
  const content  = document.getElementById("fwRelContent");
  const netLabel = document.getElementById("fwRelNetLabel");
  const summary  = document.getElementById("fwRelSummary");
  if (!section||!content) return;

  if (netLabel) netLabel.textContent = FW_CHAINS[net]?.name || net.toUpperCase();

  // Always reset summary first â€” prevents stale data from previous scans
  if (summary) summary.innerHTML = "";

  if (!relations.length) {
    content.innerHTML = `
      <div class="rel-empty" style="padding:20px;text-align:center">
        <div style="font-size:28px;margin-bottom:10px">ğŸ”</div>
        <div style="font-weight:700;font-size:14px;color:var(--text);margin-bottom:6px">No protocol interactions detected</div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6">
          No interactions found with known DEXes, CEXes or bridges on ${FW_CHAINS[net]?.name||net.toUpperCase()}.
        </div>
      </div>`;
    section.style.display = "block";
    return;
  }

  // Summary stats
  const cexCount = relations.filter(r=>r.entity.type==="cex").length;
  const dexCount = relations.filter(r=>r.entity.type==="dex").length;
  const brCount  = relations.filter(r=>r.entity.type==="bridge").length;
  const totalTxs = relations.reduce((s,r)=>s+r.in+r.out, 0);
  if (summary) summary.innerHTML = `
    <span style="color:var(--green)">ğŸ¦ ${cexCount} exchanges</span> &nbsp;Â·&nbsp;
    <span style="color:var(--cyan)">âš¡ ${dexCount} DEXes</span> &nbsp;Â·&nbsp;
    <span style="color:#a87eff">ğŸŒ‰ ${brCount} bridges</span><br>
    <span style="color:var(--muted)">${totalTxs} detected interactions</span>
  `;

  const TYPE_EMOJI = {cex:"ğŸ¦",dex:"âš¡",bridge:"ğŸŒ‰",lending:"ğŸ’°",staking:"ğŸ¥©",oracle:"ğŸ”®",util:"ğŸ”§"};

  // isDemo check based on current wallet â€” isDemo is only in runLoadSequence scope
  const _isRelDemo = fwWallet === DEMO_WALLET;
  // Full access: can view timeline. Free tier: sees locked button
  const _canTimeline = (fwAccessTier === "full" && _fwAccessVerified) || _isRelDemo;

  const cards = relations.map((rel, idx) => {
    const e = rel.entity;
    const total    = rel.in + rel.out;
    const lastDate = rel.lastSeen ? new Date(rel.lastSeen).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}) : "â€”";
    const inColor  = rel.in  > 0 ? "#5dffb2"    : "var(--muted)";
    const outColor = rel.out > 0 ? "#ff9a6b"    : "var(--muted)";
    const typeClass= {cex:"cex",dex:"dex",bridge:"bridge",lending:"lending",staking:"staking"}[e.type]||"dex";
    const tags     = (e.tags||[]).map(t=>`<span class="rel-tag ${t}">${t}</span>`).join("");

    // Full access + has txs â†’ "View N transactions"
    // Full access + no txs  â†’ nothing (e.g. demo wallet with real full access)
    // Free tier or demo     â†’ locked button on every card (teases the feature)
    // Only count real tx hashes (66-char hex) â€” ignore demo placeholders
    const isRealHash = h => typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h);
    const realTxCount = (rel.txs || []).filter(tx => isRealHash(tx.hash)).length;
    const timelineBtn = (_canTimeline && !_isRelDemo)
      ? (realTxCount > 0
          ? `<button class="rel-timeline-btn" onclick="fwShowTimeline(${idx})">View ${realTxCount} transactions â†—</button>`
          : "")
      : `<button class="rel-timeline-btn" style="opacity:.65;border-color:rgba(124,92,255,.3);color:#a87eff" onclick="requestFullAccess()">ğŸ”’ Unlock to view transactions</button>`;

    return `
    <div class="rel-card ${typeClass}">
      <div class="rel-card-body">
        <div class="rel-entity-name">${TYPE_EMOJI[e.type]||"ğŸ”—"} ${esc(e.name)}</div>
        <div class="rel-tags">${tags}</div>
        <div class="rel-stats-row">
          <div class="rel-stat"><div class="rel-stat-val" style="color:${inColor}">${rel.in}</div><div class="rel-stat-key">Received</div></div>
          <div class="rel-stat"><div class="rel-stat-val" style="color:${outColor}">${rel.out}</div><div class="rel-stat-key">Sent</div></div>
          <div class="rel-stat"><div class="rel-stat-val">${total}</div><div class="rel-stat-key">Total</div></div>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-bottom:8px">Last: ${lastDate}</div>
      </div>
      ${timelineBtn}
    </div>`;
  }).join("");

  // Show teaser banner for: free tier with real wallet, OR demo mode
  // Both cases: user cannot view real transaction history
  let teaserHtml = "";
  const _showTeaser = _isRelDemo || (!_canTimeline);
  if (_showTeaser) {
    const teaserMsg = _isRelDemo
      ? "Connect your wallet &amp; unlock Full Access to see your real protocol interactions."
      : "Protocol names &amp; counts visible. Unlock Full Access to view transaction history.";
    teaserHtml = `<div style="padding:10px 14px;border-radius:12px;margin-bottom:12px;
      background:rgba(124,92,255,.07);border:1px solid rgba(124,92,255,.2);
      display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <span style="font-size:12px;color:var(--muted);flex:1">
        ğŸ”’ <strong style="color:var(--text)">Wallet Relations</strong> â€” ${teaserMsg}
      </span>
      <button class="fw-watch-submit" style="font-size:10px;padding:6px 14px" onclick="requestFullAccess()">Unlock</button>
    </div>`;
  }

  content.innerHTML = teaserHtml + `<div class="rel-grid">${cards}</div>`;
  section.style.display = "block";
  window.__fwRelations  = relations;
}

// â”€â”€ TIMELINE VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.fwShowTimeline = function(idx) {
  const rel = window.__fwRelations?.[idx];
  if (!rel) return;
  const modal = document.getElementById("fwTimelineModal");
  const title = document.getElementById("fwTmTitle");
  const body  = document.getElementById("fwTmBody");
  if (!modal) return;
  const explorer = FW_CHAINS[fwNet]?.explorerTx || (h=>`#`);
  // Only show real tx hashes (must be 66-char 0x-prefixed hex)
  const isRealHash = h => typeof h === "string" && /^0x[0-9a-fA-F]{64}$/.test(h);
  const realTxs = (rel.txs || []).filter(tx => isRealHash(tx.hash));
  title.textContent = `${rel.entity.name} â€” ${rel.in+rel.out} interactions`;
  body.innerHTML = realTxs.length ? realTxs.map(tx=>{
    const d = tx.ts ? new Date(tx.ts).toLocaleString() : "â€”";
    const dirLabel = tx.dir==="in"?"â¬… INCOMING":"â¡ OUTGOING";
    const dirColor = tx.dir==="in"?"#5dffb2":"#ff9a6b";
    const shortHash = tx.hash.slice(0,10)+"â€¦"+tx.hash.slice(-8);
    return `<div class="tm-entry ${tx.dir}">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px">
        <strong style="color:${dirColor}">${dirLabel}</strong>
        <span style="font-size:10px;color:var(--muted)">${d}</span>
      </div>
      <div class="tm-hash">
        <a href="${explorer(tx.hash)}" target="_blank" rel="noopener" style="color:var(--cyan);text-decoration:none">${shortHash}</a>
      </div>
    </div>`;
  }).join("") : `<div class="rel-empty">Transaction details not available for this wallet.</div>`;
  modal.style.display="flex";
};

// Close timeline on backdrop
document.getElementById("fwTimelineModal")?.addEventListener("click", e=>{
  if (e.target.id==="fwTimelineModal") e.target.style.display="none";
});

// â”€â”€ EXPORT FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwSetExportStatus(msg, color) {
  const el = document.getElementById("fwExportStatus");
  if (el){el.textContent=msg;el.style.color=color||"var(--muted)";}
}

window.fwExportCSV = function() {
  if (!fwScanData?.rows?.length){fwSetExportStatus("âš  Run a scan first.","#ffd166");return;}
  const q = v=>`"${String(v??"").replace(/"/g,'""')}"`;
  let csv = "Wallet,Network,Token Address,Symbol,Spender,Allowance,Risk,Verified,Decimals\n";
  for(const r of fwScanData.rows){
    csv += [q(fwWallet),q(fwNet),q(r.token),q(r.symbol),q(r.spender),q(r.allow),q(r.risk),q(r.verified),q(r.decimals)].join(",")+"\n";
  }
  if (window.__fwRelations?.length) {
    csv += "\n\nWALLET RELATIONS\nEntity,Type,Tags,Protocol Address,Incoming,Outgoing,Total,First Seen,Last Seen,Recent Tx Hashes\n";
    for(const rel of window.__fwRelations){
      const fd = rel.firstSeen ? new Date(rel.firstSeen).toLocaleDateString() : "â€”";
      const ld = rel.lastSeen  ? new Date(rel.lastSeen).toLocaleDateString()  : "â€”";
      const tags = (rel.entity.tags||[]).join("|");
      const hashes = rel.txs.slice(0,5).map(t=>t.hash||"").filter(Boolean).join(" | ");
      csv += [q(rel.entity.name),q(rel.entity.type),q(tags),q(rel.address||""),
              q(rel.in),q(rel.out),q(rel.in+rel.out),q(fd),q(ld),q(hashes)].join(",")+"\n";
    }
  }
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href=url; a.download=`CycleX-Firewall-${fwNet}-${new Date().toISOString().slice(0,10)}.csv`;
  a.click(); URL.revokeObjectURL(url);
  fwSetExportStatus("âœ… CSV exported!","#5dffb2");
};

window.fwExportJSON = function() {
  if (!fwScanData?.rows?.length){fwSetExportStatus("âš  Run a scan first.","#ffd166");return;}
  const payload = {
    exported: new Date().toISOString(),
    wallet: fwWallet, network: fwNet,
    score: fwScanData.score, scoreLabel: fwScanData.scoreLabel,
    summary: {
      totalApprovals:fwScanData.totalApprovals,
      unlimited:fwScanData.unlimitedCount,
      highRisk:fwScanData.highRiskCount,
      unverified:fwScanData.unverifiedCount
    },
    approvals: fwScanData.rows.map(r=>({
      token:r.token, symbol:r.symbol, spender:r.spender,
      allowance:r.allow, risk:r.risk, verified:r.verified, decimals:r.decimals
    })),
    walletRelations: (window.__fwRelations||[]).map(rel=>{
      // Cross-reference with threat feed
      const relLower = (rel.address||"").toLowerCase();
      const matchedThreat = (typeof FW_THREATS!=="undefined") ?
        FW_THREATS.find(t=>t.spenders.some(s=>s.toLowerCase()===relLower)) : null;
      return {
        entity: rel.entity.name,
        type:   rel.entity.type,
        address: rel.address,
        tags:   rel.entity.tags,
        incomingTxs:  rel.in,
        outgoingTxs:  rel.out,
        totalTxs:     rel.in+rel.out,
        firstSeen: rel.firstSeen ? new Date(rel.firstSeen).toISOString() : null,
        lastSeen:  rel.lastSeen  ? new Date(rel.lastSeen).toISOString()  : null,
        recentTxHashes: rel.txs.slice(0,10).map(t=>t.hash).filter(Boolean),
        threatAlert: matchedThreat ? {
          threat: matchedThreat.title,
          severity: matchedThreat.severity,
          date: matchedThreat.date,
          link: matchedThreat.link
        } : null
      };
    }),
    threatCrossReference: (typeof FW_THREATS!=="undefined") ? FW_THREATS.filter(t=>
      t.spenders.some(s=>(fwScanData?.rows||[]).some(r=>
        (r.spender||"").toLowerCase()===s.toLowerCase()
      ))
    ).map(t=>({title:t.title,severity:t.severity,date:t.date,chains:t.chains})) : []
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json;charset=utf-8;"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href=url; a.download=`CycleX-Firewall-${fwNet}-${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(url);
  fwSetExportStatus("âœ… JSON exported!","#5dffb2");
};

window.fwCopyReport = function() {
  if (!fwScanData){fwSetExportStatus("âš  Run a scan first.","#ffd166");return;}
  const d = fwScanData;
  const rels = (window.__fwRelations||[]).slice(0,8).map(r=>`  ${r.entity.type.toUpperCase()}: ${r.entity.name} (${r.in+r.out} txs)`).join("\n");
  const threats = (d.threats||[]).slice(0,3).map(t=>`  - ${t.name}: ${t.label}`).join("\n");
  const text = `=== CycleX Firewall Report ===
Date:    ${new Date().toLocaleString()}
Wallet:  ${fwWallet}
Network: ${fwNet.toUpperCase()}

SCORE:   ${d.score}/100 (${d.scoreLabel})
BLAST:   ${d.blastDisplay}
DRAIN:   ${d.drainTime}

APPROVALS: ${d.totalApprovals} total | ${d.unlimitedCount} unlimited | ${d.highRiskCount} high-risk

TOP THREATS:
${threats||"  None detected"}

${rels?"WALLET RELATIONS:\n"+rels+"\n":""}
Scan your wallet: https://cyclex.io/firewall
`;
  navigator.clipboard.writeText(text)
    .then(()=>fwSetExportStatus("âœ… Report copied to clipboard!","#5dffb2"))
    .catch(()=>fwSetExportStatus("Copy failed â€” use CSV/JSON export instead.","#ffd166"));
};

// â”€â”€ EXPORT + RELATIONS VISIBILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwUpdateExportVisibility() {
  const sec  = document.getElementById("fwExportSection");
  const card = document.getElementById("fwExportCard");
  const cta  = document.getElementById("fwExportCTA");
  const stat = document.getElementById("fwExportStatus");
  if (!sec) return;

  // Always visible once scan has run (show as teaser in free tier)
  sec.classList.add("fw-visible");

  if (fwAccessTier === "full") {
    // Unlocked: remove blur/lock, enable buttons
    card?.classList.remove("fw-export-locked");
    if (cta)  cta.style.display  = "none";
    if (stat) stat.style.display = "block";
    // Enable buttons
    ["fwBtnExportCSV","fwBtnExportJSON","fwBtnCopyReport"].forEach(id => {
      const btn = document.getElementById(id);
      if (btn) { btn.disabled = false; btn.parentElement.style.opacity = "1"; }
    });
    // Bind events
    fwInitExport();
  } else {
    // Locked: show CTA, keep blur
    card?.classList.add("fw-export-locked");
    if (cta)  cta.style.display  = "block";
    if (stat) stat.style.display = "none";
  }
}

// â”€â”€ INIT EXPORT BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwInitExport() {
  const csvBtn  = document.getElementById("fwBtnExportCSV");
  const jsonBtn = document.getElementById("fwBtnExportJSON");
  const copyBtn = document.getElementById("fwBtnCopyReport");
  if (csvBtn  && !csvBtn.__fwBound)  { csvBtn.addEventListener("click",  window.fwExportCSV);    csvBtn.__fwBound=true; }
  if (jsonBtn && !jsonBtn.__fwBound) { jsonBtn.addEventListener("click",  window.fwExportJSON);   jsonBtn.__fwBound=true; }
  if (copyBtn && !copyBtn.__fwBound) { copyBtn.addEventListener("click",  window.fwCopyReport);   copyBtn.__fwBound=true; }
}


const GATE_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
const ERC20_APPROVE_ABI = ["function approve(address spender, uint256 amount) returns (bool)"];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fwAccessTier   = "free";      // "free" | "full"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANTI-TAMPER SECURITY ENGINE
// Prevents console-based bypass of access gate (PASS check)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 1. One-time nonce â€” required by unlockFull() to prove call came
//    from the legitimate check flow, not the console.
const _fwNonce = (() => {
  const arr = new Uint8Array(24);
  crypto.getRandomValues(arr);
  return Array.from(arr, b => b.toString(16).padStart(2,'0')).join('');
})();

// 2. Verified state â€” stored in closure, NOT on window
let _fwAccessVerified = false;
let _fwValidatedWallet = null;

// 3. Protect fwAccessTier via Object.defineProperty â€” block direct assignment
(function protectAccessTier() {
  let _tier = "free";
  try {
    Object.defineProperty(window, "fwAccessTier", {
      get: () => _tier,
      set: (v) => {
        // Only allow setting to "full" if internal verification passed
        if (v === "full" && !_fwAccessVerified) {
          console.warn("[CycleX] Access tier change blocked. Connect a wallet with PASS to unlock.");
          return;
        }
        _tier = v;
      },
      configurable: false
    });
  } catch(e) {
    // If defineProperty fails (e.g. already defined), just leave as-is
  }
})();

// 4. Override unlockFull to require nonce â€” direct console call won't work
const _unlockFull_real = function(nonce) {
  if (nonce !== _fwNonce) {
    console.warn("[CycleX] Unauthorized unlock attempt blocked.");
    return false;
  }
  _fwAccessVerified = true;
  // Set the lexical let variable directly â€” this is what ALL checks use.
  // Object.defineProperty on window.fwAccessTier is a separate binding
  // and does NOT update the let variable referenced inside the script.
  fwAccessTier = "full";
  // Also set window property for external code consistency
  try {
    const desc = Object.getOwnPropertyDescriptor(window, "fwAccessTier");
    if (desc?.set) desc.set("full");
  } catch {}
  // Perform actual unlock UI
  _doUnlockUI();
  return true;
};

// 5. UI unlock (separated from guard) â€” called only by _unlockFull_real
function _doUnlockUI() {
  document.getElementById("accessGateOverlay")?.style && (document.getElementById("accessGateOverlay").style.display = "none");
  document.getElementById("tierBadge") && (document.getElementById("tierBadge").style.display = "flex");
  document.getElementById("btnTopAccess") && (document.getElementById("btnTopAccess").style.display = "none");
  document.getElementById("fixLockOverlay")?.style      && (document.getElementById("fixLockOverlay").style.display = "none");
  document.getElementById("passportLockOverlay")?.style  && (document.getElementById("passportLockOverlay").style.display = "none");
  document.getElementById("ppWatermark")?.style          && (document.getElementById("ppWatermark").style.display = "none");
  // On-chain monitor: show Subscribe, hide lock button
  const onchainBtn  = document.getElementById("fwOnchainBtn");
  const onchainLock = document.getElementById("fwOnchainLockBtn");
  if (onchainBtn)  onchainBtn.style.display  = "inline-flex";
  if (onchainLock) onchainLock.style.display = "none";
  fwUpdateExportVisibility();
  fwInitExport();

  // After unlock: re-render relations with unlocked timeline buttons
  if (fwWallet && fwWallet !== DEMO_WALLET && fwNet) {
    const relSection = document.getElementById("fwRelSection");
    const relContent = document.getElementById("fwRelContent");
    if (relSection) relSection.style.display = "block";

    // If free tier already fetched relations â†’ just re-render (buttons now unlocked)
    if (Array.isArray(window.__fwRelations)) {
      fwRenderRelations(fwNet, window.__fwRelations);
    } else {
      // Still fetching in background (null) or never fetched â€” fetch now
      if (relContent) relContent.innerHTML = '<div class="rel-loading">ğŸ” Fetching transaction dataâ€¦</div>';
      fwFetchWalletTxs(fwNet, fwWallet).then(txs => {
        const relations = fwAnalyzeRelations(fwNet, fwWallet, txs);
        window.__fwRelations = relations;
        fwRenderRelations(fwNet, relations);
      }).catch(() => {
        window.__fwRelations = [];
        const rc2 = document.getElementById("fwRelContent");
        if (rc2) rc2.innerHTML = `
          <div style="padding:14px 16px;border-radius:12px;background:rgba(255,193,7,.06);
               border:1px solid rgba(255,193,7,.2);
               display:flex;align-items:center;justify-content:space-between;gap:10px">
            <span style="font-size:12px;color:var(--muted)">âš  Could not fetch transaction history.</span>
            <button onclick="fwFetchWalletTxs(fwNet,fwWallet).then(t=>{window.__fwRelations=fwAnalyzeRelations(fwNet,fwWallet,t);fwRenderRelations(fwNet,window.__fwRelations);})"
              style="padding:5px 12px;border-radius:8px;border:1px solid rgba(255,193,7,.35);
              background:rgba(255,193,7,.06);color:#ffd166;font-size:11px;font-weight:700;cursor:pointer">
              Retry â†º
            </button>
          </div>`;
      });
    }
  } else if (Array.isArray(window.__fwRelations) && window.__fwRelations.length && fwNet) {
    // Demo or other case â€” re-render with current tier buttons
    fwRenderRelations(fwNet, window.__fwRelations);
  }
}

// 6. Rate-limit verification calls (prevent brute force if someone tries to guess nonce)
let _fwCheckCount = 0;
const _fwCheckStart = Date.now();

function _fwRateLimitedCheck() {
  _fwCheckCount++;
  const elapsed = Date.now() - _fwCheckStart;
  if (_fwCheckCount > 8 && elapsed < 30000) {
    console.warn("[CycleX] Too many access checks. Please wait.");
    return false;
  }
  return true;
}

// 7. Protect exports â€” check tier at runtime, not just at bind time
const _fwGuardExport = (fn) => function(...args) {
  // Double-check against verified closure state (not just fwAccessTier var)
  if (!_fwAccessVerified) {
    requestFullAccess();
    return;
  }
  return fn.apply(this, args);
};

let fwScanData     = null;        // raw parsed approvals
let fwPreviewMeta  = null;        // preview-only data (free tier, no addresses)
let fwCurrentScore = 0;
let fwWallet       = "";
let fwNet          = "bsc";
let fixDone        = [false, false, false];
let fixApprovals   = [];          // top revocable approvals for fix steps
const scoreIncrements = [18, 14, 10];

// â”€â”€ ETHERS BRIDGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getE()  { return window.E || window.ethers; }
function getRPC(net) {
  if (typeof getReadProvider === "function") return getReadProvider(net);
  if (window.CX?.getReadProvider) return window.CX.getReadProvider(net);
  return null;
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wait     = ms => new Promise(r => setTimeout(r, ms));
function fwShort(a) {
  if (!a || a.length < 12) return a || "â€”";
  return a.slice(0, 8) + "â€¦" + a.slice(-5);
}
function today() {
  return new Date().toLocaleDateString("en-US", { year:"numeric", month:"short", day:"numeric" });
}
function esc(s) {
  return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function fwIsAddr(a) {
  try {
    const E = getE();
    if (E?.isAddress) return E.isAddress(a);
    if (E?.utils?.isAddress) return E.utils.isAddress(a);
    return /^0x[0-9a-fA-F]{40}$/.test(a);
  } catch { return /^0x[0-9a-fA-F]{40}$/.test(String(a||"")); }
}
function fwNorm(a) {
  try {
    const E = getE();
    if (E?.getAddress) return E.getAddress(a);
    if (E?.utils?.getAddress) return E.utils.getAddress(a);
  } catch {}
  return String(a || "");
}
function isUnlimitedAllow(v) {
  const s = String(v || "").toLowerCase().trim();
  if (s === "âˆ" || s === "infinite" || s === "unlimited" || s.includes("inf")) return true;
  try {
    const n = BigInt(s);
    return n > (2n ** 200n);
  } catch { return false; }
}
function fmtUSD(n) {
  if (!Number.isFinite(n) || n <= 0) return "â€”";
  if (n >= 1_000_000) return `$${(n/1_000_000).toFixed(1)}M`;
  if (n >= 1_000)    return `$${(n/1_000).toFixed(1)}K`;
  return `$${n.toFixed(0)}`;
}

// â”€â”€ API FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Privacy model:
//   /api/preview      â†’ returns {score, counts} only â€” no addresses, no spenders
//   /api/getApprovals â†’ returns full approval list â€” only called after full access granted

async function _fwApiFetch(url, timeoutMs=18000) {
  const ctrl = new AbortController();
  const t    = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, { method:"GET", signal:ctrl.signal });
    if (res.status === 429) { const e=new Error("RATE_LIMIT"); e.status=429; throw e; }
    if (!res.ok)            { const e=new Error(`API_${res.status}`); e.status=res.status; throw e; }
    return await res.json();
  } finally { clearTimeout(t); }
}

// Preview: only score + counts â€” safe to call for free tier
async function fetchPreview(net, address) {
  const u = new URL("/api/preview", API_BASE);
  u.searchParams.set("net", net);
  u.searchParams.set("address", address);
  const data = await _fwApiFetch(u.toString());

  // Worker /api/preview returns: { score, riskLevel, rows: [...stripped] }
  // rows have: allowance, symbol, risk, verified, decimals â€” NO token/spender addresses
  if (data?.rows && Array.isArray(data.rows)) {
    return data; // pass full object â€” runLoadSequence extracts rows + meta
  }

  // Fallback: backend returns /api/getApprovals full format â€” strip addresses
  const rawArr = Array.isArray(data)          ? data
               : Array.isArray(data?.approvals) ? data.approvals
               : Array.isArray(data?.result)    ? data.result
               : Array.isArray(data?.data)      ? data.data
               : null;

  if (rawArr) {
    return rawArr.map(r => ({
      allowance: r?.allowance ?? r?.value ?? "0",
      symbol:    r?.symbol || "TOKEN",
      risk:      r?.risk || "",
      verified:  r?.verified,
      decimals:  r?.decimals ?? 18
      // token, spender intentionally omitted
    }));
  }

  return data;
}

// Full approvals: called only after full access granted
async function fetchApprovals(net, address) {
  const u = new URL("/api/getApprovals", API_BASE);
  u.searchParams.set("net", net);
  u.searchParams.set("address", address);
  const data = await _fwApiFetch(u.toString());
  const arr = Array.isArray(data)                ? data
    : Array.isArray(data?.approvals)             ? data.approvals
    : Array.isArray(data?.result)                ? data.result
    : Array.isArray(data?.data)                  ? data.data
    : Array.isArray(data?.rows)                  ? data.rows
    : Array.isArray(data?.list)                  ? data.list
    : Array.isArray(data?.items)                 ? data.items
    : [];
  return arr;
}

// â”€â”€ METRICS COMPUTATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeMetrics(approvals) {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CycleX Risk Classification Model v1
  // 4 Layers: Contract Risk Ã— Approval Risk Ã— Exposure Ã— TTD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // â”€â”€ Normalise raw approval rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rows = approvals.map(r => {
    const allow    = String(r?.allowance ?? r?.value ?? r?.approved_amount ?? r?.amount ?? r?.data ?? r?.raw_amount ?? "0");
    const symbol   = String(r?.symbol || r?.token_symbol || r?.tokenSymbol || r?.token_name || r?.tokenName || r?.name || "TOKEN");
    // Token address: try every known field format
    const token    = String(
      r?.token         || r?.token_address   || r?.tokenAddress  ||
      r?.contract      || r?.contract_address|| r?.contractAddress||
      r?.token_contract|| r?.asset_address   || r?.address       || ""
    );
    // Spender address: try every known field format across providers
    const spenderRaw = String(
      r?.spender         || r?.spender_address  || r?.spenderAddress  ||
      r?.approved_to     || r?.approvedTo       || r?.approved_address ||
      r?.operator        || r?.operator_address ||
      r?.to              || r?.toAddress        || r?.recipient        || ""
    );

    // Treat zero address as "no spender" (burned/revoked)
    const ZERO_ADDR = "0x0000000000000000000000000000000000000000";
    const spender  = spenderRaw.toLowerCase() === ZERO_ADDR.toLowerCase() ? "" : spenderRaw;
    const risk     = String(r?.risk || "").toLowerCase();
    const verified = (r?.verified === true) ? true : (r?.verified === false) ? false : null;
    const decimals = Number(r?.decimals ?? r?.token_decimals ?? 18) || 18;

    // â”€â”€ LAYER 1: Contract Risk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Weight 1-10 based on what we know about the spender
    let contractRisk, contractLabel, contractClass;
    if (risk === "high" || risk === "malicious" || risk === "flagged") {
      contractRisk = 9; contractLabel = "Flagged / Malicious"; contractClass = "critical";
    } else if (verified === false) {
      contractRisk = 5; contractLabel = "Unverified Contract";  contractClass = "unverified";
    } else if (risk === "medium") {
      contractRisk = 3; contractLabel = "Verified â€” Privileged"; contractClass = "privileged";
    } else if (verified === true) {
      contractRisk = 1; contractLabel = "Verified & Known";     contractClass = "safe";
    } else {
      contractRisk = 4; contractLabel = "Unknown Contract";     contractClass = "unknown";
    }

    // â”€â”€ LAYER 2: Approval Risk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Only real risk if approval > 0
    const isUnlimited  = isUnlimitedAllow(allow);
    const allowBigNum  = (() => { try { return BigInt(allow); } catch { return 0n; } })();
    // isUnlimited covers "infinite" string (BigInt throws on it â†’ 0n)
    const hasApproval  = isUnlimited || allowBigNum > 0n;

    let approvalRisk, approvalLabel, approvalClass;
    if (!hasApproval) {
      approvalRisk = 0; approvalLabel = "No Active Approval"; approvalClass = "none";
    } else if (isUnlimited) {
      approvalRisk = 10; approvalLabel = "Unlimited Approval"; approvalClass = "unlimited";
    } else {
      approvalRisk = 3;  approvalLabel = "Capped Approval";    approvalClass = "capped";
    }

    // â”€â”€ LAYER 3: Composite Risk Score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Contract Ã— Approval (approval=0 means no real risk regardless of contract)
    const compositeRisk = approvalRisk === 0 ? 0 : contractRisk * approvalRisk;

    // â”€â”€ Drain Potential description â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let drainLabel, drainClass;
    if (!hasApproval) {
      drainLabel = "No drain risk â€” no active approval";
      drainClass = "ok";
    } else if (isUnlimited) {
      drainLabel = "100% of " + symbol + " balance drainable";
      drainClass = "bad";
    } else {
      drainLabel = "Partial â€” capped allowance";
      drainClass = "warn";
    }

    // â”€â”€ Human-readable risk reason (no drainLabel â€” shown separately in badge) â”€â”€
    let riskReason;
    if (!hasApproval) {
      riskReason = contractRisk >= 5
        ? `âš  High-risk contract â€” no active spending permission`
        : `âœ… No active approval`;
    } else if (isUnlimited && contractRisk >= 9) {
      riskReason = `ğŸ”´ Unlimited approval granted to flagged / malicious contract`;
    } else if (isUnlimited && contractRisk >= 5) {
      riskReason = `ğŸŸ  Unlimited approval to unverified contract`;
    } else if (isUnlimited) {
      riskReason = `ğŸŸ¡ Unlimited approval to ${contractLabel.toLowerCase()}`;
    } else {
      riskReason = `ğŸŸ¢ Capped approval â€” ${contractLabel.toLowerCase()}`;
    }

    // â”€â”€ Risk Classification (for display badge) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // CRITICAL: only show "High Risk" if there IS an active approval
    let displayRisk;
    if (!hasApproval) {
      displayRisk = contractRisk >= 5 ? "informational" : "safe";
    } else if (compositeRisk >= 40) {
      displayRisk = "critical";
    } else if (compositeRisk >= 20 || isUnlimited) {
      displayRisk = "high";
    } else if (compositeRisk >= 6) {
      displayRisk = "medium";
    } else {
      displayRisk = "low";
    }

    return {
      allow, symbol, token, spender, verified, decimals, risk,
      // Layer 1
      contractRisk, contractLabel, contractClass,
      // Layer 2
      approvalRisk, approvalLabel, approvalClass,
      isUnlimited, hasApproval, allowBigNum,
      // Layer 3
      compositeRisk,
      // Display
      displayRisk, riskReason, drainLabel, drainClass,
      raw: r
    };
  });

  // â”€â”€ Active threats (have an approval AND high composite risk) â”€
  const activeThreats  = rows.filter(r => r.hasApproval && r.compositeRisk > 0);
  const unlimited      = rows.filter(r => r.isUnlimited);
  const unlimitedActive= rows.filter(r => r.isUnlimited && r.hasApproval);
  const highRisk       = rows.filter(r => r.hasApproval && r.contractRisk >= 5);
  const unverified     = rows.filter(r => r.verified === false);
  const unverifiedActive= rows.filter(r => r.verified === false && r.hasApproval);
  const noApproval     = rows.filter(r => !r.hasApproval);

  // â”€â”€ SCORE: penalise only ACTIVE threats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let score = 100;
  score -= unlimitedActive.length  * 14;  // unlimited + active
  score -= highRisk.length         * 18;  // flagged/malicious + active
  score -= unverifiedActive.length * 8;   // unverified + active
  score = Math.max(5, Math.min(100, score));

  // â”€â”€ Blast Radius â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const blastCount   = unlimitedActive.length;
  const blastLabel   = blastCount === 0 ? "$0 exposed"
                     : blastCount <= 2  ? "Limited exposure"
                     : blastCount <= 6  ? "Moderate exposure"
                     : "High exposure";
  const blastDisplay = blastCount > 0 ? `${blastLabel} (${blastCount} unlimited)` : blastLabel;

  // â”€â”€ Time-to-Drain: ONLY when there is an active unlimited approval
  let drainTime, drainFast = false;
  if (unlimitedActive.length === 0) {
    drainTime = "N/A â€” no unlimited approvals";
    drainFast = false;
  } else if (unlimitedActive.length <= 2) {
    drainTime = "~5 min";
    drainFast = false;
  } else if (unlimitedActive.length <= 6) {
    drainTime = "~90 sec";
    drainFast = true;
  } else {
    drainTime = "< 30 sec";
    drainFast = true;
  }

  // Score labels â€” translated via _t() at render time
  const _scoreLabelKey = score >= 85 ? "score_protected"
                       : score >= 70 ? "score_exposed"
                       : score >= 50 ? "score_vulnerable"
                       : "score_critical";
  const scoreLabel = _scoreLabelKey; // key resolved at render time via fwGetScoreLabel()

  // â”€â”€ Top Threats: sort by compositeRisk desc, active first
  const sorted = [...rows].sort((a, b) => {
    if (a.hasApproval !== b.hasApproval) return a.hasApproval ? -1 : 1;
    return b.compositeRisk - a.compositeRisk;
  });

  // â”€â”€ Threat items: sorted by risk, hard cap 50 for DOM perf â”€
  // Paginated in UI (10/page). canRevoke requires real 0x addresses.
  const threats = sorted.slice(0, 15).map(r => ({
    name:        (r.spender && r.spender.length > 5) ? fwShort(r.spender)
                   : (r.symbol ? r.symbol + " Spender" : "Unknown Spender"),
    fullSpender: r.spender,
    token:       r.token,
    symbol:      r.symbol,
    label:       !r.hasApproval
                   ? (r.contractRisk >= 5 ? "High-risk contract â€” no approval" : "No approval")
                   : r.displayRisk === "critical" ? "Critical"
                   : r.displayRisk === "high"     ? "High Risk"
                   : r.displayRisk === "medium"   ? "Medium Risk"
                   : "Low Risk",
    risk:        !r.hasApproval ? "ok"
                   : r.compositeRisk >= 40 ? "bad"
                   : r.compositeRisk >= 6  ? "warn" : "ok",
    why:         r.riskReason,
    drainLabel:  r.drainLabel,
    approvalLabel: r.approvalLabel,
    contractLabel: r.contractLabel,
    isUnlimited: r.isUnlimited,
    hasApproval: r.hasApproval,
    // canRevoke: need BOTH addresses present â€” simple non-empty check
    // fwNorm() handles address format normalization at revoke time
    canRevoke:   !!(r.hasApproval && r.token && r.token.length > 5 && r.spender && r.spender.length > 5),
    compositeRisk: r.compositeRisk,
    tokens:      [r.symbol || "TOKEN"]
  }));

  // Fix targets: only rows with ACTIVE approvals, sorted by composite risk
  const fixTargets = rows
    .filter(r => r.hasApproval && r.token && r.spender)
    .sort((a,b) => b.compositeRisk - a.compositeRisk)
    .slice(0, 3);

  return {
    score, scoreLabel,
    blastDisplay,
    drainTime, drainFast,
    riskyApprovals:  activeThreats.length,
    unlimitedCount:  unlimited.length,        // total unlimited approvals
    unlimitedActive: unlimitedActive.length,  // unlimited WITH approval > 0
    highRiskCount:   highRisk.length,
    unverifiedCount: unverified.length,
    totalApprovals:  rows.length,
    noApprovalCount: noApproval.length,
    rows,
    threats,
    fixTargets,
    scoreMeta: [
      ...(unlimitedActive.length  ? [{ label: `${unlimitedActive.length} unlimited active`,  cls:"bad"  }] : []),
      ...(highRisk.length         ? [{ label: `${highRisk.length} high-risk contracts`,       cls:"bad"  }] : []),
      ...(unverifiedActive.length ? [{ label: `${unverifiedActive.length} unverified active`, cls:"warn" }] : []),
      ...(!unlimitedActive.length && !highRisk.length ? [{ label:"No active unlimited detected", cls:"ok" }] : [])
    ],
    blastMeta: blastCount > 0 ? [
      { label: `${blastCount} unlimited active spenders`, cls:"bad"  },
      { label: "Revoke to reduce exposure",               cls:"warn" }
    ] : [{ label: "No active unlimited approvals âœ“", cls:"ok" }],
    drainMeta: drainFast ? [
      { label: "Unlimited + active spenders", cls:"bad" }
    ] : [{ label: "Low drain risk", cls:"ok" }]
  };
}


// â”€â”€ APPKIT INTEGRATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APPKIT_PROJECT_ID = "7886bcb95105e9e47337cec481d5de75";
let _appkitLoadPromise = null;

async function fwLoadAppKit() {
  if (window.CxAppKitModal) return window.CxAppKitModal;
  if (_appkitLoadPromise) return _appkitLoadPromise;
  _appkitLoadPromise = (async () => {
    const [{ createAppKit }, { EthersAdapter }, { bsc, mainnet }] = await Promise.all([
      import("https://esm.sh/@reown/appkit@1.8.15"),
      import("https://esm.sh/@reown/appkit-adapter-ethers@1.8.15"),
      import("https://esm.sh/@reown/appkit/networks"),
    ]);
    const appkit = createAppKit({
      adapters: [new EthersAdapter()],
      networks: [bsc, mainnet],
      defaultNetwork: bsc,
      projectId: APPKIT_PROJECT_ID,
      analytics: false,
      metadata: {
        name: "CycleX Firewall",
        description: "CycleX Wallet Firewall",
        url: window.location.origin,
        icons: [`${window.location.origin}/logo.png`]
      }
    });
    window.CxAppKitModal = appkit;
    if (!window.E && window.ethers) window.E = window.ethers;
    return appkit;
  })();
  return _appkitLoadPromise;
}

async function fwWaitForWallet(timeoutMs = 16000) {
  const start = Date.now();
  while (Date.now() - start < timeoutMs) {
    if (window.wallet?.address) return window.wallet.address;
    try {
      const p = window.CxAppKitModal?.getWalletProvider?.();
      if (p) {
        const Eth = window.E || window.ethers;
        if (Eth) {
          const web3Provider = new Eth.BrowserProvider(p);
          const signer = await web3Provider.getSigner();
          const address = await signer.getAddress();
          if (address) {
            if (!window.wallet) window.wallet = {};
            window.wallet.address     = address;
            window.wallet.signer      = signer;
            window.wallet.providerRaw = p;
            return address;
          }
        }
      }
    } catch {}
    await wait(350);
  }
  return null;
}

// â”€â”€ ACCESS GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setGateStatus(msg, color="#a0a0b0") {
  const el = document.getElementById("gateStatus");
  if (el) { el.textContent = msg; el.style.color = color; }
}

async function checkCycxPass() {
  const Eth = getE() || window.ethers;
  if (!Eth?.Contract) return { eligible:false, reason:"ethers_missing" };
  const addr = window.wallet?.address;
  if (!addr) return { eligible:false, reason:"no_wallet" };

  try {
    const runCheck = async (provider) => {
      const cycxC = new Eth.Contract(CYCX_BSC, GATE_ABI, provider);
      const passC = new Eth.Contract(PASS_BSC, GATE_ABI, provider);
      let cycxDec = 18n;
      try { cycxDec = BigInt(await cycxC.decimals()); } catch {}
      const [cycxBal, passBal] = await Promise.all([
        cycxC.balanceOf(addr).catch(()=>0n),
        passC.balanceOf(addr).catch(()=>0n)
      ]);
      const cycxMin = CYCX_MIN * (10n ** cycxDec);
      return {
        eligible: BigInt(passBal) >= PASS_MIN || BigInt(cycxBal) >= cycxMin,
        hasPass:  BigInt(passBal) >= PASS_MIN,
        hasCycx:  BigInt(cycxBal) >= cycxMin
      };
    };

    if (typeof withRpcFallback === "function") {
      const r = await withRpcFallback("bsc", runCheck, { timeoutMs:9000 });
      if (!r.ok) return { eligible:false, reason:"rpc_failed" };
      return { ok:true, ...r.res };
    }
    const provider = getRPC("bsc");
    if (!provider) return { eligible:false, reason:"no_rpc" };
    return { ok:true, ...(await runCheck(provider)) };
  } catch(e) {
    return { eligible:false, reason: e.message };
  }
}

async function requestFullAccess() {
  if (fwAccessTier === "full") return;
  setGateStatus("Loading wallet moduleâ€¦", "#a87eff");

  let appkit;
  try {
    appkit = await fwLoadAppKit();
  } catch(e) {
    setGateStatus("Could not load wallet module. Check your connection.", "#ff7a8a");
    return;
  }

  if (!window.wallet?.address) {
    try {
      setGateStatus("Opening wallet connectâ€¦", "#a87eff");
      await appkit.open();
      const addr = await fwWaitForWallet(20000);
      if (!addr) { setGateStatus("Wallet not connected. Please try again.", "#ff9a6b"); return; }
    } catch(e) {
      setGateStatus("Connect cancelled or failed.", "#ff9a6b");
      return;
    }
  }

  setGateStatus("Checking CYCX / PASS on BSCâ€¦", "#a87eff");
  const res = await checkCycxPass();
  const eligible = res.eligible === true || (res.ok && res.eligible);

  if (eligible) {
    const why = res.hasPass ? "PASS âœ“" : `${Number(CYCX_MIN)} CYCX âœ“`;
    setGateStatus(`Eligible (${why}) â€” unlocking!`, "#5dffb2");
    await wait(700);
    // Set _fwAccessVerified before unlockFull â€” this is the only legit path
    _fwAccessVerified = true;
    _fwValidatedWallet = window.wallet?.address || null;
    unlockFull();
    // Re-fetch with full approvals (preview had no addresses / stripped rows)
    if (fwWallet && fwWallet !== DEMO_WALLET && fwNet) {
      // Auto-rescan immediately â€” user should not need to press anything
      fwRescanFull();
    } else if (fwScanData) {
      renderDashboard(fwWallet, fwScanData, "full");
    }
    return;
  }

  const msg =
    res.reason === "no_wallet"      ? "Wallet not detected." :
    res.reason === "ethers_missing" ? "Ethers.js not loaded. Refresh and try again." :
    res.reason === "rpc_failed"     ? "BSC RPC check failed. Try again." :
    res.reason === "no_rpc"         ? "BSC RPC unavailable. Try again." :
    `Not eligible. Need â‰¥${Number(CYCX_MIN)} CYCX or 1 PASS on BSC.`;
  setGateStatus(msg, "#ff7a8a");
}

// â”€â”€ PASS POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPassPopup()  { const el = document.getElementById("passPopup"); if(el) el.style.display="flex"; }
function closePassPopup() { const el = document.getElementById("passPopup"); if(el) el.style.display="none"; }

function unlockFull() {
  // Must go through nonce-protected path
  _unlockFull_real(_fwNonce);
}

// â”€â”€ MEMORY CLEANUP â€” called before each new scan to prevent Chrome memory accumulation â”€â”€
function fwCleanupBeforeScan() {
  // 1. Cancel all pending render timers
  _rdTimers.forEach(clearTimeout);
  _rdTimers = [];

  // 2. Cancel score animation
  if (_scoreAnimTimer) { clearInterval(_scoreAnimTimer); _scoreAnimTimer = null; }

  // 3. Clear exposure map SVG to free GPU memory
  const svg = document.getElementById("exposureMap");
  if (svg) svg.innerHTML = "";
  _lastExposureHash = ""; // reset debounce

  // 4. Clear threats list DOM
  const tl = document.getElementById("threatsList");
  if (tl) tl.innerHTML = "";

  // 5. Reset pagination
  _threatsAll = []; _threatsShown = 0;

  // 6. Clear relations content (not the section)
  const relContent = document.getElementById("fwRelContent");
  if (relContent) relContent.innerHTML = "";
  window.__fwRelations = null;

  // 7. Stop approval poller if running (saves memory + network)
  if (_fwPollerInterval) { clearInterval(_fwPollerInterval); _fwPollerInterval = null; }
}

// â”€â”€ LOADING SEQUENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runLoadSequence(walletAddr, net, isDemo) {
  // Cleanup previous scan to prevent Chrome memory accumulation
  fwCleanupBeforeScan();

  fwWallet = walletAddr;
  fwNet    = net;

  const hero    = document.getElementById("heroSection");
  const loadWrap= document.getElementById("loadWrap");
  const dash    = document.getElementById("dashboard");

  hero.style.transition = "opacity .3s ease, transform .3s ease";
  hero.style.opacity = "0";
  hero.style.transform = "translateY(-12px)";
  await wait(320);
  hero.style.display = "none";

  loadWrap.style.display = "block";
  document.getElementById("loadLabel").textContent = `Scanning ${fwShort(walletAddr)}â€¦`;

  const steps = ["step1","step2","step3","step4"];
  const fill  = document.getElementById("loadBarFill");

  // Step 1: fetch logs (real or demo)
  const s1 = document.getElementById("step1");
  s1.classList.add("active");
  fill.style.width = "25%";

  let approvals = [];
  let scanError = null;

  if (!isDemo) {
    try {
      // Privacy: free tier gets preview only (no addresses in network tab)
      // Full access tier gets complete approval data
      if (fwAccessTier === "full" && _fwAccessVerified) {
        approvals = await fetchApprovals(net, walletAddr);
      } else {
        const previewData = await fetchPreview(net, walletAddr);
        if (Array.isArray(previewData)) {
          // Fallback: already-stripped array of rows
          approvals = previewData;
        } else if (previewData?.rows && Array.isArray(previewData.rows)) {
          // Normal: /api/preview returned { rows, score, ... }
          approvals = previewData.rows;   // â† stripped rows, no addresses
          fwPreviewMeta = previewData;    // keep meta for potential display
        } else {
          approvals = [];
          fwPreviewMeta = previewData;
        }
      }
    } catch(e) {
      scanError = e;
      // fall through with empty array â€” will show error
    }
  } else {
    approvals = getDemoApprovals();
    await wait(700);
  }
  s1.classList.remove("active"); s1.classList.add("done");
  s1.querySelector(".step-icon").textContent = "âœ“";

  // Steps 2-4: visual only
  for (let i = 1; i < 4; i++) {
    const el = document.getElementById(steps[i]);
    el.classList.add("active");
    fill.style.width = ((i+1)/4*100) + "%";
    await wait(600 - i*80);
    el.classList.remove("active"); el.classList.add("done");
    el.querySelector(".step-icon").textContent = "âœ“";
  }

  await wait(250);
  loadWrap.style.display = "none";
  dash.style.display = "block";

  if (scanError) {
    // Show the demoNotice with error details
    const notice = document.getElementById("demoNotice");
    if (notice) {
      notice.style.display = "block";
      notice.style.background = "rgba(255,71,87,.10)";
      notice.style.borderColor = "rgba(255,71,87,.3)";
      notice.innerHTML = scanError.status === 429
        ? `<strong style="color:#ff7a8a">â³ Rate limit reached</strong> â€” Max 2 scans/hour per IP. Try again in a few minutes.`
        : `<strong style="color:#ff7a8a">âš  API Error ${scanError.status || "network"}</strong> â€” Scan failed. Showing demo data. <a href="javascript:startScan()" style="color:var(--cyan);font-weight:800">Try again â†º</a>`;
    }
    // Also show a persistent top banner
    const existing = document.getElementById("fwApiErrorBanner");
    if (!existing) {
      const banner = document.createElement("div");
      banner.id = "fwApiErrorBanner";
      banner.style.cssText = "position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:9999;padding:10px 20px;border-radius:12px;background:rgba(255,71,87,.15);border:1px solid rgba(255,71,87,.4);color:#ff7a8a;font-size:12px;font-weight:700;max-width:480px;width:calc(100%-32px);text-align:center;cursor:pointer;backdrop-filter:blur(8px)";
      banner.innerHTML = `âš  API unavailable â€” showing demo data. <span style="color:var(--cyan)">Click to retry â†º</span>`;
      banner.onclick = () => { banner.remove(); startScan(); };
      document.body.appendChild(banner);
      setTimeout(() => banner?.remove(), 12000);
    }
    approvals = getDemoApprovals();
    isDemo = true; // treat as demo so history isn't saved with fake data
  }

  // Show notices
  const scanNotice = document.getElementById("scanNotice");
  const demoNotice = document.getElementById("demoNotice");
  if (!isDemo && !scanError) {
    if (scanNotice) scanNotice.style.display = "block";
    if (demoNotice) demoNotice.style.display = "none";
  } else if (isDemo) {
    if (demoNotice) demoNotice.style.display = "block";
    if (scanNotice) scanNotice.style.display = "none";
  }

  fwScanData = computeMetrics(approvals);
  fixApprovals = fwScanData.fixTargets;

  // Show access gate in free tier
  if (fwAccessTier === "free") {
    const gate = document.getElementById("accessGateOverlay");
    if (gate) gate.style.display = "block";
  }

  renderDashboard(walletAddr, fwScanData, fwAccessTier);

  // â”€â”€ SCAN HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!isDemo) {
    fwHistorySave(walletAddr, net, fwScanData);
  }
  fwRenderHistory(
    walletAddr, net,
    fwScanData.score,
    fwScanData
  );

  // â”€â”€ NEW ECOSYSTEM FEATURES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fwWatchInit();                          // Wallet Watch â€” render watched wallets
  fwWatchUpdateScore(walletAddr, net, fwScanData.score); // update score in watch list
  fwThreatInit(fwScanData);              // Threat Feed â€” check against user approvals
  // API section always visible (informational)
  const apiSec = document.getElementById("fwApiSection");
  if (apiSec) apiSec.style.display = "block";

  // â”€â”€ WALLET RELATIONS (async, non-blocking) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fwUpdateExportVisibility();
  fwInitExport();
  window.__fwRelations = [];
  const relSection = document.getElementById("fwRelSection");
  const relContent = document.getElementById("fwRelContent");

  if (!isDemo && fwAccessTier === "full") {
    // Full access + real wallet: fetch and show REAL data only
    if (relSection) relSection.style.display = "block";
    const relSummaryEl = document.getElementById("fwRelSummary");
    if (relSummaryEl) relSummaryEl.innerHTML = "";
    if (relContent) relContent.innerHTML = '<div class="rel-loading">ğŸ” Analyzing wallet relationshipsâ€¦</div>';
    fwFetchWalletTxs(net, walletAddr).then(txs => {
      const relations = fwAnalyzeRelations(net, walletAddr, txs);
      window.__fwRelations = relations;
      fwRenderRelations(net, relations);
    }).catch(() => {
      if (relContent) relContent.innerHTML = '<div class="rel-empty">âš  Could not fetch transaction history. Check your connection and try again.</div>';
    });
  } else if (isDemo) {
    // Demo mode: show example relations with clearly-marked demo badge
    const demoRels = [
      {entity:{name:"PancakeSwap V2",type:"dex",tags:["verified","defi"]}, address:"0x10ed43c718714eb63d5aa57b78b54704e256024e", in:3, out:12, txs:[], firstSeen:Date.now()-60*86400000, lastSeen:Date.now()-86400000},
      {entity:{name:"1inch V5 BSC", type:"dex",tags:["aggregator","defi"]},address:"0x1111111254eeb25477b68fb85ed929f73a960582", in:0,  out:5,  txs:[], firstSeen:Date.now()-90*86400000, lastSeen:Date.now()-3*86400000},
      {entity:{name:"Binance BSC Hot",type:"cex",tags:["trusted"]},         address:"0x8894e0a0c962cb723c1976a4421c95949be2d4e3", in:8,  out:2,  txs:[], firstSeen:Date.now()-120*86400000,lastSeen:Date.now()-7*86400000},
      {entity:{name:"Stargate BSC",  type:"bridge",tags:["trusted"]},        address:"0xac98d8d1bb07d04f7e4e015f09bd2f1cb0c13ca1", in:1,  out:3,  txs:[], firstSeen:Date.now()-45*86400000, lastSeen:Date.now()-14*86400000}
    ];
    window.__fwRelations = demoRels;
    fwRenderRelations(net, demoRels);
  } else {
    // Free tier + real wallet: fetch relations and show cards â€” timeline buttons stay locked
    if (relSection) relSection.style.display = "block";
    window.__fwRelations = null; // null = fetch in progress, [] = fetched but empty
    if (relContent) relContent.innerHTML = '<div class="rel-loading">ğŸ” Analyzing wallet relationshipsâ€¦</div>';
    fwFetchWalletTxs(net, walletAddr).then(txs => {
      const relations = fwAnalyzeRelations(net, walletAddr, txs);
      window.__fwRelations = relations;
      fwRenderRelations(net, relations);
      // Cards show with locked "ğŸ”’ Unlock to view transactions" buttons (handled inside fwRenderRelations)
    }).catch(() => {
      window.__fwRelations = [];
      if (relContent) relContent.innerHTML = `
        <div style="padding:14px 16px;border-radius:12px;background:rgba(255,193,7,.06);
             border:1px solid rgba(255,193,7,.2);font-size:12px;color:var(--muted)">
          âš  Could not fetch transaction history. Unlock Full Access to retry.
        </div>`;
    });
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCAN HISTORY ENGINE â€” localStorage, zero backend
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FW_HISTORY_MAX  = 10;   // max entries per wallet+net
const FW_HISTORY_KEY  = (w, n) => `cx_hist_${(w||"").toLowerCase()}_${n||"bsc"}`;
const FW_WALLETS_KEY  = "cx_hist_wallets"; // index of all tracked wallets

function fwHistorySave(wallet, net, d) {
  if (!wallet || wallet === DEMO_WALLET) return; // never save demo
  try {
    const key   = FW_HISTORY_KEY(wallet, net);
    const entry = {
      ts:         Date.now(),
      score:      d.score,
      unlimited:  d.unlimitedCount,
      highRisk:   d.highRiskCount,
      unverified: d.unverifiedCount,
      total:      d.totalApprovals
    };
    // Load existing + prepend new entry
    let history = [];
    try { history = JSON.parse(localStorage.getItem(key) || "[]"); } catch {}
    if (!Array.isArray(history)) history = [];
    history.unshift(entry);
    history = history.slice(0, FW_HISTORY_MAX);
    localStorage.setItem(key, JSON.stringify(history));

    // Update wallet index
    let wallets = [];
    try { wallets = JSON.parse(localStorage.getItem(FW_WALLETS_KEY) || "[]"); } catch {}
    if (!Array.isArray(wallets)) wallets = [];
    const wEntry = { wallet, net, lastScore: d.score, lastTs: Date.now() };
    const existIdx = wallets.findIndex(w => w.wallet.toLowerCase() === wallet.toLowerCase() && w.net === net);
    if (existIdx >= 0) wallets[existIdx] = wEntry;
    else wallets.unshift(wEntry);
    wallets = wallets.slice(0, 20); // max 20 wallets tracked
    localStorage.setItem(FW_WALLETS_KEY, JSON.stringify(wallets));
  } catch(e) { /* localStorage can be blocked */ }
}

function fwHistoryLoad(wallet, net) {
  if (!wallet) return [];
  try {
    const raw = localStorage.getItem(FW_HISTORY_KEY(wallet, net));
    const h   = JSON.parse(raw || "[]");
    return Array.isArray(h) ? h : [];
  } catch { return []; }
}

function fwHistoryLoadAllWallets() {
  try {
    const raw = localStorage.getItem(FW_WALLETS_KEY);
    const w   = JSON.parse(raw || "[]");
    return Array.isArray(w) ? w : [];
  } catch { return []; }
}

function fwRenderHistory(wallet, net, currentScore, currentData) {
  const banner   = document.getElementById("fwHistoryBanner");
  const deltaEl  = document.getElementById("fwHistoryDelta");
  const detailEl = document.getElementById("fwHistoryDetail");
  const sparkEl  = document.getElementById("fwHistorySparkline");
  const walletsEl= document.getElementById("fwHistoryWallets");
  if (!banner || !deltaEl) return;

  const history = fwHistoryLoad(wallet, net);
  // history[0] will be the CURRENT scan after save, so prev is [1]
  const prev    = history.length > 1 ? history[1] : null;

  // â”€â”€ DELTA BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (prev) {
    const diff = currentScore - prev.score;
    const absDiff = Math.abs(diff);
    const prevDate = new Date(prev.ts).toLocaleDateString("en-US",{month:"short",day:"numeric"});

    let cls, arrow, label;
    if (diff > 0)       { cls="up";   arrow="â†‘"; label=`+${absDiff} pts`; }
    else if (diff < 0)  { cls="down"; arrow="â†“"; label=`âˆ’${absDiff} pts`; }
    else                { cls="same"; arrow="â†’"; label="No change"; }

    deltaEl.innerHTML = `<span class="fwh-delta ${cls}">${arrow} ${label}</span>`;

    // â”€â”€ DETAIL LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const changes = [];
    const unlimitedDiff = currentData.unlimitedCount - prev.unlimited;
    const highRiskDiff  = currentData.highRiskCount  - prev.highRisk;
    const totalDiff     = currentData.totalApprovals - prev.total;
    if (unlimitedDiff !== 0) {
      const col = unlimitedDiff > 0 ? "#ff7a8a" : "#5dffb2";
      const sign = unlimitedDiff > 0 ? "+" : "";
      changes.push(`<strong style="color:${col}">${sign}${unlimitedDiff}</strong> unlimited`);
    }
    if (highRiskDiff !== 0) {
      const col = highRiskDiff > 0 ? "#ff7a8a" : "#5dffb2";
      const sign = highRiskDiff > 0 ? "+" : "";
      changes.push(`<strong style="color:${col}">${sign}${highRiskDiff}</strong> high-risk`);
    }
    if (totalDiff !== 0) {
      const col = totalDiff > 0 ? "#ffd166" : "#5dffb2";
      const sign = totalDiff > 0 ? "+" : "";
      changes.push(`<strong style="color:${col}">${sign}${totalDiff}</strong> approvals`);
    }

    const changeStr = changes.length
      ? ` â€” ${changes.join(", ")} since last scan`
      : " â€” no approval changes detected";
    detailEl.innerHTML = `Last scan: <strong>${prevDate}</strong> Â· Score was <strong>${prev.score}</strong>${changeStr}`;
  } else {
    // First scan for this wallet
    deltaEl.innerHTML  = `<span class="fwh-delta same">â†’ First scan</span>`;
    detailEl.innerHTML = `No previous scans found for this wallet on <strong>${net.toUpperCase()}</strong>. Check back after your next scan to see changes.`;
  }

  // â”€â”€ SPARKLINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (history.length > 1) {
    const maxScore = Math.max(...history.map(h=>h.score), 1);
    sparkEl.innerHTML = history.slice(0, 8).reverse().map((h, i, arr) => {
      const isCurrent = i === arr.length - 1;
      const pct = Math.max(10, Math.round((h.score / 100) * 100));
      const color = h.score >= 70 ? "rgba(93,255,178,.5)" : h.score >= 45 ? "rgba(255,193,7,.5)" : "rgba(255,71,87,.5)";
      const dateStr = new Date(h.ts).toLocaleDateString("en-US",{month:"short",day:"numeric"});
      return `<div class="fwh-bar${isCurrent?" current":""}"
        style="height:${pct}%;${isCurrent?"":`background:${color}`}"
        title="${dateStr}: ${h.score}/100"></div>`;
    }).join("");
    sparkEl.style.display = "flex";
  } else {
    sparkEl.style.display = "none";
  }

  // â”€â”€ OTHER TRACKED WALLETS (show up to 4) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const allWallets = fwHistoryLoadAllWallets()
    .filter(w => !(w.wallet.toLowerCase() === wallet.toLowerCase() && w.net === net))
    .slice(0, 4);

  if (allWallets.length > 0) {
    const chips = allWallets.map(w => {
      const dotColor = w.lastScore >= 70 ? "#5dffb2" : w.lastScore >= 45 ? "#ffd166" : "#ff7a8a";
      const date = w.lastTs ? new Date(w.lastTs).toLocaleDateString("en-US",{month:"short",day:"numeric"}) : "â€”";
      return `<div class="fwh-wallet-chip" onclick="fwHistoryQuickScan('${esc(w.wallet)}','${esc(w.net)}')" title="Last score: ${w.lastScore}/100 Â· ${date}">
        <span class="fwh-dot" style="background:${dotColor}"></span>
        <span>${fwShort(w.wallet)}</span>
        <span style="color:var(--muted)">${w.net.toUpperCase()}</span>
        <span style="font-weight:900;color:${dotColor}">${w.lastScore}</span>
      </div>`;
    }).join("");
    walletsEl.innerHTML = `<div style="font-size:10px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;font-weight:700;width:100%;margin-bottom:4px">Other tracked wallets</div>${chips}`;
    walletsEl.style.display = "flex";
    walletsEl.style.flexWrap = "wrap";
  } else {
    walletsEl.style.display = "none";
  }

  banner.classList.add("show");
}

// Quick-scan a previously tracked wallet
window.fwHistoryQuickScan = function(wallet, net) {
  const heroSection = document.getElementById("heroSection");
  const dashboard   = document.getElementById("dashboard");
  // If dashboard is showing, hide it and re-scan
  if (dashboard && dashboard.style.display !== "none") {
    dashboard.style.display = "none";
  }
  document.getElementById("walletInput").value = wallet;
  const netSel = document.getElementById("netSelect");
  if (netSel) netSel.value = net;
  runLoadSequence(wallet, net, false);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSPORT SIGNING ENGINE â€” EIP-712, zero gas, fully verifiable
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Chain IDs for EIP-712 domain
const FW_CHAIN_IDS = { bsc: 56, eth: 1, polygon: 137 };

// Passport valid for 30 days
const FW_PASSPORT_TTL_MS = 30 * 24 * 60 * 60 * 1000;

// EIP-712 domain + types (must match on sign and verify)
function fwGetEIP712Domain(net) {
  return {
    name:    "CycleX Firewall",
    version: "1",
    chainId: FW_CHAIN_IDS[net] || 56
  };
}

const FW_PASSPORT_TYPES = {
  WalletPassport: [
    { name: "wallet",    type: "address" },
    { name: "network",   type: "string"  },
    { name: "score",     type: "uint256" },
    { name: "unlimited", type: "uint256" },
    { name: "highRisk",  type: "uint256" },
    { name: "timestamp", type: "uint256" },
    { name: "expiry",    type: "uint256" }
  ]
};

// Store signed passport in memory + sessionStorage
let _fwSignedPassport = null;

function _fwPassportValue(wallet, net, d, ts, expiry) {
  return {
    wallet:    wallet,
    network:   net,
    score:     BigInt(d.score),
    unlimited: BigInt(d.unlimitedCount),
    highRisk:  BigInt(d.highRiskCount),
    timestamp: BigInt(Math.floor(ts / 1000)),
    expiry:    BigInt(Math.floor(expiry / 1000))
  };
}

// Convert BigInt values to strings for JSON serialization
function _fwSerializePassport(p) {
  return {
    wallet:    p.wallet,
    network:   p.network,
    score:     p.score.toString(),
    unlimited: p.unlimited.toString(),
    highRisk:  p.highRisk.toString(),
    timestamp: p.timestamp.toString(),
    expiry:    p.expiry.toString()
  };
}

async function fwSignPassport() {
  const btn = document.getElementById("btnSignPassport");
  if (!window.wallet?.signer) { requestFullAccess(); return; }
  if (!fwScanData) { showPassportMsg("âš  Run a scan first."); return; }
  if (!_fwAccessVerified) { requestFullAccess(); return; }

  btn.disabled = true;
  btn.textContent = "Signingâ€¦";

  try {
    const ts     = Date.now();
    const expiry = ts + FW_PASSPORT_TTL_MS;
    const domain = fwGetEIP712Domain(fwNet);
    const value  = _fwPassportValue(fwWallet, fwNet, fwScanData, ts, expiry);

    // eth_signTypedData_v4 â€” standard MetaMask/WalletConnect method
    const provider    = window.wallet.providerRaw;
    const signerAddr  = window.wallet.address;

    const msgParams = JSON.stringify({
      domain,
      message:     _fwSerializePassport(value),
      primaryType: "WalletPassport",
      types: {
        EIP712Domain: [
          { name:"name",    type:"string"  },
          { name:"version", type:"string"  },
          { name:"chainId", type:"uint256" }
        ],
        ...FW_PASSPORT_TYPES
      }
    });

    const signature = await provider.request({
      method: "eth_signTypedData_v4",
      params: [signerAddr, msgParams]
    });

    // Store in memory
    _fwSignedPassport = {
      ..._fwSerializePassport(value),
      signature
    };

    // Build base64url verify link
    const encoded = btoa(JSON.stringify(_fwSignedPassport))
      .replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
    const verifyURL = `${location.origin}/firewall?verify=${encoded}`;

    // Update UI
    _fwShowSignedState(signature, verifyURL);
    showPassportMsg("âœ… Passport signed â€” share your verify link!");

  } catch(e) {
    if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
      showPassportMsg("Signing cancelled.");
    } else {
      showPassportMsg(`âš  Sign failed: ${(e.message||"").slice(0,80)}`);
    }
    btn.disabled = false;
    btn.textContent = "âœ Sign Passport (EIP-712)";
  }
}

function _fwShowSignedState(signature, verifyURL) {
  const btn    = document.getElementById("btnSignPassport");
  const badge  = document.getElementById("ppSignedBadge");
  const sigShort = document.getElementById("ppSigShort");
  const chip   = document.getElementById("ppSigChip");

  if (btn) { btn.textContent = "âœ Re-sign Passport"; btn.disabled = false; }
  if (badge)  badge.classList.add("visible");
  if (sigShort) sigShort.textContent = `Sig: ${signature.slice(0,18)}â€¦${signature.slice(-8)}`;
  if (chip)  chip.style.display = "flex";

  // Bind copy verify link
  const copyLinkBtn = document.getElementById("btnCopyVerifyLink");
  if (copyLinkBtn && !copyLinkBtn.__fwBound) {
    copyLinkBtn.addEventListener("click", () => {
      navigator.clipboard.writeText(verifyURL)
        .then(() => showPassportMsg("âœ… Verify link copied!"))
        .catch(() => showPassportMsg("Copy failed."));
    });
    copyLinkBtn.__fwBound = true;
  }

  // Bind share to X (signed version)
  const shareXBtn = document.getElementById("btnShareXSigned");
  if (shareXBtn && !shareXBtn.__fwBound) {
    shareXBtn.addEventListener("click", () => {
      const score = fwScanData?.score || "â€”";
      const text  = `ğŸ›¡ My CycleX Firewall Score: ${score}/100\n\nCryptographically signed & verifiable ğŸ‘‡\n${verifyURL}\n\n#CycleX #WalletSecurity #DeFi`;
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, "_blank");
    });
    shareXBtn.__fwBound = true;
  }
}

// â”€â”€ VERIFY ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwVerifyPassport(encoded) {
  const modal = document.getElementById("fwVerifyModal");
  if (!modal) return;

  // Show modal immediately in loading state
  modal.style.display = "flex";
  modal.className = "";
  document.getElementById("fvIcon").textContent  = "ğŸ”";
  document.getElementById("fvTitle").textContent = "Verifying Passportâ€¦";
  document.getElementById("fvSub").textContent   = "Checking cryptographic signatureâ€¦";
  document.getElementById("fvCard").style.display = "none";
  modal.classList.add("open");

  try {
    // Decode base64url
    const padded = encoded.replace(/-/g,'+').replace(/_/g,'/') +
                   '=='.slice(0, (4 - encoded.length % 4) % 4);
    const data   = JSON.parse(atob(padded));

    const { wallet, network, score, unlimited, highRisk,
            timestamp, expiry, signature } = data;

    if (!wallet || !signature) throw new Error("Invalid passport data");

    // Check expiry
    const expiryMs = Number(expiry) * 1000;
    const tsMs     = Number(timestamp) * 1000;
    const now      = Date.now();
    const expired  = now > expiryMs;

    // Reconstruct EIP-712 value with BigInt
    const value = {
      wallet,
      network,
      score:     BigInt(score),
      unlimited: BigInt(unlimited),
      highRisk:  BigInt(highRisk),
      timestamp: BigInt(timestamp),
      expiry:    BigInt(expiry)
    };

    const domain = fwGetEIP712Domain(network);

    // Use ethers.js to verify
    const E = getE();
    let recovered;
    try {
      recovered = E.verifyTypedData(domain, FW_PASSPORT_TYPES, value, signature);
    } catch(verifyErr) {
      throw new Error("Signature verification failed");
    }

    const isValid = recovered.toLowerCase() === wallet.toLowerCase();

    // Populate card
    document.getElementById("fvWallet").textContent   = fwShort(wallet);
    document.getElementById("fvNetwork").textContent  = network.toUpperCase();
    document.getElementById("fvScore").textContent    = `${score}/100`;
    document.getElementById("fvBlast").textContent    = `${unlimited} unlimited`;
    document.getElementById("fvHighRisk").textContent = `${highRisk} high-risk`;
    document.getElementById("fvSignedAt").textContent = new Date(tsMs).toLocaleString("en-US",{dateStyle:"medium",timeStyle:"short"});
    document.getElementById("fvExpiry").textContent   = new Date(expiryMs).toLocaleString("en-US",{dateStyle:"medium",timeStyle:"short"});
    document.getElementById("fvCard").style.display   = "block";

    if (!isValid) {
      modal.classList.add("fv-invalid");
      document.getElementById("fvIcon").textContent  = "âŒ";
      document.getElementById("fvTitle").textContent = "Invalid Signature";
      document.getElementById("fvSub").textContent   = "The signature does not match the wallet address. This passport may have been tampered with.";
    } else if (expired) {
      modal.classList.add("fv-expired");
      document.getElementById("fvIcon").textContent  = "â°";
      document.getElementById("fvTitle").textContent = "Passport Expired";
      document.getElementById("fvSub").innerHTML     = `Valid signature from <strong>${fwShort(wallet)}</strong> â€” but this passport has expired. Ask the wallet owner to re-sign.`;
    } else {
      modal.classList.add("fv-valid");
      document.getElementById("fvIcon").textContent  = "âœ…";
      document.getElementById("fvTitle").textContent = "Verified Passport";
      document.getElementById("fvSub").innerHTML     = `Authentic signature from <strong style="color:var(--cyan)">${fwShort(wallet)}</strong> on ${network.toUpperCase()}. Score: <strong style="color:var(--green)">${score}/100</strong>.`;
    }

  } catch(e) {
    modal.classList.add("fv-invalid");
    document.getElementById("fvIcon").textContent  = "âŒ";
    document.getElementById("fvTitle").textContent = "Verification Failed";
    document.getElementById("fvSub").textContent   = `Could not verify this passport: ${e.message}`;
  }
}

// â”€â”€ AUTO-VERIFY on page load if ?verify= param present â”€â”€â”€â”€â”€
(function fwCheckVerifyParam() {
  const p = new URLSearchParams(location.search);
  const v = p.get("verify");
  if (v) {
    // Wait for ethers to load
    const tryVerify = () => {
      if (typeof getE === "function" && getE()) {
        fwVerifyPassport(v);
      } else {
        setTimeout(tryVerify, 300);
      }
    };
    setTimeout(tryVerify, 500);
  }
})();
// â”€â”€ RENDER DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _rdTimers = []; // track all renderDashboard timers
function renderDashboard(wallet, d, tier) {
  // Cancel any pending deferred renders from previous calls
  _rdTimers.forEach(clearTimeout);
  _rdTimers = [];

  fwCurrentScore = d.score;
  fixDone = [false, false, false];

  // Clear previous threats immediately to release DOM nodes
  const tlPrev = document.getElementById("threatsList");
  if (tlPrev) tlPrev.innerHTML = "";
  // Reset pagination state
  _threatsAll = []; _threatsTier = tier; _threatsShown = 0;

  // Wallet badge
  document.getElementById("walletBadge").textContent = fwShort(wallet);
  document.getElementById("netBadge").textContent = fwNet.toUpperCase();

  // Score gauge (always visible)
  animateScore(d.score, d.scoreLabel, d.scoreMeta);

  // Blast Radius (free = count/text, full = detailed)
  document.getElementById("blastAmt").textContent = d.blastDisplay;
  renderMeta("blastMeta", d.blastMeta);

  // Time-to-Drain
  _rdTimers.push(setTimeout(() => {
    const el = document.getElementById("drainTime");
    if (!el) return;
    el.textContent = d.drainTime;
    el.classList.toggle("drain-fast", !!d.drainFast);
    renderMeta("drainMeta", d.drainMeta);
  }, 300));

  // Exposure Map â€” only render if not already showing (debounced inside function)
  _rdTimers.push(setTimeout(() => renderExposureMap(wallet, d.threats, tier), 350));

  // Threats â€” deferred so DOM is free
  _rdTimers.push(setTimeout(() => {
    renderThreats(d.threats, tier);
    // Remove the rescan banner if revoke buttons are now available
    if (tier === "full" && d.threats.some(t => t.canRevoke)) {
      document.getElementById("fwRescanBanner")?.remove();
    }
  }, 500));

  // Fix Mode
  if (tier === "full") {
    _rdTimers.push(setTimeout(() => renderFixMode(d), 250));
  } else {
    renderFixGainPreview(d.score);
  }

  // Passport
  renderPassport(wallet, d, tier);

  // Rules
  renderRuleTemplates();

  // Re-apply language translations to freshly-rendered dashboard elements
  try {
    const activeLang = document.querySelector(".lang-btn.active")?.getAttribute("data-lang") || "en";
    if (activeLang !== "en") fwSetLanguage(activeLang);
  } catch {}
}

// â”€â”€ SCORE GAUGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _scoreAnimTimer = null; // track to cancel on re-render
function animateScore(target, label, meta) {
  const circumference = 226.2;
  const fill  = document.getElementById("gaugeFill");
  const numEl = document.getElementById("scoreNum");
  const labEl = document.getElementById("scoreLabel");
  const dotEl = document.getElementById("scoreDot");

  const color = target < 45 ? "#ff4757" : target < 70 ? "#ffd166" : "#3cffb0";
  fill.style.stroke = color;
  dotEl.style.background = color;

  // Cancel any previous animation to prevent multiple intervals
  if (_scoreAnimTimer) { clearInterval(_scoreAnimTimer); _scoreAnimTimer = null; }

  let cur = 0;
  const step = target / 35;
  _scoreAnimTimer = setInterval(() => {
    cur = Math.min(cur + step, target);
    numEl.textContent = Math.round(cur);
    fill.style.strokeDashoffset = circumference - (circumference * cur / 100);
    if (cur >= target) {
      clearInterval(_scoreAnimTimer);
      _scoreAnimTimer = null;
      labEl.textContent = fwGetScoreLabel(label);
      renderMeta("scoreMeta", meta);
    }
  }, 28);
}

function renderMeta(id, items) {
  const el = document.getElementById(id);
  if (!el || !items) return;
  el.innerHTML = items.map(i => `<div class="meta-chip ${i.cls}">${esc(i.label)}</div>`).join("");
}

// â”€â”€ EXPOSURE MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _lastExposureHash = "";  // debounce exposure map re-renders
function renderExposureMap(wallet, threats, tier) {
  const svg = document.getElementById("exposureMap");
  if (!svg) return;
  const W = 480, H = 260, cx = W/2, cy = H/2;
  const riskColor = { bad:"#ff4757", warn:"#ffd166", ok:"#3cffb0" };

  // Cap nodes: free=3, full=max 8
  const visible = tier === "free" ? threats.slice(0, 3) : threats.slice(0, 8);

  // Debounce: don't re-render if data hasn't changed (prevents crash on rapid re-renders)
  const hash = wallet + tier + visible.map(t=>t.risk+t.label).join(",");
  if (hash === _lastExposureHash) return;
  _lastExposureHash = hash;
  const n = visible.length;
  if (!n) { svg.innerHTML = `<text x="${W/2}" y="${H/2}" text-anchor="middle" fill="rgba(244,246,255,.35)" font-size="13" font-family="system-ui">No spenders detected</text>`; return; }

  const pos = visible.map((_, i) => {
    const a = (i/n) * Math.PI*2 - Math.PI/2;
    return { x: cx + 98*Math.cos(a), y: cy + 98*Math.sin(a) };
  });

  const tokPos = [];
  visible.forEach((t, ti) => {
    t.tokens.forEach((tok, ki) => {
      const a = ((ti + ki*.28)/n)*Math.PI*2 - Math.PI/2;
      tokPos.push({ x: cx + 168*Math.cos(a + ki*.32), y: cy + 168*Math.sin(a + ki*.32), name:tok, ti });
    });
  });

  let h = `<defs>
    <radialGradient id="gC" cx="50%" cy="50%" r="50%">
      <stop offset="0%" stop-color="rgba(0,229,255,.4)"/>
      <stop offset="100%" stop-color="rgba(0,229,255,.05)"/>
    </radialGradient>
  </defs>`;

  visible.forEach((t, i) => {
    const p = pos[i];
    const col = riskColor[t.risk] || "#888";
    h += `<line x1="${cx}" y1="${cy}" x2="${p.x}" y2="${p.y}" stroke="${col}" stroke-width="${t.risk==="bad"?2:1.2}" stroke-opacity=".5" stroke-dasharray="4 3"/>`;
  });
  tokPos.forEach(tp => {
    const sp = pos[tp.ti];
    if (!sp) return;
    h += `<line x1="${sp.x}" y1="${sp.y}" x2="${tp.x}" y2="${tp.y}" stroke="rgba(255,255,255,.15)" stroke-width="1"/>`;
  });
  tokPos.forEach(tp => {
    h += `<circle cx="${tp.x}" cy="${tp.y}" r="11" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.18)" stroke-width="1"/>
      <text x="${tp.x}" y="${tp.y}" text-anchor="middle" dominant-baseline="middle" fill="rgba(244,246,255,.75)" font-size="8" font-family="system-ui" font-weight="700">${esc(tp.name).slice(0,6)}</text>`;
  });
  visible.forEach((t, i) => {
    const p = pos[i];
    const col = riskColor[t.risk] || "#888";
    const r   = t.risk === "bad" ? 22 : 17;
    h += `<circle cx="${p.x}" cy="${p.y}" r="${r+8}" fill="${col}" fill-opacity=".06"/>
      <circle cx="${p.x}" cy="${p.y}" r="${r}" fill="rgba(5,6,10,.9)" stroke="${col}" stroke-width="1.5"/>
      <text x="${p.x}" y="${p.y}" text-anchor="middle" dominant-baseline="middle" fill="${col}" font-size="8" font-family="system-ui" font-weight="800">${esc(t.label).split(" ").map(w=>w[0]).join("").slice(0,4)}</text>`;
  });

  // Greyed-out locked spots for free tier
  if (tier === "free" && threats.length > 3) {
    for (let i = 3; i < Math.min(threats.length, 5); i++) {
      const a = (i/threats.length)*Math.PI*2 - Math.PI/2;
      const x = cx + 98*Math.cos(a), y = cy + 98*Math.sin(a);
      h += `<circle cx="${x}" cy="${y}" r="17" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" stroke-width="1" stroke-dasharray="3 3"/>
        <text x="${x}" y="${y}" text-anchor="middle" dominant-baseline="middle" fill="rgba(255,255,255,.22)" font-size="12">ğŸ”’</text>`;
    }
  }

  h += `<circle cx="${cx}" cy="${cy}" r="36" fill="url(#gC)"/>
    <circle cx="${cx}" cy="${cy}" r="28" fill="rgba(0,229,255,.10)" stroke="rgba(0,229,255,.45)" stroke-width="1.5"/>
    <text x="${cx}" y="${cy-5}" text-anchor="middle" dominant-baseline="middle" fill="rgba(0,229,255,.95)" font-size="9" font-family="system-ui" font-weight="900">WALLET</text>
    <text x="${cx}" y="${cy+8}" text-anchor="middle" dominant-baseline="middle" fill="rgba(0,229,255,.65)" font-size="7.5" font-family="ui-monospace,monospace">${esc(fwShort(wallet))}</text>`;

  svg.innerHTML = h;
}

// â”€â”€ THREATS LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Paginated: render PAGE_SIZE at a time to avoid DOM overload
const THREATS_PAGE = 10;
let _threatsAll = [], _threatsTier = "free", _threatsShown = 0;

function renderThreats(threats, tier) {
  _threatsAll   = threats;
  _threatsTier  = tier;
  _threatsShown = 0;
  const el = document.getElementById("threatsList");
  if (!el) return;
  if (!threats.length) {
    el.innerHTML = `<div style="text-align:center;color:var(--muted);padding:24px;font-size:13px">âœ… No significant threats detected.</div>`;
    return;
  }
  el.innerHTML = "";

  // For full-tier: if ALL threats lack a spender address (canRevoke=false),
  // the API returned preview-style data. Show a prominent Rescan button
  // so the user can manually trigger fetchApprovals (this is known to work).
  const hasRevokable = threats.some(t => t.canRevoke);
  const hasApproval  = threats.some(t => t.hasApproval);
  if (tier === "full" && !hasRevokable && hasApproval) {
    const banner = document.createElement("div");
    banner.id = "fwRescanBanner";
    banner.style.cssText = `
      padding:12px 16px;border-radius:12px;margin-bottom:12px;
      background:rgba(0,229,255,.06);border:1px solid rgba(0,229,255,.2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap`;
    banner.innerHTML = `
      <span style="font-size:12px;color:var(--muted)">
        ğŸ”„ <strong style="color:var(--text)">Full data needed</strong> â€”
        Click to load addresses and enable Revoke buttons.
      </span>
      <button onclick="fwRescanFull()" style="padding:6px 16px;border-radius:8px;
        border:1px solid rgba(0,229,255,.35);background:rgba(0,229,255,.08);
        color:var(--cyan);font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap">
        Load Data â†º
      </button>`;
    el.appendChild(banner);
  }

  _threatsAppendPage();
}

function _buildThreatCard(t, i, tier) {
  const isLocked = tier !== "full" && i >= 3;
  const itemClass = !t.hasApproval ? "t-info"
                  : t.compositeRisk >= 40 ? "t-critical"
                  : t.compositeRisk >= 10 ? "t-high" : "";
  const approvalBadge = t.hasApproval
    ? (t.isUnlimited
        ? `<span class="sig bad"><span class="sig-dot"></span>âˆ Unlimited</span>`
        : `<span class="sig warn"><span class="sig-dot"></span>Capped</span>`)
    : `<span class="sig ok"><span class="sig-dot"></span>No Approval</span>`;
  const contractBadge = `<span class="sig ${t.risk}"><span class="sig-dot"></span>${esc(t.contractLabel||t.label)}</span>`;
  const drainRow = t.hasApproval
    ? `<span class="threat-drain ${t.risk==="bad"?"bad":t.isUnlimited?"warn":"ok"}">${esc(t.drainLabel||"â€”")}</span>`
    : `<span class="threat-drain ok">No drain risk â€” no active approval</span>`;
  const tokenChip = t.symbol ? `<span class="threat-chip">Token: ${esc(t.symbol)}</span>` : "";
  let actionBtn = "";
  if (tier === "full" && t.canRevoke) {
    // Have both addresses â€” real on-chain revoke
    actionBtn = `<button class="btn-fix-small" onclick="revokeSpender('${esc(t.fullSpender)}','${esc(t.token)}',this)">Revoke â†—</button>`;
  } else if (tier === "free" && t.hasApproval) {
    // Not unlocked yet â€” prompt upgrade
    actionBtn = `<button class="btn-fix-small" onclick="requestFullAccess()" style="border-color:rgba(124,92,255,.4);color:#a87eff">Unlock â†—</button>`;
  }
  // tier=full + hasApproval + !canRevoke â†’ no button here; handled by fwRescanBanner above
  const lockedAttr = isLocked ? ' data-locked="1"' : '';
  return `<div class="threat-item ${itemClass}${isLocked?" locked-card":""}"${lockedAttr}>
    <div class="threat-top">
      <div style="flex:1;min-width:0">
        <div class="threat-name">${esc(t.name)}</div>
        <div class="threat-meta" style="margin-top:5px">
          ${approvalBadge}${contractBadge}${tokenChip}
        </div>
      </div>
      <div style="text-align:right;flex:0 0 auto;display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        ${actionBtn}
      </div>
    </div>
    <div class="threat-info-row">${drainRow}</div>
  </div>`;
}

function _threatsAppendPage() {
  const el = document.getElementById("threatsList");
  if (!el) return;
  // Remove old "Show More" button if present
  document.getElementById("threatsShowMoreBtn")?.remove();

  const end = Math.min(_threatsShown + THREATS_PAGE, _threatsAll.length);
  const frag = document.createDocumentFragment();
  for (let i = _threatsShown; i < end; i++) {
    const div = document.createElement("div");
    div.innerHTML = _buildThreatCard(_threatsAll[i], i, _threatsTier);
    frag.appendChild(div.firstElementChild);
  }
  el.appendChild(frag);
  _threatsShown = end;

  if (_threatsShown < _threatsAll.length) {
    const remaining = _threatsAll.length - _threatsShown;
    const btn = document.createElement("button");
    btn.id = "threatsShowMoreBtn";
    btn.className = "btn-fix-small";
    btn.style.cssText = "display:block;width:100%;margin-top:10px;padding:10px;border-color:rgba(255,255,255,.15);color:var(--muted)";
    btn.textContent = `Show ${Math.min(remaining, THREATS_PAGE)} more of ${remaining} remaining â†“`;
    btn.onclick = _threatsAppendPage;
    el.appendChild(btn);
  }
}

// â”€â”€ FIX MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFixMode(d) {
  // Update step descriptions to show real spenders
  if (fixApprovals[0]) {
    const el = document.querySelector("#fixStep1 .fix-step-desc");
    if (el) el.textContent = `Remove unlimited allowance from ${fwShort(fixApprovals[0].spender)} (top-risk spender on ${fixApprovals[0].symbol}).`;
  }
  if (fwScanData?.unlimitedCount > 0) {
    const el = document.querySelector("#fixStep2 .fix-step-desc");
    if (el) el.textContent = `Revoke all ${fwScanData.unlimitedCount} unlimited approval(s) on this wallet â€” one on-chain tx each.`;
  }

  // Update button 1 to direct revoke if wallet connected
  const btn1 = document.getElementById("btnFix1");
  if (btn1 && window.wallet?.address && fixApprovals[0]) {
    btn1.textContent = `Revoke ${fixApprovals[0].symbol} spender`;
  }

  renderFixGainPreview(d.score);
}

function renderFixGainPreview(score) {
  const total = scoreIncrements.reduce((a,b)=>a+b,0);
  const newScore = Math.min(100, score + total);
  const el = document.getElementById("fixGain");
  if (el) el.style.display = "flex";
  const ns = document.getElementById("fixNewScore");
  if (ns) ns.textContent = newScore;
  const fd = document.getElementById("fixDelta");
  if (fd) fd.textContent = total;
}

// â”€â”€ SHARED: score update after fix step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwUpdateScoreAfterFix(step) {
  fwCurrentScore = Math.min(100, fwCurrentScore + scoreIncrements[step]);
  document.getElementById("scoreNum").textContent = fwCurrentScore;
  const c = 226.2;
  document.getElementById("gaugeFill").style.strokeDashoffset = c - (c * fwCurrentScore / 100);
  const col = fwCurrentScore < 45 ? "#ff4757" : fwCurrentScore < 70 ? "#ffd166" : "#3cffb0";
  document.getElementById("gaugeFill").style.stroke = col;
  document.getElementById("scoreDot").style.background = col;
  document.getElementById("scoreLabel").textContent = fwCurrentScore >= 85 ? "Protected" : fwCurrentScore >= 70 ? "Exposed" : "Vulnerable";
  const pp = document.getElementById("ppScore");
  if (pp) { pp.textContent = fwCurrentScore; pp.style.color = col; }
  if (fixDone.every(Boolean)) {
    const fc = document.getElementById("fixComplete"); if (fc) fc.style.display = "flex";
    const fs = document.getElementById("finalScore");  if (fs) fs.textContent = fwCurrentScore;
  }
}


// â”€â”€ WALLET MISMATCH CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwCheckWalletMatch(btn) {
  const connected = window.wallet?.address?.toLowerCase().trim();
  const scanned   = fwWallet?.toLowerCase().trim();
  if (!connected) return true; // no wallet connected yet â€” let normal gate handle it
  if (!scanned || scanned === DEMO_WALLET.toLowerCase()) return true; // demo mode â€” ok
  if (connected === scanned) return true; // same wallet â€” ok
  // MISMATCH â€” show error
  const connShort = window.wallet.address.slice(0,8)+"â€¦"+window.wallet.address.slice(-5);
  const scanShort = fwWallet.slice(0,8)+"â€¦"+fwWallet.slice(-5);
  if (btn) {
    const origText = btn.textContent;
    btn.textContent = `âš  Connected: ${connShort} â‰  Scanned: ${scanShort}`;
    btn.style.background = "rgba(255,71,87,.18)";
    btn.style.borderColor = "rgba(255,71,87,.5)";
    btn.style.color = "#ff7a8a";
    setTimeout(() => {
      btn.textContent = origText;
      btn.style.background = "";
      btn.style.borderColor = "";
      btn.style.color = "";
    }, 4000);
  }
  showPassportMsg(`âš  Wallet mismatch: you're connected as ${connShort} but scanning ${scanShort}. Connect the scanned wallet to revoke.`);
  return false;
}
async function applyFix(step) {
  if (fixDone[step]) return;
  if (fwAccessTier !== "full" || !_fwAccessVerified) { requestFullAccess(); return; }

  const el  = document.getElementById(`fixStep${step+1}`);
  const btn = document.getElementById(`btnFix${step+1}`);
  if (!el || !btn) return;

  const target = fixApprovals[step];

  // â”€â”€ STEP 0: Revoke top spender on-chain (approve â†’ 0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (step === 0) {
    if (!window.wallet?.signer) { requestFullAccess(); return; }
    if (!fwCheckWalletMatch(btn)) return;
    if (!target?.token || !target?.spender) {
      btn.textContent = "âœ“ No target found"; btn.disabled = true; el.classList.add("step-done");
      fixDone[0] = true; fwUpdateScoreAfterFix(0); return;
    }
    btn.disabled = true; btn.textContent = "Sending revoke txâ€¦";
    try {
      const E = getE();
      await fwEnsureBsc(window.wallet.providerRaw);
      const c = new E.Contract(fwNorm(target.token), ERC20_APPROVE_ABI, window.wallet.signer);
      const tx = await c.approve(fwNorm(target.spender), 0n);
      btn.textContent = `Pendingâ€¦ ${tx.hash?.slice(0,10)}`;
      await tx.wait();
      btn.textContent = "âœ“ Revoked";
    } catch(e) {
      if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
        btn.disabled = false; btn.textContent = "Revoke (retry)"; return;
      }
      btn.textContent = "âœ— Failed â€” retry"; btn.disabled = false;
      showPassportMsg(`âš  Revoke failed: ${e.message?.slice(0,80)}`); return;
    }

  // â”€â”€ STEP 1: Revoke ALL unlimited approvals (like DNA revokeAll) â”€â”€â”€
  } else if (step === 1) {
    if (!window.wallet?.signer) { requestFullAccess(); return; }
    if (!fwCheckWalletMatch(btn)) return;
    const rows = fwScanData?.rows || [];
    const unlimitedRows = rows.filter(r => isUnlimitedAllow(r.allow) && r.token && r.spender);
    if (!unlimitedRows.length) {
      btn.textContent = "âœ“ No unlimited to revoke"; btn.disabled = true; el.classList.add("step-done");
      fixDone[1] = true; fwUpdateScoreAfterFix(1); return;
    }
    btn.disabled = true;
    await fwEnsureBsc(window.wallet.providerRaw);
    const E = getE();
    let done = 0, failed = 0;
    for (let i = 0; i < unlimitedRows.length; i++) {
      const r = unlimitedRows[i];
      try {
        btn.textContent = `Revoking ${i+1}/${unlimitedRows.length}â€¦`;
        const c = new E.Contract(fwNorm(r.token), ERC20_APPROVE_ABI, window.wallet.signer);
        const tx = await c.approve(fwNorm(r.spender), 0n);
        btn.textContent = `Pending ${i+1}/${unlimitedRows.length}â€¦`;
        await tx.wait();
        done++;
      } catch(e) {
        if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
          btn.disabled = false; btn.textContent = `Revoke All (${done} done â€” retry)`;
          showPassportMsg(`âš  Cancelled after ${done} revokes. Press again to continue.`);
          // Store undo data for what was done so far
          window.__fwUndoData = window.__fwUndoData || {};
          window.__fwUndoData[1] = { all: unlimitedRows.slice(0, done) };
          if (done > 0) {
            const undoBtn1 = document.getElementById("undoFix2");
            if (undoBtn1) undoBtn1.style.display = "block";
          }
          return;
        }
        failed++;
      }
    }
    btn.textContent = failed === 0
      ? `âœ“ All ${done} revoked`
      : `âœ“ ${done} revoked (${failed} failed)`;
    // Store undo data
    window.__fwUndoData = window.__fwUndoData || {};
    window.__fwUndoData[1] = { all: unlimitedRows };
    showPassportMsg(`âœ… Revoke All: ${done} approval(s) revoked${failed>0?`, ${failed} failed`:""}. Re-scan to verify.`);

  // â”€â”€ STEP 2: Flag top risky to local watchlist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  } else if (step === 2) {
    const watchTarget = fixApprovals[2] || fixApprovals[1] || fixApprovals[0];
    if (watchTarget?.spender) {
      try {
        const existing = JSON.parse(localStorage.getItem("cx_watchlist") || "[]");
        const key = `${fwNet}:${watchTarget.spender}`;
        if (!existing.find(x => `${x.net}:${x.spender}` === key))
          existing.unshift({ spender: watchTarget.spender, token: watchTarget.token,
            symbol: watchTarget.symbol, addedAt: new Date().toISOString(), net: fwNet });
        localStorage.setItem("cx_watchlist", JSON.stringify(existing.slice(0, 50)));
      } catch {}
    }
    btn.textContent = "âœ“ Added to local watchlist";
    btn.disabled = true; el.classList.add("step-done"); fixDone[2] = true;
    const undoBtn3 = document.getElementById("undoFix3");
    if (undoBtn3) undoBtn3.style.display = "block";
    fwUpdateScoreAfterFix(2);
    return;
  }

  fixDone[step] = true;
  btn.disabled = true; btn.classList.add("done"); el.classList.add("step-done");

  // Show undo button
  const undoBtn = document.getElementById(`undoFix${step+1}`);
  if (undoBtn) {
    undoBtn.style.display = "block";
    window.__fwUndoData = window.__fwUndoData || {};
    if (!window.__fwUndoData[step])
      window.__fwUndoData[step] = target
        ? { spender: target.spender, token: target.token, decimals: Number(target.decimals)||18 }
        : null;
  }

  fwUpdateScoreAfterFix(step);
}

// â”€â”€ UNDO FIX STEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function undoFix(step) {
  const undoBtn = document.getElementById(`undoFix${step+1}`);
  const fixBtn  = document.getElementById(`btnFix${step+1}`);
  const el      = document.getElementById(`fixStep${step+1}`);

  // Step 2 = localStorage â€” no wallet needed
  if (step === 2) {
    try { localStorage.removeItem("cx_watchlist"); } catch {}
    if (undoBtn) undoBtn.style.display = "none";
    fixDone[2] = false;
    el?.classList.remove("step-done");
    if (fixBtn) { fixBtn.textContent = "Add to Watchlist"; fixBtn.disabled = false; fixBtn.classList.remove("done"); }
    fwCurrentScore = Math.max(0, fwCurrentScore - scoreIncrements[2]);
    document.getElementById("scoreNum").textContent = fwCurrentScore;
    showPassportMsg("â†© Watchlist entry removed.");
    return;
  }

  if (!window.wallet?.signer) { requestFullAccess(); return; }
  const data = window.__fwUndoData?.[step];
  const MAX_UINT = 2n**256n - 1n;

  // Build targets list: step 1 = all array, step 0 = single item
  const targets = (step === 1 && data?.all?.length) ? data.all
    : (data?.token && data?.spender) ? [data] : [];

  if (!targets.length) { showPassportMsg("âš  No undo data for this step."); return; }

  if (undoBtn) { undoBtn.disabled = true; undoBtn.textContent = `Restoring ${targets.length === 1 ? "approval" : targets.length + " approvals"}â€¦`; }
  const E = getE();
  let done = 0, failed = 0;

  for (const t of targets) {
    try {
      if (undoBtn && targets.length > 1) undoBtn.textContent = `Restoring ${done+1}/${targets.length}â€¦`;
      const c = new E.Contract(fwNorm(t.token), ERC20_APPROVE_ABI, window.wallet.signer);
      const tx = await c.approve(fwNorm(t.spender), MAX_UINT);
      await tx.wait();
      done++;
    } catch(e) {
      if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
        if (undoBtn) { undoBtn.disabled = false; undoBtn.textContent = `â†© Retry undo (${done} done)`; }
        showPassportMsg(`â†© Cancelled. ${done} approval(s) restored.`);
        return;
      }
      failed++;
    }
  }

  if (undoBtn) undoBtn.style.display = "none";
  fixDone[step] = false;
  el?.classList.remove("step-done");
  if (fixBtn) {
    fixBtn.textContent = step === 0 ? "Revoke Top Spender" : "Revoke All Unlimited";
    fixBtn.disabled = false; fixBtn.classList.remove("done");
  }
  fwCurrentScore = Math.max(0, fwCurrentScore - scoreIncrements[step]);
  document.getElementById("scoreNum").textContent = fwCurrentScore;
  const col2 = fwCurrentScore < 45 ? "#ff4757" : fwCurrentScore < 70 ? "#ffd166" : "#3cffb0";
  document.getElementById("gaugeFill").style.stroke = col2;
  document.getElementById("scoreDot").style.background = col2;
  delete window.__fwUndoData[step];
  showPassportMsg(`â†© Undo: ${done} approval(s) restored to unlimited${failed>0?`, ${failed} failed`:""}. Re-scan to verify.`);
}

// Re-fetch full approvals for already-unlocked users (called automatically on unlock)
async function fwRescanFull() {
  // Primary guard: _fwAccessVerified (closure var, tamper-proof)
  // fwAccessTier check is secondary â€” may lag if let binding quirk
  if (!fwWallet || !fwNet || !_fwAccessVerified) return;
  if (fwWallet === DEMO_WALLET) return;
  const scoreRing = document.getElementById("scoreVal");
  if (scoreRing) scoreRing.textContent = "â€¦";
  // Show loading in threats list
  const tlEl = document.getElementById("threatsList");
  if (tlEl) tlEl.innerHTML = `<div style="text-align:center;color:var(--cyan);padding:20px;font-size:13px">ğŸ” Loading full approval dataâ€¦</div>`;
  try {
    const approvals = await fetchApprovals(fwNet, fwWallet);

    const metrics   = computeMetrics(approvals);
    fwScanData      = metrics;
    fwCurrentScore  = metrics.score;
    fixApprovals    = metrics.fixTargets || [];
    const revokable = metrics.threats?.filter(t=>t.canRevoke).length || 0;
    const noAddr    = metrics.threats?.filter(t=>t.hasApproval && !t.canRevoke).length || 0;
    renderDashboard(fwWallet, metrics, "full");
    renderFixMode(metrics);
    fwInitExport();
    // Re-apply language after fresh render
    try {
      const al = document.querySelector(".lang-btn.active")?.getAttribute("data-lang") || "en";
      if (al !== "en") fwSetLanguage(al);
    } catch {}
    showPassportMsg(revokable > 0
      ? `âœ… Full data loaded â€” ${revokable} approval(s) ready to revoke.`
      : noAddr > 0
        ? "âš  Approvals found but addresses missing from API. Open DevTools > Console for details."
        : "âœ… Full data loaded.");
  } catch(e) {
    const is500 = e?.message?.includes("500") || e?.status === 500 || String(e).includes("500");

    const tlEl2 = document.getElementById("threatsList");
    if (tlEl2) tlEl2.innerHTML = `
      <div style="padding:16px;border-radius:12px;background:rgba(255,100,80,.06);
           border:1px solid rgba(255,100,80,.2);">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:${is500?'10px':'0'}">
          <span style="font-size:13px;color:#ff9a6b">
            ${is500 ? 'âš  Server error (500) â€” /api/getApprovals is down.' : 'âš  Could not load full approval data.'}
          </span>
          <button onclick="fwRescanFull()" style="padding:6px 14px;border-radius:8px;
            border:1px solid rgba(255,150,100,.4);background:rgba(255,150,100,.08);
            color:#ff9a6b;font-size:12px;font-weight:700;cursor:pointer;flex:0 0 auto;white-space:nowrap">
            Retry â†º
          </button>
        </div>
        ${is500 ? `<div style="font-size:11px;color:var(--muted);line-height:1.5">
          The backend Worker returned a 500 error on <code style="color:var(--cyan)">/api/getApprovals</code>.<br>
          The approval data exists (preview loaded correctly) but the full endpoint has a server-side bug.<br>
          This must be fixed in the Worker â€” not the frontend.
        </div>` : ''}
      </div>`;
    const scoreRing2 = document.getElementById("scoreVal");
    if (scoreRing2) scoreRing2.textContent = fwScanData?.score ?? "â€”";
  }
}

async function revokeSpender(spender, token, btn) {
  if (!window.wallet?.signer) { requestFullAccess(); return; }
  if (!fwCheckWalletMatch(btn)) return;
  btn.disabled = true; btn.textContent = "Sendingâ€¦";
  try {
    const E = getE();
    const c = new E.Contract(fwNorm(token), ERC20_APPROVE_ABI, window.wallet.signer);
    const tx = await c.approve(fwNorm(spender), 0n);
    btn.textContent = "Pendingâ€¦";
    await tx.wait();
    btn.textContent = "âœ“ Revoked";
    btn.classList.add("done");
  } catch(e) {
    btn.disabled = false;
    btn.textContent = "Retry â†—";
    showPassportMsg(`âš  Revoke failed: ${e.message?.slice(0,80)}`);
    // Note: revoke.cash line removed â€” all revokes happen on-chain via this site
  }
}

// â”€â”€ PASSPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPassport(wallet, d, tier) {
  document.getElementById("ppWallet").textContent = fwShort(wallet) + " Â· " + fwNet.toUpperCase();
  document.getElementById("ppScore").textContent = d.score;
  document.getElementById("ppApprovals").textContent = d.riskyApprovals;
  document.getElementById("ppBlast").textContent = d.unlimitedCount > 0 ? `${d.unlimitedCount} unlimited` : "Clean";
  document.getElementById("ppDrain").textContent = d.drainTime;
  document.getElementById("ppDate").textContent = "Scanned: " + today();
  document.getElementById("ppChain").textContent = fwNet.toUpperCase();

  const sc = d.score;
  const scoreEl = document.getElementById("ppScore");
  if (scoreEl) scoreEl.style.color = sc < 45 ? "#ff4757" : sc < 70 ? "#ffd166" : "#3cffb0";

  const statusEl = document.getElementById("ppStatus");
  if (sc < 45) {
    statusEl.textContent = "ğŸ§¨ Critical";
    statusEl.style.cssText = "border-color:rgba(255,71,87,.4);color:#ff6b6b;background:rgba(255,71,87,.10)";
  } else if (sc < 70) {
    statusEl.textContent = "âš  Exposed";
    statusEl.style.cssText = "border-color:rgba(255,193,7,.35);color:#ffd166;background:rgba(255,193,7,.10)";
  } else {
    statusEl.textContent = "âœ… Protected";
    statusEl.style.cssText = "border-color:rgba(93,255,178,.35);color:var(--green);background:rgba(93,255,178,.08)";
  }

  // Watermark: show for free, hide for full
  const wm = document.getElementById("ppWatermark");
  if (wm) wm.style.display = tier === "free" ? "flex" : "none";
}

function getPassportText() {
  const score   = document.getElementById("ppScore")?.textContent || "â€”";
  const blast   = document.getElementById("ppBlast")?.textContent || "â€”";
  const drain   = document.getElementById("ppDrain")?.textContent || "â€”";
  const net     = document.getElementById("ppChain")?.textContent || fwNet.toUpperCase();
  const risky   = document.getElementById("ppApprovals")?.textContent || "â€”";
  return `ğŸ”¥ CycleX Firewall Scan â€” ${today()}

Wallet: ${fwShort(fwWallet)}
Network: ${net}

ğŸ›¡ Firewall Score: ${score}/100
ğŸ’¥ Blast Radius: ${blast}
â± Drain Time: ${drain}
ğŸ¯ Risky Approvals: ${risky}

Scan your wallet â†’ https://cyclex.io/firewall
#CycleX #WalletSecurity #DeFi`;
}


// â”€â”€ RULE CONFIRMATION MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fwShowRuleConfirm(title, warning, txLines, note, onConfirm) {
  const modal   = document.getElementById("fwRuleConfirmModal");
  const titleEl = document.getElementById("rcTitle");
  const warnEl  = document.getElementById("rcWarning");
  const txEl    = document.getElementById("rcTxList");
  const noteEl  = document.getElementById("rcNote");
  const confirmBtn = document.getElementById("rcConfirmBtn");
  const cancelBtn  = document.getElementById("rcCancelBtn");
  if (!modal) { onConfirm(); return; } // fallback if HTML missing

  titleEl.textContent = title;
  warnEl.innerHTML    = warning;
  txEl.innerHTML      = txLines.map(l => `<div>${esc(l)}</div>`).join("");
  noteEl.innerHTML    = note;

  modal.style.display = "flex";

  // Remove old listeners
  const newConfirm = confirmBtn.cloneNode(true);
  const newCancel  = cancelBtn.cloneNode(true);
  confirmBtn.replaceWith(newConfirm);
  cancelBtn.replaceWith(newCancel);

  newConfirm.addEventListener("click", () => {
    modal.style.display = "none";
    onConfirm();
  });
  newCancel.addEventListener("click", () => {
    modal.style.display = "none";
  });

  // Close on backdrop
  modal.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };
}
// â”€â”€ RULE TEMPLATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var RULES = [
  {
    name:"ğŸ”’ Strict",
    desc:"No unlimited. Cap $50 for unknown spenders. Alerts on any new spender.",
    action:"strict",          // revoke all unlimited + cap unknowns at 50
    activeLabel:"ğŸ”’ Strict Protection Active"
  },
  {
    name:"âš– Balanced",
    desc:"Cap $200 for unknown spenders. Whitelist major DEXes. Weekly review.",
    action:"balanced",        // cap unknowns at 200
    activeLabel:"âš– Balanced Protection Active"
  },
  {
    name:"ğŸ“ˆ Trader",
    desc:"Allow known DEX unlimited. Alert on fresh/unknown spenders.",
    action:"trader",          // save watchlist profile locally
    activeLabel:"ğŸ“ˆ Trader Profile Active"
  }
];

// State: which rule is active per session
var ruleActive = [false, false, false];

function renderRuleTemplates() {
  const el = document.getElementById("ruleTemplates");
  if (!el) return;
  el.innerHTML = RULES.map((r, i) => _ruleCardHTML(r, i, ruleActive[i])).join("");
}

function _ruleCardHTML(r, i, isActive) {
  const borderStyle = isActive ? "border:1.5px solid rgba(93,255,178,.35)" : "border:1px solid rgba(255,255,255,.10)";
  const btnHTML = isActive
    ? `<div style="display:flex;flex-direction:column;gap:6px">
        <div style="font-size:11px;font-weight:800;color:var(--green);letter-spacing:.08em;padding:8px 0 4px">âœ“ ${r.activeLabel}</div>
        <button class="btn-action" id="ruleBtn${i}"
          style="font-size:10px;background:rgba(255,100,50,.08);border-color:rgba(255,100,50,.3);color:#ff9a6b"
          onclick="window.undoRule(${i})">â†© Deactivate</button>
       </div>`
    : `<button class="btn-action" id="ruleBtn${i}" style="font-size:10px"
        onclick="window.applyRule(${i})">Apply Template</button>`;
  return `
    <div data-rule-card="${i}" style="background:rgba(255,255,255,.03);${borderStyle};border-radius:16px;padding:16px 14px;transition:border .3s">
      <div style="font-size:14px;font-weight:800;margin-bottom:6px">${r.name}</div>
      <div style="font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:12px">${r.desc}</div>
      ${btnHTML}
    </div>`;
}

async function applyRule(i) {
  const rule = RULES[i];
  const btn = document.getElementById(`ruleBtn${i}`);
  if (!btn || btn.disabled) return;

  // â”€â”€ Trader: local watchlist profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (rule.action === "trader") {
    try {
      localStorage.setItem("cx_rule_profile", JSON.stringify({
        profile: rule.name, appliedAt: new Date().toISOString(), net: fwNet
      }));
    } catch {}
    ruleActive[i] = true;
    _refreshRuleCard(i);
    showPassportMsg(`âœ… Trader profile activated â€” unknown spenders will be flagged.`);
    return;
  }

  // â”€â”€ Strict & Balanced: on-chain â€” need wallet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!_fwAccessVerified || !window.wallet?.signer) { requestFullAccess(); return; }
  if (!fwScanData?.rows || fwScanData.rows.length === 0) {
    showPassportMsg("âš  No approval data loaded. Run a scan first."); return;
  }

  // â”€â”€ WALLET MISMATCH CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!fwCheckWalletMatch(btn)) return;

  const E = getE();
  const allUnlimited = fwScanData.rows.filter(r => isUnlimitedAllow(r.allow));
  const unknowns     = allUnlimited.filter(r => r.verified === false);
  const CAP_STRICT   = 50n;
  const CAP_BALANCED = 200n;

  let targets = [];
  if (rule.action === "strict") {
    targets = allUnlimited.map(r => ({ ...r, amount: 0n }));
  } else {
    // balanced: cap unknowns to 200 tokens (reduces from unlimited to capped)
    targets = unknowns.map(r => ({
      ...r, amount: CAP_BALANCED * (10n ** BigInt(Number(r.decimals)||18))
    }));
  }

  if (!targets.length) {
    ruleActive[i] = true; _refreshRuleCard(i);
    showPassportMsg(`âœ… "${rule.name}" active â€” no matching approvals to fix right now.`);
    return;
  }

  // â”€â”€ SHOW CONFIRMATION DIALOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const actionVerb  = rule.action === "strict" ? "REVOKE (set to 0)" : "CAP TO 200 tokens";
  const actionColor = rule.action === "strict" ? "#ff7a8a" : "#ffd166";
  const txLines     = targets.map(t =>
    `${actionVerb}: ${t.symbol||"TOKEN"} â†’ ${fwShort(t.spender)}`
  );

  const warningText = rule.action === "strict"
    ? `âš ï¸ <strong>Strict mode</strong> will REVOKE <strong>${targets.length}</strong> unlimited approval(s) to 0. Each approval requires a separate transaction costing a small gas fee (~$0.01 each). <br><br>MetaMask will show "<em>Spending cap: 0</em>" â€” this means you are <strong>removing</strong> the permission, not giving new access.`
    : `âš ï¸ <strong>Balanced mode</strong> will cap <strong>${targets.length}</strong> unverified unlimited approval(s) to 200 tokens each. <br><br>MetaMask will show "<em>Spending cap: 200 [TOKEN]</em>" â€” this <strong>reduces</strong> an existing unlimited permission to 200. You are <strong>NOT</strong> granting new access to anyone.`;

  const note = `â„¹ The connected wallet <strong style="color:var(--cyan)">${fwShort(window.wallet.address)}</strong> will sign ${targets.length} transaction(s). This is the wallet whose approvals are being modified.`;

  fwShowRuleConfirm(rule.name, warningText, txLines, note, async () => {
    // â”€â”€ EXECUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    btn.disabled = true; btn.textContent = "Preparingâ€¦";
    await fwEnsureBsc(window.wallet.providerRaw);

    let done = 0, failed = 0;
    for (let j = 0; j < targets.length; j++) {
      const t = targets[j];
      try {
        btn.textContent = `${j+1}/${targets.length} sendingâ€¦`;
        const c = new E.Contract(fwNorm(t.token), ERC20_APPROVE_ABI, window.wallet.signer);
        const tx = await c.approve(fwNorm(t.spender), t.amount);
        btn.textContent = `${j+1}/${targets.length} pendingâ€¦`;
        await tx.wait();
        done++;
      } catch(e) {
        if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
          btn.disabled = false; btn.textContent = "Cancelled â€” retry";
          showPassportMsg(`âš  Cancelled after ${done} tx(s). Press Apply to continue.`);
          return;
        }
        failed++;
      }
    }

    // Store undo data (revoke back to 0 on deactivate, NOT unlimited)
    window.__fwRuleUndoData = window.__fwRuleUndoData || {};
    window.__fwRuleUndoData[i] = targets;

    ruleActive[i] = true;
    _refreshRuleCard(i);
    showPassportMsg(`âœ… "${rule.name}" active â€” ${done} approval(s) updated${failed>0?`, ${failed} failed`:""}. Re-scan to verify.`);
  });
}

function _refreshRuleCard(i) {
  const el = document.getElementById("ruleTemplates");
  if (!el) return;
  const card = el.querySelector(`[data-rule-card="${i}"]`);
  if (!card) { el.innerHTML = RULES.map((r, j) => _ruleCardHTML(r, j, ruleActive[j])).join(""); return; }
  const tmp = document.createElement("div");
  tmp.innerHTML = _ruleCardHTML(RULES[i], i, ruleActive[i]);
  card.replaceWith(tmp.firstElementChild);
}

// â”€â”€ UNDO / DEACTIVATE RULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function undoRule(i) {
  const rule = RULES[i];

  // Trader = local only
  if (rule.action === "trader") {
    try { localStorage.removeItem("cx_rule_profile"); } catch {}
    ruleActive[i] = false; _refreshRuleCard(i);
    showPassportMsg("â†© Trader profile deactivated.");
    return;
  }

  if (!window.wallet?.signer) { requestFullAccess(); return; }
  if (!fwCheckWalletMatch(null)) {
    showPassportMsg('âš  Connect the scanned wallet to deactivate this rule.');
    return;
  }
  const targets = window.__fwRuleUndoData?.[i];
  if (!targets?.length) {
    // No stored data â€” just deactivate visually
    ruleActive[i] = false; _refreshRuleCard(i);
    showPassportMsg("â†© Rule deactivated (no on-chain changes to reverse â€” re-scan to verify).");
    return;
  }

  const btn = document.getElementById(`ruleBtn${i}`);
  if (btn) { btn.disabled = true; btn.textContent = "Restoringâ€¦"; }

  // âš  Safety: deactivate sets approvals to 0 (REVOKE), NOT back to unlimited.
  // Restoring unlimited would be MORE dangerous than the capped state.
  const E = getE();
  let done = 0, failed = 0;

  for (let j = 0; j < targets.length; j++) {
    const t = targets[j];
    try {
      if (btn) btn.textContent = `${j+1}/${targets.length} revokingâ€¦`;
      const c = new E.Contract(fwNorm(t.token), ERC20_APPROVE_ABI, window.wallet.signer);
      // Revoke to 0 â€” do NOT restore unlimited (that would increase risk)
      const tx = await c.approve(fwNorm(t.spender), 0n);
      await tx.wait();
      done++;
    } catch(e) {
      if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
        if (btn) { btn.disabled = false; btn.textContent = "â†© Retry deactivate"; }
        showPassportMsg(`âš  Cancelled after ${done} revoke(s).`);
        return;
      }
      failed++;
    }
  }

  delete window.__fwRuleUndoData[i];
  ruleActive[i] = false; _refreshRuleCard(i);
  showPassportMsg(`â†© "${rule.name}" deactivated â€” ${done} approval(s) fully revoked to 0. Re-scan to verify.`);
}

window.undoFix    = undoFix;
window.undoRule   = undoRule;
window.ruleActive = ruleActive;   // expose for tests
window.RULES      = RULES;        // expose for tests
// Wrap exports with runtime access guard (prevents console bypass)
window.fwExportCSV  = _fwGuardExport(window.fwExportCSV  || (()=>{}));
window.fwExportJSON = _fwGuardExport(window.fwExportJSON || (()=>{}));
window.fwCopyReport = _fwGuardExport(window.fwCopyReport || (()=>{}));

// Freeze window.unlockFull so it can't be replaced from console
try {
  Object.defineProperty(window, 'unlockFull', {
    get: () => unlockFull,
    set: () => { console.warn('[CycleX] Cannot override unlockFull.'); },
    configurable: false
  });
} catch(e) {}

// Periodic integrity check â€” detect if state was tampered
// Security anti-tamper check â€” only runs when dashboard is visible
let _secCheckInterval = null;
function _startSecCheck() {
  if (_secCheckInterval) return;
  _secCheckInterval = setInterval(() => {
    const dash = document.getElementById("dashboard");
    if (!dash || dash.style.display === "none") return; // skip when hidden
    const tier = typeof fwAccessTier !== 'undefined' ? fwAccessTier : 'free';
    if (tier === 'full' && !_fwAccessVerified) {
      document.getElementById("fixLockOverlay")    ?.style && (document.getElementById("fixLockOverlay").style.display    = "flex");
      document.getElementById("passportLockOverlay")?.style && (document.getElementById("passportLockOverlay").style.display = "flex");
      document.getElementById("tierBadge")?.style  && (document.getElementById("tierBadge").style.display  = "none");
      document.getElementById("btnTopAccess")?.style && (document.getElementById("btnTopAccess").style.display = "block");
      fwUpdateExportVisibility();
    }
  }, 5000); // every 5s instead of 3.5s â€” less CPU
}
_startSecCheck();
function getDemoApprovals() {
  return [
    { token:"0xdAC17F958D2ee523a2206206994597C13D831ec7", spender:"0x1111111254eeb25477b68fb85ed929f73a960582", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"USDT", risk:"medium", verified:true,  decimals:6 },
    { token:"0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c",  spender:"0x10ED43C718714eb63d5aA57B78B54704E256024E", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"WBNB", risk:"low",    verified:true,  decimals:18 },
    { token:"0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82", spender:"0x6B175474E89094C44Da98b954EedeAC495271d0F", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"CAKE", risk:"high",   verified:false, decimals:18 },
    { token:"0x2170Ed0880ac9A755fd29B2688956BD959F933F8", spender:"0xDef1C0ded9bec7F1a1670819833240f027b25EfF", allowance:"500000000000000000000", symbol:"ETH",  risk:"low",    verified:true,  decimals:18 },
    { token:"0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56",  spender:"0x44aD3F17960f0da287c3acEE50fe7f3c5D5B9B8E", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"BUSD", risk:"high",   verified:false, decimals:18 },
    { token:"0x55d398326f99059fF775485246999027B3197955", spender:"0xba12222222228d8ba445958a75a0704d566bf2c8", allowance:"50000000000000000000000", symbol:"USDT", risk:"low",    verified:true,  decimals:18 },
    { token:"0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d", spender:"0xFD14567eaf9ba941cB8c8a94eEC14831ca7fD1b4", allowance:"115792089237316195423570985008687907853269984665640564039457584007913129639935", symbol:"USDC", risk:"medium", verified:null,  decimals:18 }
  ];
}

// â”€â”€ UI EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPassportMsg(msg) {
  const el = document.getElementById("passportShared");
  if (!el) return;
  el.textContent = msg; el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 5000);
}

function startScan() {
  let wallet = document.getElementById("walletInput").value.trim();
  const net  = document.getElementById("netSelect").value;
  const isDemo = !wallet || !fwIsAddr(wallet);
  if (!wallet) wallet = DEMO_WALLET;
  if (!fwIsAddr(wallet)) { alert("Please enter a valid wallet address (0x...)"); return; }
  runLoadSequence(wallet, net, isDemo);
}

function resetLoadSteps() {
  ["step1","step2","step3","step4"].forEach(s => {
    const el = document.getElementById(s);
    el?.classList.remove("active","done");
    const icon = el?.querySelector(".step-icon");
    if (icon) icon.textContent = "âŸ³";
  });
  const fill = document.getElementById("loadBarFill");
  if (fill) fill.style.width = "0%";
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WALLET WATCH ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FW_WATCH_KEY = "cx_watch_list";

function fwWatchLoad() {
  try { const r = JSON.parse(localStorage.getItem(FW_WATCH_KEY)||"[]"); return Array.isArray(r)?r:[]; } catch { return []; }
}
function fwWatchSave(list) {
  try { localStorage.setItem(FW_WATCH_KEY, JSON.stringify(list)); } catch {}
}

// Scan all watched wallets one by one
async function fwWatchScanAll() {
  const list = fwWatchLoad();
  if (!list.length) { showPassportMsg("âš  No wallets in watch list yet."); return; }
  const btn = document.getElementById("fwBtnScanAll");
  if (btn) { btn.disabled=true; btn.textContent="Scanningâ€¦"; }
  for (let i=0; i<list.length; i++) {
    const w = list[i];
    if (btn) btn.textContent = `Scanning ${i+1}/${list.length}â€¦`;
    try {
      const approvals = await fetchApprovals(w.net||"bsc", w.wallet);
      const metrics   = computeMetrics(approvals);
      fwWatchUpdateScore(w.wallet, w.net||"bsc", metrics.score);
      // Also save to scan history
      fwHistorySave(w.wallet, w.net||"bsc", metrics);
    } catch(e) {
      // Skip on error â€” don't break the loop
    }
    await new Promise(r=>setTimeout(r,1200)); // 1.2s between scans (rate limit safety)
  }
  if (btn) { btn.disabled=false; btn.textContent="â†» Scan All"; }
  showPassportMsg(`âœ… Scanned ${list.length} wallet(s) â€” scores updated.`);
}
window.fwWatchScanAll = fwWatchScanAll;

function fwWatchAdd() {
  const input  = document.getElementById("fwWatchInput");
  const netSel = document.getElementById("fwWatchNet");
  const wallet = (input?.value||"").trim();
  const net    = netSel?.value || "bsc";
  if (!fwIsAddr(wallet)) {
    if(input){input.style.borderColor="rgba(255,71,87,.5)";setTimeout(()=>{input.style.borderColor=""},1500);}
    return;
  }
  const list     = fwWatchLoad();
  const isFull   = fwAccessTier === "full" && _fwAccessVerified;
  const maxWatch = isFull ? 10 : 2;
  if (list.length >= maxWatch) {
    if (isFull) {
      showPassportMsg(`âš  Maximum ${maxWatch} wallets reached.`);
    } else {
      showPassportMsg("âš  Free tier: max 2 wallets. Unlock Full Access to track up to 10.");
      requestFullAccess();
    }
    return;
  }
  if (list.some(w=>w.wallet.toLowerCase()===wallet.toLowerCase()&&w.net===net)) {
    showPassportMsg("âš  Already watching this wallet."); return;
  }
  const hist      = fwHistoryLoad(wallet, net);
  const lastScore = hist.length ? hist[0].score : null;
  list.unshift({wallet,net,lastScore,addedAt:Date.now(),alertThreshold:60});
  fwWatchSave(list);
  if(input)input.value="";
  fwWatchRender();
  showPassportMsg(`âœ… Now watching ${fwShort(wallet)} on ${net.toUpperCase()} (${list.length}/${maxWatch})`);
}

function fwWatchRemove(wallet, net) {
  fwWatchSave(fwWatchLoad().filter(w=>!(w.wallet.toLowerCase()===wallet.toLowerCase()&&w.net===net)));
  fwWatchRender();
}

function fwWatchRender() {
  const grid = document.getElementById("fwWatchGrid");
  if (!grid) return;
  const list = fwWatchLoad();
  if (!list.length) {
    grid.innerHTML=`<div style="font-size:12px;color:var(--muted);grid-column:1/-1;padding:12px 0">No wallets watched yet. Add your first wallet below.</div>`;
    return;
  }
  grid.innerHTML = list.map(w => {
    const score    = w.lastScore;
    const dot      = score===null?"#888":score>=70?"#5dffb2":score>=45?"#ffd166":"#ff7a8a";
    const scoreStr = score===null?"â€”":score;
    const hist     = fwHistoryLoad(w.wallet, w.net||"bsc");
    const prev     = hist.length>1?hist[1]:null;
    const d        = (score!==null&&prev)?score-prev.score:null;
    const deltaStr = d===null?"":d>0?`<span style="color:#5dffb2;font-size:10px">â†‘${d}</span>`:d<0?`<span style="color:#ff7a8a;font-size:10px">â†“${Math.abs(d)}</span>`:"";
    return `<div class="fw-watch-row">
      <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">
        <div class="fw-watch-dot" style="background:${dot}"></div>
        <div class="fw-watch-info">
          <div class="fw-watch-addr">${fwShort(w.wallet)}</div>
          <div class="fw-watch-sub">${(w.net||"bsc").toUpperCase()} Â· Alert &lt;${w.alertThreshold}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <span class="fw-watch-score" style="color:${dot}">${scoreStr}</span>${deltaStr}
      </div>
      <div class="fw-watch-actions">
        <button class="fw-watch-btn scan" onclick="fwHistoryQuickScan('${esc(w.wallet)}','${esc(w.net||"bsc")}')">â†— Scan</button>
        <button class="fw-watch-btn del"  onclick="fwWatchRemove('${esc(w.wallet)}','${esc(w.net||"bsc")}')">âœ•</button>
      </div>
    </div>`;
  }).join("");
}

function fwWatchUpdateScore(wallet, net, score) {
  const list = fwWatchLoad();
  const idx  = list.findIndex(w=>w.wallet.toLowerCase()===wallet.toLowerCase()&&w.net===net);
  if (idx<0) return;
  const prev      = list[idx].lastScore;
  const threshold = list[idx].alertThreshold||60;
  list[idx].lastScore = score;
  fwWatchSave(list);
  fwWatchRender();
  if (score<threshold&&(prev===null||prev>=threshold)) fwWatchFireAlert(wallet,net,score,prev);
}

function fwWatchFireAlert(wallet, net, score, prevScore) {
  const banner=document.getElementById("fwAlertBanner");
  const title =document.getElementById("fwAlertTitle");
  const desc  =document.getElementById("fwAlertDesc");
  if(banner){banner.classList.add("show");
    if(title)title.textContent=`âš  Score Drop: ${fwShort(wallet)} on ${net.toUpperCase()}`;
    if(desc) desc.textContent =`Score dropped to ${score}/100${prevScore?` from ${prevScore}`:""}. Review approvals immediately.`;
  }
  if(Notification.permission==="granted"){
    try{new Notification("âš  CycleX Firewall Alert",{body:`${fwShort(wallet)} score dropped to ${score}/100 on ${net.toUpperCase()}.`,icon:"/favicon-32x32.png"});}catch{}
  }
}

async function fwRequestNotifications() {
  const btn  =document.getElementById("fwNotifBtn");
  const enBtn=document.getElementById("fwBtnEnableNotif");
  const text =document.getElementById("fwNotifText");
  if(!("Notification" in window)){if(text)text.textContent="Your browser doesn't support notifications.";return;}
  if(Notification.permission==="granted"){
    if(text)text.textContent="âœ… Alerts enabled â€” you'll be notified on score drops.";
    if(btn)btn.textContent="âœ… Enabled";if(enBtn)enBtn.textContent="âœ… Alerts On";return;
  }
  const perm=await Notification.requestPermission();
  if(perm==="granted"){
    if(text)text.textContent="âœ… Browser alerts enabled.";
    if(btn)btn.textContent="âœ… Enabled";if(enBtn)enBtn.textContent="âœ… Alerts On";
    showPassportMsg("âœ… Browser alerts enabled!");
  } else {
    if(text)text.textContent="Notifications blocked. Enable in browser settings.";
  }
}

function fwWatchInit() {
  fwWatchRender();
  const btn =document.getElementById("fwNotifBtn");
  const enBtn=document.getElementById("fwBtnEnableNotif");
  const text=document.getElementById("fwNotifText");
  if(Notification.permission==="granted"){
    if(btn)btn.textContent="âœ… Enabled";
    if(enBtn)enBtn.textContent="âœ… Alerts On";
    if(text)text.textContent="âœ… Browser alerts enabled.";
  }
  const sec=document.getElementById("fwWatchSection");
  if(sec)sec.classList.add("fw-visible");
  // Restore on-chain subscription status if exists
  try {
    const sub = JSON.parse(localStorage.getItem(FW_ONCHAIN_SUB_KEY)||"null");
    if (sub && sub.expiry > Math.floor(Date.now()/1000)) {
      const statusEl = document.getElementById("fwOnchainStatus");
      const subBtn   = document.getElementById("fwOnchainBtn");
      if (statusEl) statusEl.textContent = `âœ… Subscribed â€” monitoring ${sub.net.toUpperCase()} (expires ${new Date(sub.expiry*1000).toLocaleDateString()})`;
      if (subBtn) { subBtn.textContent="âœ… Subscribed"; subBtn.style.color="var(--green)"; subBtn.style.borderColor="rgba(93,255,178,.3)"; }
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREAT FEED ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FW_THREATS = [
  {id:"socket-bridge-2024",title:"Socket Bridge Exploit",
   desc:"$3.3M drained via malformed calldata in Socket Gateway. Users who approved the Socket Gateway address were exposed.",
   severity:"critical",icon:"ğŸŒ",date:"Jan 2024",chains:["eth"],
   spenders:["0x3a23f943181408eac424116af7b7790c94cb97a5"],link:"https://rekt.news/socket-rekt/"},
  {id:"radiant-capital-2024",title:"Radiant Capital Hack",
   desc:"$50M stolen via compromised multisig signers. BSC & ETH lending approvals to Radiant contracts were at risk.",
   severity:"critical",icon:"ğŸ¦",date:"Oct 2024",chains:["bsc","eth"],
   spenders:["0xd50cf00b6e600dd036ba8ef475677d816d6c4281"],link:"https://rekt.news/radiant-capital-rekt2/"},
  {id:"orbit-chain-2024",title:"Orbit Chain Bridge â€” $82M",
   desc:"Validator keys compromised. Ethereum bridge approvals exposed. All Orbit Chain approvals should be revoked.",
   severity:"critical",icon:"â›“",date:"Jan 2024",chains:["eth"],
   spenders:["0x1bf68a9d1eaee7826b3593c20a0ca93293cb489a"],link:"https://rekt.news/orbit-chain-rekt/"},
  {id:"multichain-2023",title:"Multichain Bridge â€” $125M",
   desc:"Cross-chain bridge fully drained. Any remaining approval to Multichain contracts should be revoked immediately.",
   severity:"critical",icon:"ğŸŒ‰",date:"Jul 2023",chains:["bsc","eth","polygon"],
   spenders:["0xc564ee9f21ed8a2d8e7e76c085740d5e4c5fafbe"],link:"https://rekt.news/multichain-rekt2/"},
  {id:"unlimited-phishing-2026",title:"Unlimited Approval Phishing Wave",
   desc:"Active phishing campaign on BSC/Polygon with fake DEX aggregators. Unlimited approvals to vanity addresses (0x000...471df pattern) observed.",
   severity:"high",icon:"ğŸ£",date:"Feb 2026",chains:["polygon","bsc"],
   spenders:["0x000000004ab03b268bce6126cb6dc55b3b2471df"],link:null},
  {id:"unverified-surge-2025",title:"Unverified Contract Approval Surge",
   desc:"BSC wallets increasingly approving unverified contracts. Pattern matches drain-on-approval schemes. Revoke all approvals to contracts without a verified badge.",
   severity:"medium",icon:"âš ï¸",date:"2025",chains:["bsc"],
   spenders:[],link:null},
  {id:"pancakebunny-2021",title:"PancakeBunny Flash Loan Attack",
   desc:"$45M exploit via flash loan price manipulation. Contracts 0x4188â€¦c100 and the Bunny minter remain on-chain with active approval paths. Legacy approvals should be revoked.",
   severity:"critical",icon:"ğŸ°",date:"May 2021",chains:["bsc"],
   spenders:["0x4188e09f4a5a39e7d0e306ea7e8de9b80cb32d5c"],link:"https://rekt.news/pancakebunny-rekt/"},
  {id:"mevbot-approval-drain-2024",title:"MEV Bot Approval Drain Campaign",
   desc:"Series of MEV bots on BSC draining wallets via pre-approved ERC-20 allowances. Bots monitor the mempool for unlimited approvals and front-run legitimate txs to drain tokens.",
   severity:"high",icon:"ğŸ¤–",date:"2024",chains:["bsc","eth"],
   spenders:[],link:null},
  {id:"bsc-fake-usdt-2025",title:"Fake USDT / BUSD Contract Approvals",
   desc:"Scammers deploy contracts with USDT/BUSD ticker symbols on BSC. Users approve them via phishing sites thinking they're interacting with real stablecoins. Check token contract addresses carefully.",
   severity:"high",icon:"ğŸ’µ",date:"2025",chains:["bsc"],
   spenders:[],link:null}
];

function fwThreatRender(userSpenders) {
  const list  = document.getElementById("fwThreatList");
  const badge = document.getElementById("fwThreatAffectedBadge");
  if (!list) return;
  const userLower  = (userSpenders||[]).map(s=>s.toLowerCase());
  let affectedCount = 0;
  list.innerHTML = FW_THREATS.map(t => {
    const isAffected = t.spenders.length>0 && t.spenders.some(s=>userLower.includes(s.toLowerCase()));
    if(isAffected) affectedCount++;
    const chainTags  = t.chains.map(c=>`<span class="tfd-tag chain-${c}">${c.toUpperCase()}</span>`).join("");
    const affTag     = isAffected?`<span class="tfd-tag affected-you">âš  You may be affected</span>`:"";
    const linkHTML   = t.link?`<a href="${t.link}" target="_blank" rel="noopener" class="tfd-link">Read more â†—</a>`:"";
    const affHdr     = isAffected?`<div class="tfd-affected-badge">âš  APPROVAL DETECTED â€” REVOKE RECOMMENDED</div>`:"";
    return `<div class="tfd-item${isAffected?" affected":""}">
      <div class="tfd-severity ${t.severity}">${t.icon}</div>
      <div class="tfd-body">
        ${affHdr}<div class="tfd-title">${esc(t.title)}</div>
        <div class="tfd-desc">${esc(t.desc)}</div>
        <div class="tfd-meta"><span class="tfd-tag date">ğŸ“… ${t.date}</span>${chainTags}${affTag}${linkHTML}</div>
      </div></div>`;
  }).join("");
  if(badge){
    if(affectedCount>0){badge.textContent=`âš  ${affectedCount} threat(s) may affect you`;badge.style.display="inline";}
    else badge.style.display="none";
  }
}

function fwThreatInit(scanData) {
  const spenders=(scanData?.rows||[]).map(r=>r.spender||r.fullSpender||"");
  fwThreatRender(spenders);
  const sec=document.getElementById("fwThreatFeedSection");
  if(sec)sec.classList.add("fw-visible");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUBLIC API â€” copy helper
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fwApiCopy(url, btn) {
  navigator.clipboard.writeText(url).then(()=>{
    const orig=btn.textContent; btn.textContent="âœ… Copied"; btn.style.color="var(--green)";
    setTimeout(()=>{btn.textContent=orig;btn.style.color=""},1800);
  }).catch(()=>{btn.textContent="Failed";});
}
// â”€â”€ ON-CHAIN APPROVAL MONITOR (read-only, no gas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Signs a typed-data message to register the intent; backend polls
// eth_getLogs for Approval events and fires webhook/notification
const FW_ONCHAIN_SUB_KEY = "cx_onchain_sub";

async function fwSubscribeOnchain() {
  const btn    = document.getElementById("fwOnchainBtn");
  const status = document.getElementById("fwOnchainStatus");
  if (!window.wallet?.signer) { requestFullAccess(); return; }

  if (btn) { btn.disabled=true; btn.textContent="Signingâ€¦"; }

  try {
    // Read-only subscription: sign a typed message (no gas, no tx)
    // Backend uses this signature as proof of intent + wallet ownership
    const ts = Math.floor(Date.now()/1000);
    const msgParams = JSON.stringify({
      domain: { name:"CycleX Firewall", version:"1", chainId: FW_CHAIN_IDS[fwNet]||56 },
      message: {
        action:    "SubscribeApprovalAlerts",
        wallet:    window.wallet.address,
        network:   fwNet,
        threshold: 60,
        timestamp: BigInt(ts).toString(),
        expiry:    BigInt(ts + 30*24*3600).toString()
      },
      primaryType: "AlertSubscription",
      types: {
        EIP712Domain:[{name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"}],
        AlertSubscription:[
          {name:"action",type:"string"},{name:"wallet",type:"address"},
          {name:"network",type:"string"},{name:"threshold",type:"uint256"},
          {name:"timestamp",type:"uint256"},{name:"expiry",type:"uint256"}
        ]
      }
    });

    const sig = await window.wallet.providerRaw.request({
      method:"eth_signTypedData_v4",
      params:[window.wallet.address, msgParams]
    });

    // Store subscription locally (backend would persist this)
    const sub = {
      wallet: window.wallet.address, net: fwNet,
      signature: sig, timestamp: ts,
      expiry: ts + 30*24*3600
    };
    try { localStorage.setItem(FW_ONCHAIN_SUB_KEY, JSON.stringify(sub)); } catch {}

    // POST to backend (if available) â€” non-blocking
    fetch("/api/subscribeAlerts", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(sub)
    }).catch(()=>{}); // silent fail â€” local subscription still works

    if (status) status.textContent = `âœ… Subscribed â€” monitoring Approval events on ${fwNet.toUpperCase()} (read-only)`;
    if (btn) { btn.textContent="âœ… Subscribed"; btn.disabled=false; btn.style.color="var(--green)"; btn.style.borderColor="rgba(93,255,178,.3)"; }
    showPassportMsg("âœ… On-chain approval alerts activated!");

    // Poll for new approvals every 30s (read-only eth_getLogs)
    fwStartApprovalPoller(window.wallet.address, fwNet);

  } catch(e) {
    if (/reject|cancel|denied|4001/i.test(String(e?.message||""))) {
      showPassportMsg("Subscription cancelled.");
    } else {
      showPassportMsg(`âš  Subscribe failed: ${(e.message||"").slice(0,60)}`);
    }
    if (btn) { btn.disabled=false; btn.textContent="Subscribe"; }
  }
}

// Read-only poller: eth_getLogs for Approval events (no gas, no tx)
let _fwPollerInterval = null;
function fwStartApprovalPoller(wallet, net) {
  if (_fwPollerInterval) clearInterval(_fwPollerInterval);
  _fwPollerInterval = setInterval(async () => {
    try {
      const provider = getRPC(net);
      if (!provider) return;
      // ERC-20 Approval event topic: keccak256("Approval(address,address,uint256)")
      const APPROVAL_TOPIC = "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925";
      const ownerTopic = "0x" + wallet.toLowerCase().replace("0x","").padStart(64,"0");
      // eth_getLogs â€” pure read call, zero gas
      const blockHex = await provider.send("eth_blockNumber",[]);
      const fromBlock = "0x" + Math.max(0, parseInt(blockHex,16)-200).toString(16);
      const logs = await provider.send("eth_getLogs",[{
        fromBlock, toBlock:"latest",
        topics:[APPROVAL_TOPIC, ownerTopic]
      }]);
      if (logs?.length) {
        // New approval events detected since last poll
        const count = logs.length;
        fwWatchFireAlert(wallet, net, fwCurrentScore, null);
        showPassportMsg(`âš  ${count} new Approval event(s) detected on-chain for your wallet!`);
      }
    } catch(e) { /* read-only, silent fail */ }
  }, 30000); // poll every 30 seconds
}
window.fwSubscribeOnchain = fwSubscribeOnchain;

window.fwApiCopy             = fwApiCopy;
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANGUAGE SWITCHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FW_TRANSLATIONS = {
  en: {
    // topbar
    fw_badge:"FIREWALL", btn_full_access:"ğŸ”‘ Full Access", btn_back:"â† Back to Hub",
    // hero
    hero_kicker:"ğŸ”¥ Wallet Firewall",
    hero_title:"Turn any wallet into<br>a protected wallet.",
    hero_sub:"Scan your approvals, reveal your Blast Radius, get a guided Fix Plan â€” and generate a shareable Proof Passport. In 60 seconds.",
    scan_placeholder:"0x... wallet address", btn_run:"Run Firewall",
    // loading
    step1:"Fetching approval logs", step2:"Analyzing spender risk",
    step3:"Calculating Blast Radius", step4:"Building Fix Plan",
    // notices
    notice_live_title:"Live scan.", notice_live_body:"Read-only on-chain data. No transactions made.",
    notice_demo_title:"Demo mode:", notice_demo_body:'Showing sample data. Enter a real wallet address and click "Run Firewall" to scan live.',
    // section titles
    sec_status:"Firewall Status", sec_fix:"Fix Mode", sec_passport:"Wallet Passport",
    sec_rules:"Firewall Rules", sec_relations:"ğŸ”— Wallet Relations", sec_export:"ğŸ“Š Export Report",
    sec_watch:"ğŸ‘ Wallet Watch", sec_threats:"ğŸš¨ Threat Feed", sec_api:"ğŸ”Œ Developer API",
    // status cards
    kicker_score:"Firewall Score", kicker_blast:"ğŸ’¥ Blast Radius", kicker_drain:"â± Time-to-Drain",
    blast_sub:"max drainable if top spender exploited",
    drain_sub:"estimated drain time for exposed assets",
    // map / threats
    title_map:"ğŸ—º Exposure Map", map_sub:"Wallet â†’ Spenders â†’ Tokens. Node size = risk weight.",
    title_threats:"ğŸ¯ Top Threats",
    // fix mode
    fix_lock_msg:"Fix Mode requires Full Access<br>(hold 1 PASS token)",
    btn_unlock_fix:"Unlock Fix Mode",
    fix_title:"ğŸ›  3-Step Fix Plan",
    fix_sub:"Complete these actions to improve your Firewall Score.",
    fix1_title:"Revoke Top Spender", fix2_title:"Revoke All Unlimited", fix3_title:"Lock Risky dApp",
    // passport
    passport_lock_msg:"Wallet Passport requires Full Access",
    passport_share_title:"Share your Wallet Passport",
    // watch
    watch_title:"Track Multiple Wallets",
    // Score labels
    score_protected:"Protected", score_exposed:"Exposed",
    score_vulnerable:"Vulnerable", score_critical:"Critical",
    // Scan notice
    scan_running:"Scanning walletâ€¦",
    // access gate
    gate_msg:'Hold <strong style="color:var(--cyan)">1 PASS token</strong> to unlock Fix Mode, full Blast Radius, Wallet Passport, and real revoke actions.',
    btn_rescan:"Scan another wallet",
    fix_impact:"The 3 most impactful actions to secure your wallet.",
    passport_copy_sub:"Your cryptographic proof of security. Share to prove you've secured your wallet.",
    export_sub:"Download your complete scan as CSV or JSON, or copy a shareable report.",
    rel_title:"Protocol & Exchange Relationships",
    watch_limit_label:"(Free: 2 wallets max â€” Unlock for up to 10)",
    tier_badge:"âœ“ FULL ACCESS",
  },
  zh: {
    fw_badge:"é˜²ç«å¢™", btn_full_access:"ğŸ”‘ å®Œæ•´è®¿é—®", btn_back:"â† è¿”å›ä¸»é¡µ",
    hero_kicker:"ğŸ”¥ é’±åŒ…é˜²ç«å¢™", hero_title:"è®©æ¯ä¸ªé’±åŒ…éƒ½å®‰å…¨ã€‚",
    hero_sub:"æ‰«ææ‚¨çš„æˆæƒã€æ­ç¤ºçˆ†ç‚¸åŠå¾„ã€è·å¾—ä¿®å¤è®¡åˆ’ï¼Œ60ç§’å†…ç”Ÿæˆå¯åˆ†äº«çš„å®‰å…¨æŠ¤ç…§ã€‚",
    scan_placeholder:"0x... é’±åŒ…åœ°å€", btn_run:"è¿è¡Œé˜²ç«å¢™",
    step1:"è·å–æˆæƒæ—¥å¿—", step2:"åˆ†æé£é™©åˆçº¦", step3:"è®¡ç®—çˆ†ç‚¸åŠå¾„", step4:"ç”Ÿæˆä¿®å¤è®¡åˆ’",
    notice_live_title:"å®æ—¶æ‰«æã€‚", notice_live_body:"åªè¯»é“¾ä¸Šæ•°æ®ï¼Œä¸äº§ç”Ÿä»»ä½•äº¤æ˜“ã€‚",
    notice_demo_title:"æ¼”ç¤ºæ¨¡å¼ï¼š", notice_demo_body:"æ˜¾ç¤ºç¤ºä¾‹æ•°æ®ã€‚è¾“å…¥çœŸå®é’±åŒ…åœ°å€å¹¶ç‚¹å‡»ã€Œè¿è¡Œé˜²ç«å¢™ã€è¿›è¡Œå®æ—¶æ‰«æã€‚",
    sec_status:"é˜²ç«å¢™çŠ¶æ€", sec_fix:"ä¿®å¤æ¨¡å¼", sec_passport:"é’±åŒ…æŠ¤ç…§",
    sec_rules:"é˜²ç«å¢™è§„åˆ™", sec_relations:"ğŸ”— é’±åŒ…å…³è”", sec_export:"ğŸ“Š å¯¼å‡ºæŠ¥å‘Š",
    sec_watch:"ğŸ‘ é’±åŒ…ç›‘æ§", sec_threats:"ğŸš¨ å¨èƒåŠ¨æ€", sec_api:"ğŸ”Œ å¼€å‘è€…API",
    kicker_score:"é˜²ç«å¢™è¯„åˆ†", kicker_blast:"ğŸ’¥ çˆ†ç‚¸åŠå¾„", kicker_drain:"â± æ¸…ç©ºæ—¶é—´",
    blast_sub:"é¡¶çº§æˆæƒæ–¹è¢«åˆ©ç”¨æ—¶çš„æœ€å¤§å¯æ¸…ç©ºé‡‘é¢",
    drain_sub:"æš´éœ²èµ„äº§çš„é¢„ä¼°æ¸…ç©ºæ—¶é—´",
    title_map:"ğŸ—º é£é™©åœ°å›¾", map_sub:"é’±åŒ… â†’ æˆæƒæ–¹ â†’ ä»£å¸ã€‚èŠ‚ç‚¹å¤§å° = é£é™©æƒé‡ã€‚",
    title_threats:"ğŸ¯ ä¸»è¦å¨èƒ",
    fix_lock_msg:"ä¿®å¤æ¨¡å¼éœ€è¦å®Œæ•´è®¿é—®æƒé™<br>ï¼ˆæŒæœ‰1ä¸ªPASSä»£å¸ï¼‰",
    btn_unlock_fix:"è§£é”ä¿®å¤æ¨¡å¼",
    fix_title:"ğŸ›  ä¸‰æ­¥ä¿®å¤è®¡åˆ’",
    fix_sub:"å®Œæˆä»¥ä¸‹æ“ä½œä»¥æå‡æ‚¨çš„é˜²ç«å¢™è¯„åˆ†ã€‚",
    fix1_title:"æ’¤é”€é¡¶çº§æˆæƒæ–¹", fix2_title:"æ’¤é”€æ‰€æœ‰æ— é™æˆæƒ", fix3_title:"é”å®šé«˜é£é™©DApp",
    passport_lock_msg:"é’±åŒ…æŠ¤ç…§éœ€è¦å®Œæ•´è®¿é—®æƒé™",
    passport_share_title:"åˆ†äº«æ‚¨çš„é’±åŒ…æŠ¤ç…§",
    watch_title:"è¿½è¸ªå¤šä¸ªé’±åŒ…",
    score_protected:"å—ä¿æŠ¤", score_exposed:"å·²æš´éœ²", score_vulnerable:"å­˜åœ¨æ¼æ´", score_critical:"å±æ€¥",
    gate_msg:'æŒæœ‰ <strong style="color:var(--cyan)">1ä¸ªPASSä»£å¸</strong> ä»¥è§£é”ä¿®å¤æ¨¡å¼ã€å®Œæ•´çˆ†ç‚¸åŠå¾„ã€é’±åŒ…æŠ¤ç…§å’ŒçœŸå®æ’¤é”€æ“ä½œã€‚',
    btn_rescan:"æ‰«æå…¶ä»–é’±åŒ…",
    fix_impact:"ä»¥ä¸‹3é¡¹æ“ä½œå°†æ˜¾è‘—æå‡æ‚¨çš„å®‰å…¨è¯„åˆ†ã€‚",
    passport_copy_sub:"æ‚¨çš„å®‰å…¨åŠ å¯†è¯æ˜ã€‚åˆ†äº«ä»¥è¯æ˜æ‚¨å·²ä¿æŠ¤å¥½é’±åŒ…ã€‚",
    export_sub:"ä¸‹è½½CSVæˆ–JSONæ ¼å¼çš„å®Œæ•´æ‰«ææŠ¥å‘Šï¼Œæˆ–å¤åˆ¶å¯åˆ†äº«çš„æ‘˜è¦ã€‚",
    rel_title:"åè®®å’Œäº¤æ˜“æ‰€å…³ç³»",
    watch_limit_label:"ï¼ˆå…è´¹: æœ€å¤š2ä¸ªé’±åŒ… â€” è§£é”å¯è¿½è¸ª10ä¸ªï¼‰",
    tier_badge:"âœ“ å®Œæ•´è®¿é—®",
  },
  ar: {
    fw_badge:"Ø¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©", btn_full_access:"ğŸ”‘ ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„", btn_back:"â†’ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
    hero_kicker:"ğŸ”¥ Ø¬Ø¯Ø§Ø± Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ÙØ¸Ø©", hero_title:"Ø­ÙˆÙ‘Ù„ Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸Ø© Ù…Ø­Ù…ÙŠØ©.",
    hero_sub:"Ø§ÙØ­Øµ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§ØªØŒ Ø§ÙƒØ´Ù Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¶Ø±Ø±ØŒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®Ø·Ø© Ø¥ØµÙ„Ø§Ø­ Ù…ÙˆØ¬Ù‘Ù‡Ø© Ø®Ù„Ø§Ù„ 60 Ø«Ø§Ù†ÙŠØ©.",
    scan_placeholder:"Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© 0x...", btn_run:"ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§Ø±",
    step1:"Ø¬Ù„Ø¨ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª", step2:"ØªØ­Ù„ÙŠÙ„ Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¹Ù‚ÙˆØ¯", step3:"Ø­Ø³Ø§Ø¨ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¶Ø±Ø±", step4:"Ø¨Ù†Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­",
    notice_live_title:"ÙØ­Øµ Ù…Ø¨Ø§Ø´Ø±.", notice_live_body:"Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·. Ù„Ø§ Ù…Ø¹Ø§Ù…Ù„Ø§Øª.",
    notice_demo_title:"ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ:", notice_demo_body:'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù…ÙˆØ°Ø¬ÙŠØ©. Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØ§Ø¶ØºØ· "ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§Ø±" Ù„Ù„ÙØ­Øµ Ø§Ù„ÙØ¹Ù„ÙŠ.',
    sec_status:"Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯Ø§Ø±", sec_fix:"ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­", sec_passport:"Ø¬ÙˆØ§Ø² Ø§Ù„Ù…Ø­ÙØ¸Ø©",
    sec_rules:"Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø±", sec_relations:"ğŸ”— Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©", sec_export:"ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±",
    sec_watch:"ğŸ‘ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸", sec_threats:"ğŸš¨ Ø®Ù„Ø§ØµØ© Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯Ø§Øª", sec_api:"ğŸ”Œ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†",
    kicker_score:"Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ø¯Ø§Ø±", kicker_blast:"ğŸ’¥ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¶Ø±Ø±", kicker_drain:"â± ÙˆÙ‚Øª Ø§Ù„ØªØµÙÙŠØ©",
    blast_sub:"Ø£Ù‚ØµÙ‰ Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø³Ø­Ø¨ Ø¹Ù†Ø¯ Ø§Ø³ØªØºÙ„Ø§Ù„ Ø£ÙƒØ¨Ø± Ù…ÙÙˆÙÙ‘Ø¶",
    drain_sub:"Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø± Ù„ØªØµÙÙŠØ© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ÙƒØ´ÙˆÙØ©",
    title_map:"ğŸ—º Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ¹Ø±Ø¶", map_sub:"Ø§Ù„Ù…Ø­ÙØ¸Ø© â† Ø§Ù„Ù…ÙÙˆÙÙ‘Ø¶ÙˆÙ† â† Ø§Ù„Ø±Ù…ÙˆØ². Ø­Ø¬Ù… Ø§Ù„Ø¹Ù‚Ø¯Ø© = ÙˆØ²Ù† Ø§Ù„Ù…Ø®Ø§Ø·Ø±.",
    title_threats:"ğŸ¯ Ø£Ø¨Ø±Ø² Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯Ø§Øª",
    fix_lock_msg:"ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙŠØªØ·Ù„Ø¨ ÙˆØµÙˆÙ„Ø§Ù‹ ÙƒØ§Ù…Ù„Ø§Ù‹<br>ï¼ˆØ§Ù…ØªÙ„Ùƒ Ø±Ù…Ø² PASS ÙˆØ§Ø­Ø¯Ø§Ù‹ï¼‰",
    btn_unlock_fix:"ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­",
    fix_title:"ğŸ›  Ø®Ø·Ø© Ø¥ØµÙ„Ø§Ø­ Ù…Ù† 3 Ø®Ø·ÙˆØ§Øª",
    fix_sub:"Ø£ÙƒÙ…Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ø¯Ø§Ø±.",
    fix1_title:"Ø¥Ù„ØºØ§Ø¡ Ø£ÙƒØ¨Ø± Ù…ÙÙˆÙÙ‘Ø¶", fix2_title:"Ø¥Ù„ØºØ§Ø¡ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø©", fix3_title:"Ø­Ø¸Ø± DApp Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø®Ø·ÙˆØ±Ø©",
    passport_lock_msg:"Ø¬ÙˆØ§Ø² Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙŠØªØ·Ù„Ø¨ ÙˆØµÙˆÙ„Ø§Ù‹ ÙƒØ§Ù…Ù„Ø§Ù‹",
    passport_share_title:"Ø´Ø§Ø±Ùƒ Ø¬ÙˆØ§Ø² Ù…Ø­ÙØ¸ØªÙƒ",
    watch_title:"ØªØªØ¨Ø¹ Ù…Ø­Ø§ÙØ¸ Ù…ØªØ¹Ø¯Ø¯Ø©",
    score_protected:"Ù…Ø­Ù…ÙŠ", score_exposed:"Ù…ÙƒØ´ÙˆÙ", score_vulnerable:"Ø¶Ø¹ÙŠÙ", score_critical:"Ø­Ø±Ø¬",
    gate_msg:'Ø§Ù…ØªÙ„Ùƒ <strong style="color:var(--cyan)">Ø±Ù…Ø² PASS ÙˆØ§Ø­Ø¯Ø§Ù‹</strong> Ù„ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙˆÙ†Ø·Ø§Ù‚ Ø§Ù„Ø¶Ø±Ø± Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ¬ÙˆØ§Ø² Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©.',
    btn_rescan:"ÙØ­Øµ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰",
    fix_impact:"Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ£Ø«ÙŠØ±Ø§Ù‹ Ù„ØªØ£Ù…ÙŠÙ† Ù…Ø­ÙØ¸ØªÙƒ.",
    passport_copy_sub:"Ø¥Ø«Ø¨Ø§ØªÙƒ Ø§Ù„ØªØ´ÙÙŠØ±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…Ø§Ù†. Ø´Ø§Ø±ÙƒÙ‡ Ù„Ø¥Ø«Ø¨Ø§Øª Ø£Ù†Ùƒ Ø£Ù…Ù‘Ù†Øª Ù…Ø­ÙØ¸ØªÙƒ.",
    export_sub:"Ø­Ù…Ù‘Ù„ Ø§Ù„ÙØ­Øµ ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨ØµÙŠØºØ© CSV Ø£Ùˆ JSONØŒ Ø£Ùˆ Ø§Ù†Ø³Ø® ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©.",
    rel_title:"Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø¨ÙˆØ±ØµØ§Øª",
    watch_limit_label:"(Ù…Ø¬Ø§Ù†ÙŠ: 2 Ù…Ø­Ø§ÙØ¸ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ â€” Ø§Ù„ÙØªØ­ ÙŠØªÙŠØ­ 10)",
    tier_badge:"âœ“ ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„",
  },
  ru: {
    fw_badge:"Ğ¤ĞĞ™Ğ Ğ’ĞĞ›", btn_full_access:"ğŸ”‘ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿", btn_back:"â† ĞĞ°Ğ·Ğ°Ğ´",
    hero_kicker:"ğŸ”¥ Ğ¤Ğ°Ğ¹Ñ€Ğ²Ğ¾Ğ» ĞšĞ¾ÑˆĞµĞ»ÑŒĞºĞ°", hero_title:"Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ¸ Ğ»ÑĞ±Ğ¾Ğ¹ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº Ğ·Ğ° ÑĞµĞºÑƒĞ½Ğ´Ñ‹.",
    hero_sub:"Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞ¹ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ, ÑƒĞ·Ğ½Ğ°Ğ¹ Ğ·Ğ¾Ğ½Ñƒ Ñ€Ğ¸ÑĞºĞ°, Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸ Ğ¿Ğ»Ğ°Ğ½ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ â€” Ğ¸ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹ Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸. Ğ—Ğ° 60 ÑĞµĞºÑƒĞ½Ğ´.",
    scan_placeholder:"0x... Ğ°Ğ´Ñ€ĞµÑ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°", btn_run:"Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ",
    step1:"Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ± Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸ÑÑ…", step2:"ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ€Ğ¸ÑĞºĞ¾Ğ² ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ğ¾Ğ²",
    step3:"Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ·Ğ¾Ğ½Ñ‹ Ğ¿Ğ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ", step4:"Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ğ½Ğ° Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹",
    notice_live_title:"Ğ–Ğ¸Ğ²Ğ¾Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ.", notice_live_body:"Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ. Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ÑÑ.",
    notice_demo_title:"Ğ”ĞµĞ¼Ğ¾-Ñ€ĞµĞ¶Ğ¸Ğ¼:", notice_demo_body:'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ. Ğ’Ğ²ĞµĞ´Ğ¸ Ğ°Ğ´Ñ€ĞµÑ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸ "Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ" Ğ´Ğ»Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.',
    sec_status:"Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¤Ğ°Ğ¹Ñ€Ğ²Ğ¾Ğ»Ğ°", sec_fix:"Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ", sec_passport:"ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚ ĞšĞ¾ÑˆĞµĞ»ÑŒĞºĞ°",
    sec_rules:"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ¤Ğ°Ğ¹Ñ€Ğ²Ğ¾Ğ»Ğ°", sec_relations:"ğŸ”— Ğ¡Ğ²ÑĞ·Ğ¸ ĞšĞ¾ÑˆĞµĞ»ÑŒĞºĞ°", sec_export:"ğŸ“Š Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ ĞÑ‚Ñ‡Ñ‘Ñ‚Ğ°",
    sec_watch:"ğŸ‘ Ğ¡Ğ»ĞµĞ¶ĞµĞ½Ğ¸Ğµ", sec_threats:"ğŸš¨ Ğ›ĞµĞ½Ñ‚Ğ° Ğ£Ğ³Ñ€Ğ¾Ğ·", sec_api:"ğŸ”Œ API Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°",
    kicker_score:"ĞÑ†ĞµĞ½ĞºĞ° Ğ¤Ğ°Ğ¹Ñ€Ğ²Ğ¾Ğ»Ğ°", kicker_blast:"ğŸ’¥ Ğ—Ğ¾Ğ½Ğ° ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ", kicker_drain:"â± Ğ’Ñ€ĞµĞ¼Ñ ĞĞ¿ÑƒÑÑ‚Ğ¾ÑˆĞµĞ½Ğ¸Ñ",
    blast_sub:"Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¸ Ğ°Ñ‚Ğ°ĞºĞµ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»Ñ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ñ",
    drain_sub:"Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¿ÑƒÑÑ‚Ğ¾ÑˆĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¾Ğ²",
    title_map:"ğŸ—º ĞšĞ°Ñ€Ñ‚Ğ° Ğ Ğ¸ÑĞºĞ¾Ğ²", map_sub:"ĞšĞ¾ÑˆĞµĞ»Ñ‘Ğº â†’ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»Ğ¸ â†’ Ğ¢Ğ¾ĞºĞµĞ½Ñ‹. Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑƒĞ·Ğ»Ğ° = Ğ²ĞµÑ Ñ€Ğ¸ÑĞºĞ°.",
    title_threats:"ğŸ¯ Ğ¢Ğ¾Ğ¿ Ğ£Ğ³Ñ€Ğ¾Ğ·",
    fix_lock_msg:"Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°<br>ï¼ˆĞ½ÑƒĞ¶ĞµĞ½ 1 PASS-Ñ‚Ğ¾ĞºĞµĞ½ï¼‰",
    btn_unlock_fix:"Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ ĞµĞ¶Ğ¸Ğ¼",
    fix_title:"ğŸ›  3-ÑˆĞ°Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹",
    fix_sub:"Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸ ÑÑ‚Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ Ğ¾Ñ†ĞµĞ½ĞºÑƒ Ñ„Ğ°Ğ¹Ñ€Ğ²Ğ¾Ğ»Ğ°.",
    fix1_title:"ĞÑ‚Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿", fix2_title:"ĞÑ‚Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ±ĞµĞ·Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ½Ñ‹Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ñ‹", fix3_title:"Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ dApp",
    passport_lock_msg:"ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°",
    passport_share_title:"ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ¼ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°",
    watch_title:"ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ¾Ğ²",
    score_protected:"Ğ—Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½", score_exposed:"Ğ£ÑĞ·Ğ²Ğ¸Ğ¼", score_vulnerable:"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹", score_critical:"ĞĞ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ",
    gate_msg:'Ğ”ĞµÑ€Ğ¶Ğ¸ <strong style="color:var(--cyan)">1 PASS-Ñ‚Ğ¾ĞºĞµĞ½</strong>, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ, Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ·Ğ¾Ğ½Ñƒ Ñ€Ğ¸ÑĞºĞ°, ĞŸĞ°ÑĞ¿Ğ¾Ñ€Ñ‚ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° Ğ¸ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ·Ñ‹Ğ².',
    btn_rescan:"Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº",
    fix_impact:"3 Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°.",
    passport_copy_sub:"Ğ¢Ğ²Ğ¾Ñ‘ ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ´Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸. ĞŸĞ¾Ğ´ĞµĞ»Ğ¸ÑÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½.",
    export_sub:"Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ² CSV Ğ¸Ğ»Ğ¸ JSON, Ğ¸Ğ»Ğ¸ ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹ ĞºÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ñ€ĞµĞ·ÑĞ¼Ğµ.",
    rel_title:"Ğ¡Ğ²ÑĞ·Ğ¸ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»Ğ¾Ğ² Ğ¸ Ğ±Ğ¸Ñ€Ğ¶",
    watch_limit_label:"(Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾: Ğ¼Ğ°ĞºÑ 2 ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° â€” Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞ¹ Ğ´Ğ¾ 10)",
    tier_badge:"âœ“ ĞŸĞĞ›ĞĞ«Ğ™ Ğ”ĞĞ¡Ğ¢Ğ£ĞŸ",
  }
};

// Score label lookup (translated)
function fwGetScoreLabel(key) {
  const dict = FW_TRANSLATIONS[_fwActiveLang] || FW_TRANSLATIONS.en;
  return dict[key] || dict["score_" + key.toLowerCase()] || key;
}

// Store active language for dynamic content
let _fwActiveLang = "en";
function fwSetLanguage(lang) {
  _fwActiveLang = lang;
  const dict = FW_TRANSLATIONS[lang] || FW_TRANSLATIONS.en;
  document.body.classList.add("lang-switching");
  document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
  document.body.classList.toggle("lang-rtl", lang === "ar");
  // Static elements
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (dict[key] !== undefined) el.innerHTML = dict[key];
  });
  // Input placeholder + Run button
  const walletInput = document.getElementById("walletInput");
  if (walletInput && dict.scan_placeholder) walletInput.placeholder = dict.scan_placeholder;
  const btnRun = document.getElementById("btnRunFirewall");
  if (btnRun && dict.btn_run) btnRun.textContent = dict.btn_run;
  // Tier badge
  const tierBadge = document.getElementById("tierBadge");
  if (tierBadge && dict.tier_badge) tierBadge.textContent = dict.tier_badge;
  // Re-render threats if dashboard is visible (so badge labels update)
  if (document.getElementById("dashboard")?.style.display !== "none") {
    if (_threatsAll?.length) _rebuildThreatsForLang();
  }
  // Mark active button
  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.classList.toggle("active", btn.getAttribute("data-lang") === lang);
  });
  try { localStorage.setItem("cx_lang", lang); } catch {}
  setTimeout(() => document.body.classList.remove("lang-switching"), 280);
}

// Translate dynamic threat card strings using current language
function _t(key) {
  return (FW_TRANSLATIONS[_fwActiveLang] || FW_TRANSLATIONS.en)[key] || (FW_TRANSLATIONS.en[key] || key);
}

// Re-render threat cards after language change (updates badge strings)
function _rebuildThreatsForLang() {
  // Rebuild threats array with translated strings
  const retranslated = _threatsAll.map(t => ({
    ...t,
    why: _translateRiskReason(t.why, t),
    drainLabel: _translateDrainLabel(t.drainLabel, t),
  }));
  _threatsAll = retranslated;
  const el = document.getElementById("threatsList");
  if (el) { el.innerHTML = ""; _threatsShown = 0; _threatsAppendPage(); }
}

function _translateRiskReason(en_reason, t) {
  const lang = _fwActiveLang;
  if (lang === "en") return en_reason;
  if (!t.hasApproval) {
    const labels = {
      zh: t.compositeRisk >= 5 ? "âš  æ£€æµ‹åˆ°é«˜é£é™©åˆçº¦ â€” æ— æ´»è·ƒæ”¯å‡ºæƒé™" : `â„¹ ${t.contractLabel} â€” æ— æ´»è·ƒæ”¯å‡ºæƒé™`,
      ar: t.compositeRisk >= 5 ? "âš  ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¹Ù‚Ø¯ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø§Ø·Ø± â€” Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ù†ÙØ§Ù‚ Ù†Ø´Ø·Ø©" : `â„¹ ${t.contractLabel} â€” Ù„Ø§ Ù…ÙˆØ§ÙÙ‚Ø© Ù†Ø´Ø·Ø©`,
      ru: t.compositeRisk >= 5 ? "âš  ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ñ€Ğ¸ÑĞºĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚ â€” Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ" : `â„¹ ${t.contractLabel} â€” Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ`,
    };
    return labels[lang] || en_reason;
  }
  if (t.isUnlimited && t.compositeRisk >= 40) {
    const labels = {
      zh: `ğŸ”´ æ— é™æˆæƒç»™æ¶æ„/æ ‡è®°åˆçº¦ â€” ${t.symbol}ä½™é¢100%å¯è¢«æ¸…ç©º`,
      ar: `ğŸ”´ Ù…ÙˆØ§ÙÙ‚Ø© ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ø¹Ù‚Ø¯ Ø®Ø·ÙŠØ± â€” 100% Ù…Ù† Ø±ØµÙŠØ¯ ${t.symbol} Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø³Ø­Ø¨`,
      ru: `ğŸ”´ Ğ‘ĞµĞ·Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ½Ğ¾Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğµ Ğ²Ñ€ĞµĞ´Ğ¾Ğ½Ğ¾ÑĞ½Ğ¾Ğ¼Ñƒ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñƒ â€” 100% Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° ${t.symbol} Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑĞ»Ğ¸Ñ‚Ñ‹`,
    };
    return labels[lang] || en_reason;
  }
  if (t.isUnlimited) {
    const labels = {
      zh: `âš  æ— é™æˆæƒ â€” ${t.symbol}ä½™é¢100%å¯è¢«æ¸…ç©º`,
      ar: `âš  Ù…ÙˆØ§ÙÙ‚Ø© ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø© â€” 100% Ù…Ù† Ø±ØµÙŠØ¯ ${t.symbol} ÙÙŠ Ø®Ø·Ø±`,
      ru: `âš  Ğ‘ĞµĞ·Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ½Ğ¾Ğµ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğµ â€” 100% Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° ${t.symbol} Ğ¿Ğ¾Ğ´ ÑƒĞ³Ñ€Ğ¾Ğ·Ğ¾Ğ¹`,
    };
    return labels[lang] || en_reason;
  }
  return en_reason;
}

function _translateDrainLabel(en_label, t) {
  const lang = _fwActiveLang;
  if (lang === "en" || !t) return en_label;
  if (!t.hasApproval) {
    return { zh: "æ— æ¸…ç©ºé£é™© â€” æ— æ´»è·ƒæˆæƒ", ar: "Ù„Ø§ Ø®Ø·Ø± ØªØµÙÙŠØ© â€” Ù„Ø§ Ù…ÙˆØ§ÙÙ‚Ø© Ù†Ø´Ø·Ø©", ru: "Ğ Ğ¸ÑĞºĞ° ÑĞ»Ğ¸Ğ²Ğ° Ğ½ĞµÑ‚ â€” Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ" }[lang] || en_label;
  }
  if (t.isUnlimited) {
    const sym = t.symbol || "TOKEN";
    return { zh: `${sym}ä½™é¢100%å¯è¢«æ¸…ç©º`, ar: `100% Ù…Ù† Ø±ØµÙŠØ¯ ${sym} Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØµÙÙŠØ©`, ru: `100% Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° ${sym} Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑĞ»Ğ¸Ñ‚Ñ‹` }[lang] || en_label;
  }
  return { zh: "éƒ¨åˆ† â€” æœ‰é™é¢æˆæƒ", ar: "Ø¬Ø²Ø¦ÙŠ â€” Ø­Ø¯ Ù…Ø­Ø¯Ø¯ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©", ru: "Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾ â€” Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ" }[lang] || en_label;
}

// Init language switcher
document.querySelectorAll(".lang-btn").forEach(btn => {
  btn.addEventListener("click", () => fwSetLanguage(btn.getAttribute("data-lang")));
});
// Restore saved language
try {
  const savedLang = localStorage.getItem("cx_lang");
  if (savedLang && FW_TRANSLATIONS[savedLang]) fwSetLanguage(savedLang);
} catch {}

window.fwWatchAdd            = fwWatchAdd;
window.fwWatchRemove         = fwWatchRemove;
window.fwRequestNotifications= fwRequestNotifications;
// Button bindings
// Sign Passport
document.getElementById("btnSignPassport")?.addEventListener("click", () => fwSignPassport());

document.getElementById("btnFix1").addEventListener("click", () => applyFix(0));
document.getElementById("btnFix2").addEventListener("click", () => applyFix(1));
document.getElementById("btnFix3").addEventListener("click", () => applyFix(2));

document.getElementById("btnShareX").addEventListener("click", () => {
  if (fwAccessTier !== "full") { requestFullAccess(); return; }
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(getPassportText())}`, "_blank");
});

document.getElementById("btnCopyPassport").addEventListener("click", () => {
  if (fwAccessTier !== "full") { requestFullAccess(); return; }
  navigator.clipboard.writeText(getPassportText())
    .then(() => showPassportMsg("âœ… Passport text copied!"))
    .catch(() => showPassportMsg("Copy failed â€” try manually."));
});

document.getElementById("btnCopyLink").addEventListener("click", () => {
  const url = `${location.origin}/firewall?wallet=${fwWallet}&net=${fwNet}`;
  navigator.clipboard.writeText(url)
    .then(() => showPassportMsg("âœ… Share link copied!"))
    .catch(() => showPassportMsg("Copy failed."));
});

document.getElementById("btnRescan").addEventListener("click", () => {
  document.getElementById("dashboard").style.display = "none";
  resetLoadSteps();
  runLoadSequence(fwWallet, fwNet, !fwWallet || fwWallet === DEMO_WALLET);
});

document.getElementById("btnNewScan").addEventListener("click", () => {
  document.getElementById("dashboard").style.display = "none";
  const hero = document.getElementById("heroSection");
  hero.style.display = "block"; hero.style.opacity = "1"; hero.style.transform = "none";
  document.getElementById("walletInput").value = "";
  document.getElementById("walletInput").focus();
  resetLoadSteps();
  fixDone = [false, false, false];
  // hide gate again until next scan
  const gate = document.getElementById("accessGateOverlay");
  if (gate) gate.style.display = "none";
});

document.getElementById("btnRunFirewall").addEventListener("click", startScan);
document.getElementById("walletInput").addEventListener("keydown", e => { if (e.key === "Enter") startScan(); });

document.getElementById("demoHint").addEventListener("click", () => {
  document.getElementById("walletInput").value = DEMO_WALLET;
  document.getElementById("netSelect").value = "bsc";
  runLoadSequence(DEMO_WALLET, "bsc", true);
});

// Top bar access button
document.getElementById("btnTopAccess")?.addEventListener("click", () => window.requestFullAccess());
document.getElementById("btnCheckAccess")?.addEventListener("click", () => window.requestFullAccess());

// PASS popup
document.getElementById("btnBuyPass")?.addEventListener("click", openPassPopup);
// closePassPopup, passPopup click, btnCopyPassAddr, btnGetCycx handled in footer script

// Init Wallet Watch on page load
fwWatchInit();
// Threat Feed visible on page load
fwThreatRender([]);
(function(){const s=document.getElementById('fwThreatFeedSection');if(s)s.classList.add('fw-visible');})();

// Auto-run from URL params
(function checkAutoRun() {
  const p = new URLSearchParams(location.search);
  const w = p.get("wallet");
  const n = p.get("net");
  if (w && fwIsAddr(w)) {
    document.getElementById("walletInput").value = w;
    if (n) document.getElementById("netSelect").value = n;
    startScan();
  }
})();

// Expose for onclick handlers
window.requestFullAccess = requestFullAccess;
window.revokeSpender     = revokeSpender;
window.fwSignPassport    = fwSignPassport;
window.fwVerifyPassport  = fwVerifyPassport;
window.applyRule         = applyRule;
window.applyFix          = applyFix;
</script>
<!-- â”€â”€ PASS PURCHASE MODAL (fixed, centered, outside page flow) â”€â”€ -->
<div id="passPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);align-items:center;justify-content:center">
  <div style="
    background:linear-gradient(135deg,rgba(12,14,28,.98),rgba(18,10,40,.98));
    border:1px solid rgba(0,229,255,.3);border-radius:22px;padding:24px 22px;
    max-width:440px;width:calc(100% - 24px);position:relative;
    box-shadow:0 24px 80px rgba(0,0,0,.8),0 0 50px rgba(0,229,255,.12);
    animation:dashIn .3s ease-out
  ">
    <button id="closePassPopup" style="position:absolute;top:12px;right:14px;background:none;border:none;color:rgba(244,246,255,.55);font-size:20px;cursor:pointer;line-height:1;z-index:1" aria-label="Close">âœ•</button>

    <!-- Header -->
    <div style="font-size:10px;letter-spacing:.22em;text-transform:uppercase;color:var(--cyan);margin-bottom:7px;font-weight:800">ğŸ« CycleX Access Pass</div>
    <div style="font-size:19px;font-weight:950;margin-bottom:5px;line-height:1.2">Unlock full firewall in seconds.</div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:14px;line-height:1.5">
      Pass is <strong style="color:var(--cyan)">non-tradable (soulbound)</strong> Â· convertible to CYCX at public sale.
    </div>

    <!-- Features grid â€” compact 2 columns -->
    <div style="background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.09);border-radius:13px;padding:12px;margin-bottom:14px">
      <div style="font-size:10px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:9px;font-weight:700">What's included</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px 10px">
        <div style="font-size:11px;display:flex;align-items:flex-start;gap:6px"><span style="color:var(--green);flex:0 0 auto;margin-top:1px">âœ“</span><span>Fix Mode + on-chain revoke</span></div>
        <div style="font-size:11px;display:flex;align-items:flex-start;gap:6px"><span style="color:var(--green);flex:0 0 auto;margin-top:1px">âœ“</span><span>Full Blast Radius details</span></div>
        <div style="font-size:11px;display:flex;align-items:flex-start;gap:6px"><span style="color:var(--green);flex:0 0 auto;margin-top:1px">âœ“</span><span>Passport (no watermark)</span></div>
        <div style="font-size:11px;display:flex;align-items:flex-start;gap:6px"><span style="color:var(--green);flex:0 0 auto;margin-top:1px">âœ“</span><span>CSV/JSON export</span></div>
        <div style="font-size:11px;display:flex;align-items:flex-start;gap:6px"><span style="color:var(--green);flex:0 0 auto;margin-top:1px">âœ“</span><span>Wallet Relations + txs</span></div>
        <div style="font-size:11px;display:flex;align-items:flex-start;gap:6px"><span style="color:var(--green);flex:0 0 auto;margin-top:1px">âœ“</span><span>Watch up to 10 wallets</span></div>
        <div style="font-size:11px;display:flex;align-items:flex-start;gap:6px"><span style="color:var(--green);flex:0 0 auto;margin-top:1px">âœ“</span><span>On-chain alert monitor</span></div>
        <div style="font-size:11px;display:flex;align-items:flex-start;gap:6px"><span style="color:var(--green);flex:0 0 auto;margin-top:1px">âœ“</span><span>All future premium features</span></div>
      </div>
    </div>

    <!-- Price row -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding:10px 14px;border-radius:12px;background:rgba(0,229,255,.06);border:1px solid rgba(0,229,255,.18)">
      <span style="font-size:12px;color:var(--muted)">One-time price</span>
      <span style="font-size:17px;font-weight:950;color:var(--cyan)">$9 <span style="font-size:11px;font-weight:600;opacity:.75">USDT or ~BNB</span></span>
    </div>

    <!-- Payment buttons row -->
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button id="passBtnBnb" style="
        flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
        padding:12px;border-radius:999px;
        background:linear-gradient(135deg,#f3a01a,#f0c040);color:#0a0500;
        font-weight:900;font-size:12px;letter-spacing:.06em;text-transform:uppercase;
        border:none;cursor:pointer;transition:transform .2s,box-shadow .2s;
        box-shadow:0 8px 28px rgba(243,160,26,.35)
      ">ğŸŸ¡ BNB</button>
      <button id="passBtnUsdt" style="
        flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
        padding:12px;border-radius:999px;
        background:rgba(255,255,255,.06);color:var(--text);
        font-weight:900;font-size:12px;letter-spacing:.06em;text-transform:uppercase;
        border:1px solid rgba(255,255,255,.18);cursor:pointer;transition:all .2s ease
      ">ğŸ’² USDT</button>
    </div>

    <!-- Status -->
    <div id="passPayStatus" style="font-size:12px;color:var(--muted);text-align:center;min-height:16px;margin-bottom:8px;line-height:1.5"></div>

    <!-- Contract info compact -->
    <div style="display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:8px 12px">
      <span style="font-size:10px;color:var(--muted);white-space:nowrap;flex:0 0 auto">PASS:</span>
      <span style="font-family:var(--mono);font-size:9px;color:var(--cyan);flex:1;word-break:break-all;letter-spacing:0">0x718bc4E915fF66249C1eB86Eb566Ce4fefCA801e</span>
      <button id="btnCopyPassAddr" style="background:none;border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:10px;cursor:pointer;flex:0 0 auto;padding:2px 7px;border-radius:6px">Copy</button>
    </div>
    <div style="font-size:9px;color:var(--muted);text-align:center;margin-top:7px;opacity:.55">BSC network only Â· Verify on BscScan before buying</div>
  </div>
</div>

<script>
// â”€â”€ PASS PAYMENT CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PASS_SALE_RECEIVER = "0x1993b2D333713cdA3C6166bb02F71E304A14471f";
const PASS_USDT_BSC      = "0x55d398326f99059fF775485246999027B3197955";
const PASS_USD_PRICE     = 9;
const PASS_CONTRACT_ADDR = "0x718bc4E915fF66249C1eB86Eb566Ce4fefCA801e";
const BSC_CHAIN_ID       = "0x38";
const BSC_READ_RPCS = [
  "https://bsc-rpc.publicnode.com",
  "https://bsc-dataseed.binance.org/",
  "https://bsc-dataseed1.binance.org/",
  "https://bsc-dataseed2.binance.org/",
  "https://rpc.ankr.com/bsc",
  "https://bsc-dataseed1.defibit.io/",
  "https://bsc-dataseed1.ninicoin.io/",
  "https://1rpc.io/bnb"
];

// â”€â”€ PASS POPUP HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPassPopup()  {
  const el = document.getElementById("passPopup");
  if (el) { el.style.display = "flex"; setPassStatus(""); }
}
function closePassPopup() {
  const el = document.getElementById("passPopup");
  if (el) el.style.display = "none";
}
function setPassStatus(msg, color) {
  const el = document.getElementById("passPayStatus");
  if (!el) return;
  el.textContent = msg || "";
  el.style.color = color || "var(--muted)";
}

window.openPassPopup  = openPassPopup;
window.closePassPopup = closePassPopup;

// â”€â”€ RPC JSON-RPC HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwRpcRequest(url, method, params, timeoutMs = 8000) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ jsonrpc:"2.0", id:1, method, params }),
      signal: ctrl.signal
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message || "RPC error");
    return data.result;
  } finally {
    clearTimeout(timer);
  }
}

// â”€â”€ BSC PROVIDER WITH FALLBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwGetBscProvider() {
  const Eth = window.E || window.ethers;
  if (!Eth) return null;
  for (const rpc of BSC_READ_RPCS) {
    try {
      const p = new Eth.JsonRpcProvider(rpc);
      await Promise.race([
        p.getBlockNumber(),
        new Promise((_, r) => setTimeout(() => r(new Error("timeout")), 6000))
      ]);
      return p;
    } catch { /* try next */ }
  }
  return null;
}

// Override checkCycxPass to use local BSC provider
async function checkCycxPassRobust() {
  const Eth = window.E || window.ethers;
  if (!Eth?.Contract) return { eligible: false, reason: "ethers_missing" };
  const addr = window.wallet?.address;
  if (!addr) return { eligible: false, reason: "no_wallet" };

  const provider = await fwGetBscProvider();
  if (!provider) return { eligible: false, reason: "rpc_failed" };

  try {
    const GATE_ABI_MIN = [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ];
    const cycxC = new Eth.Contract(CYCX_BSC, GATE_ABI_MIN, provider);
    const passC = new Eth.Contract(PASS_BSC, GATE_ABI_MIN, provider);

    let cycxDec = 18n;
    try { cycxDec = BigInt(await cycxC.decimals()); } catch {}

    const [cycxBal, passBal] = await Promise.all([
      cycxC.balanceOf(addr).catch(() => 0n),
      passC.balanceOf(addr).catch(() => 0n)
    ]);

    const cycxMin = CYCX_MIN * (10n ** cycxDec);
    const eligible = BigInt(passBal) >= PASS_MIN || BigInt(cycxBal) >= cycxMin;
    return {
      ok: true,
      eligible,
      hasPass:  BigInt(passBal) >= PASS_MIN,
      hasCycx:  BigInt(cycxBal) >= cycxMin
    };
  } catch (e) {
    return { eligible: false, reason: e.message };
  }
}

// â”€â”€ BNB PRICE QUOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwQuoteBnbWei(usdPrice) {
  // Try to get BNB/USD from BSC oracle (WBNB/USDT PancakeSwap pair)
  const WBNB  = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
  const USDT  = "0x55d398326f99059fF775485246999027B3197955";
  const PAIR_FACTORY = "0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73";

  const Eth = window.E || window.ethers;
  if (!Eth) throw new Error("ethers not loaded");

  const provider = await fwGetBscProvider();
  if (!provider) throw new Error("No BSC RPC");

  const factoryAbi = ["function getPair(address,address) view returns (address)"];
  const pairAbi    = [
    "function token0() view returns (address)",
    "function getReserves() view returns (uint112,uint112,uint32)"
  ];

  const factory = new Eth.Contract(PAIR_FACTORY, factoryAbi, provider);
  const pairAddr = await factory.getPair(WBNB, USDT);
  const pair = new Eth.Contract(pairAddr, pairAbi, provider);
  const [t0, [r0, r1]] = await Promise.all([pair.token0(), pair.getReserves()]);

  const isWbnbT0 = t0.toLowerCase() === WBNB.toLowerCase();
  const wbnbR = isWbnbT0 ? BigInt(r0) : BigInt(r1);
  const usdtR = isWbnbT0 ? BigInt(r1) : BigInt(r0);

  // USDT has 18 decimals on BSC, WBNB 18 decimals
  // bnbPriceUSD = usdtR / wbnbR
  // weiNeeded = usdPrice / bnbPriceUSD * 1e18
  const weiNeeded = (BigInt(usdPrice) * wbnbR * 10n**18n) / (usdtR);
  // Add 2% slippage
  return (weiNeeded * 102n) / 100n;
}

// â”€â”€ ENSURE BSC CHAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwEnsureBsc(provider) {
  // Delegates to fwEnsureChain which handles BSC, ETH, and Polygon
  const targetNet = (fwNet && ["eth","polygon","bsc"].includes(fwNet)) ? fwNet : "bsc";
  if (typeof fwEnsureChain === "function") return fwEnsureChain(targetNet, provider);
  // Fallback: hardcoded BSC
  try {
    const chainId = await provider.request({ method: "eth_chainId" });
    if (chainId === BSC_CHAIN_ID) return true;
    await provider.request({ method:"wallet_switchEthereumChain", params:[{chainId:BSC_CHAIN_ID}] });
    return true;
  } catch (err) {
    if (Number(err?.code) === 4902) {
      await provider.request({ method:"wallet_addEthereumChain", params:[{
        chainId:BSC_CHAIN_ID, chainName:"BNB Smart Chain",
        nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},
        rpcUrls:["https://bsc-dataseed.binance.org/"],
        blockExplorerUrls:["https://bscscan.com/"]
      }] });
      return true;
    }
    return false;
  }
}

// â”€â”€ WAIT FOR TX CONFIRM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fwWaitTxConfirm(rawProvider, txHash, maxMs = 120000) {
  const start = Date.now();
  while (Date.now() - start < maxMs) {
    try {
      const r = await rawProvider.request({
        method: "eth_getTransactionReceipt",
        params: [txHash]
      });
      if (r?.status != null) {
        return r.status === "0x1" || r.status === 1 || r.status === true;
      }
    } catch {}
    await new Promise(res => setTimeout(res, 2000));
  }
  return false;
}

// â”€â”€ PASS BUY FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _passBuyRunning = false;

async function passBuyFlow(kind) {
  if (_passBuyRunning) return;
  _passBuyRunning = true;

  const bnbBtn  = document.getElementById("passBtnBnb");
  const usdtBtn = document.getElementById("passBtnUsdt");
  if (bnbBtn)  bnbBtn.disabled  = true;
  if (usdtBtn) usdtBtn.disabled = true;

  try {
    setPassStatus("Loading wallet moduleâ€¦", "#a87eff");

    // Connect wallet via AppKit
    let appkit;
    try { appkit = await fwLoadAppKit(); }
    catch { setPassStatus("Could not load wallet module. Check connection.", "#ff7a8a"); return; }

    if (!window.wallet?.address) {
      setPassStatus("Opening wallet connectâ€¦", "#a87eff");
      try {
        await appkit.open();
        const addr = await fwWaitForWallet(20000);
        if (!addr) { setPassStatus("Wallet not connected. Try again.", "#ff9a6b"); return; }
      } catch { setPassStatus("Connect cancelled.", "#ff9a6b"); return; }
    }

    // Get raw provider
    const rawProvider =
      window.wallet?.providerRaw?.request  && window.wallet.providerRaw ||
      appkit.getWalletProvider?.()?.request && appkit.getWalletProvider() ||
      window.ethereum;

    if (!rawProvider?.request) {
      setPassStatus("Provider not available. Try reconnecting wallet.", "#ff7a8a");
      return;
    }

    const from = window.wallet.address;
    setPassStatus("Switching to BSCâ€¦", "#a87eff");
    const chainOk = await fwEnsureBsc(rawProvider);
    if (!chainOk) { setPassStatus("Please switch to BNB Chain.", "#ff9a6b"); return; }

    // â”€â”€ BNB payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (kind === "bnb") {
      setPassStatus("Fetching BNB priceâ€¦", "#a87eff");
      let valueWei;
      try {
        valueWei = await fwQuoteBnbWei(PASS_USD_PRICE);
      } catch {
        // Fallback: assume $300/BNB
        valueWei = (BigInt(PASS_USD_PRICE) * 10n**18n) / 300n;
        valueWei = (valueWei * 105n) / 100n;
      }

      const BUY_BNB_SELECTOR = "0x20f1fc61";
      setPassStatus("Confirm in your walletâ€¦", "#a87eff");
      let txHash;
      try {
        txHash = await rawProvider.request({
          method: "eth_sendTransaction",
          params: [{ from, to: PASS_SALE_RECEIVER, value: "0x" + valueWei.toString(16), data: BUY_BNB_SELECTOR }]
        });
      } catch (e) {
        const msg = String(e?.message || "");
        if (/reject|cancel|denied|4001/i.test(msg)) {
          setPassStatus("Transaction cancelled.", "#ff9a6b");
        } else {
          setPassStatus("Transaction failed: " + msg.slice(0, 80), "#ff7a8a");
        }
        return;
      }

      setPassStatus("â³ Waiting for confirmationâ€¦", "#ffd166");
      const ok = await fwWaitTxConfirm(rawProvider, txHash);
      if (ok) {
        setPassStatus("âœ… Purchase confirmed! Reloading accessâ€¦", "#5dffb2");
        setTimeout(() => { closePassPopup(); requestFullAccess(); }, 1500);
      } else {
        setPassStatus("Pending on-chain. Close and try 'Check Access' in a moment.", "#ffd166");
      }
      return;
    }

    // â”€â”€ USDT payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (kind === "usdt") {
      const Eth = window.E || window.ethers;
      if (!Eth) { setPassStatus("Ethers.js not loaded.", "#ff7a8a"); return; }

      const web3Provider = new Eth.BrowserProvider(rawProvider);
      const signer = await web3Provider.getSigner();

      const usdtAbi = [
        "function decimals() view returns (uint8)",
        "function approve(address,uint256) returns (bool)"
      ];
      const saleAbi = ["function buyWithUSDT() external"];

      const usdtC = new Eth.Contract(PASS_USDT_BSC, usdtAbi, signer);
      const saleC = new Eth.Contract(PASS_SALE_RECEIVER, saleAbi, signer);

      const dec = Number(await usdtC.decimals());
      const amount = Eth.parseUnits(String(PASS_USD_PRICE), dec);

      setPassStatus("Step 1/2: Approve USDT in walletâ€¦", "#a87eff");
      try {
        const tx1 = await usdtC.approve(PASS_SALE_RECEIVER, amount);
        await tx1.wait();
      } catch (e) {
        setPassStatus("USDT approval cancelled or failed.", "#ff9a6b");
        return;
      }

      setPassStatus("Step 2/2: Confirm purchaseâ€¦", "#a87eff");
      try {
        const tx2 = await saleC.buyWithUSDT();
        setPassStatus("â³ Waiting for confirmationâ€¦", "#ffd166");
        const receipt = await tx2.wait();
        if (receipt?.status === 1) {
          setPassStatus("âœ… Purchase confirmed! Reloading accessâ€¦", "#5dffb2");
          setTimeout(() => { closePassPopup(); requestFullAccess(); }, 1500);
        } else {
          setPassStatus("Tx failed on-chain. Try again.", "#ff7a8a");
        }
      } catch (e) {
        setPassStatus("Purchase cancelled or failed.", "#ff9a6b");
      }
      return;
    }

  } catch (e) {
    setPassStatus("Error: " + String(e?.message || e).slice(0, 100), "#ff7a8a");
  } finally {
    if (bnbBtn)  bnbBtn.disabled  = false;
    if (usdtBtn) usdtBtn.disabled = false;
    _passBuyRunning = false;
  }
}

// â”€â”€ BIND MODAL EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("closePassPopup")?.addEventListener("click", closePassPopup);
document.getElementById("passPopup")?.addEventListener("click", e => {
  if (e.target.id === "passPopup") closePassPopup();
});
document.getElementById("passBtnBnb")?.addEventListener("click", () => passBuyFlow("bnb"));
document.getElementById("passBtnUsdt")?.addEventListener("click", () => passBuyFlow("usdt"));
document.getElementById("btnCopyPassAddr")?.addEventListener("click", () => {
  navigator.clipboard.writeText(PASS_CONTRACT_ADDR).then(() => {
    const btn = document.getElementById("btnCopyPassAddr");
    if (btn) { const prev = btn.textContent; btn.textContent = "Copied!"; setTimeout(() => btn.textContent = prev, 1500); }
  }).catch(() => {});
});

// â”€â”€ PATCH requestFullAccess to use robust RPC check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.requestFullAccess = async function() {
  if (fwAccessTier === "full") return;
  setGateStatus("Loading wallet moduleâ€¦", "#a87eff");

  let appkit;
  try { appkit = await fwLoadAppKit(); }
  catch { setGateStatus("Could not load wallet module. Check connection.", "#ff7a8a"); return; }

  if (!window.wallet?.address) {
    try {
      setGateStatus("Opening wallet connectâ€¦", "#a87eff");
      await appkit.open();
      const addr = await fwWaitForWallet(20000);
      if (!addr) { setGateStatus("Wallet not connected. Try again.", "#ff9a6b"); return; }
    } catch { setGateStatus("Connect cancelled.", "#ff9a6b"); return; }
  }

  setGateStatus("Checking PASS on BSCâ€¦", "#a87eff");
  const res = await checkCycxPassRobust();
  const eligible = res.eligible === true || (res.ok && res.eligible);

  if (eligible) {
    const why = res.hasPass ? "PASS âœ“" : "CYCX âœ“";
    setGateStatus(`Eligible (${why}) â€” unlocking!`, "#5dffb2");
    await new Promise(r => setTimeout(r, 700));
    // Verify path â€” mark as legitimately checked before unlocking
    _fwAccessVerified = true;
    _fwValidatedWallet = window.wallet?.address || null;
    unlockFull();
    if (fwScanData) renderDashboard(fwWallet, fwScanData, "full");
    return;
  }

  const msg =
    res.reason === "no_wallet"      ? "Wallet not detected." :
    res.reason === "ethers_missing" ? "Ethers.js not loaded. Refresh and try again." :
    res.reason === "rpc_failed"     ? "BSC RPC unavailable. Try again in a moment." :
    "Not eligible. You need 1 PASS token on BSC.";
  setGateStatus(msg, "#ff7a8a");
};

// Remove old CYCX disabled tooltip listener if any
// (btnGetCycx was removed from HTML)
</script>
<!-- â”€â”€ TIMELINE MODAL â”€â”€ -->
<div id="fwTimelineModal" style="display:none">
  <div class="tm-box">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div style="font-weight:800;font-size:15px" id="fwTmTitle">Transaction Timeline</div>
      <button onclick="document.getElementById('fwTimelineModal').style.display='none'"
        style="background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;line-height:1;padding:0">âœ•</button>
    </div>
    <div id="fwTmBody"></div>
    <div style="margin-top:14px;text-align:center">
      <button onclick="document.getElementById('fwTimelineModal').style.display='none'"
        style="padding:10px 32px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.14);color:var(--text);font-size:12px;font-weight:700;cursor:pointer;letter-spacing:.08em;text-transform:uppercase">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€ RULE CONFIRMATION MODAL â”€â”€ -->
<div id="fwRuleConfirmModal" style="display:none">
  <div class="rc-box">
    <div style="font-size:18px;font-weight:900;margin-bottom:10px" id="rcTitle">Confirm Rule</div>
    <div class="rc-warning" id="rcWarning"></div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:8px;font-weight:700">What will happen (on-chain transactions):</div>
    <div class="rc-tx-list" id="rcTxList"></div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:14px" id="rcNote"></div>
    <div class="rc-btns">
      <button class="rc-btn-cancel" id="rcCancelBtn">Cancel</button>
      <button class="rc-btn-confirm" id="rcConfirmBtn">I Understand â€” Proceed</button>
    </div>
  </div>
</div>

<!-- â”€â”€ PASSPORT VERIFY MODAL â”€â”€ -->
<div id="fwVerifyModal">
  <div class="fv-box">
    <div class="fv-icon" id="fvIcon">ğŸ”</div>
    <div class="fv-title" id="fvTitle">Verifyingâ€¦</div>
    <div class="fv-sub"  id="fvSub"></div>
    <div class="fv-card" id="fvCard" style="display:none">
      <div class="fv-row"><span class="fv-key">Wallet</span><span class="fv-val" id="fvWallet">â€”</span></div>
      <div class="fv-row"><span class="fv-key">Network</span><span class="fv-val" id="fvNetwork">â€”</span></div>
      <div class="fv-row"><span class="fv-key">Score</span><span class="fv-val" id="fvScore">â€”</span></div>
      <div class="fv-row"><span class="fv-key">Blast Radius</span><span class="fv-val" id="fvBlast">â€”</span></div>
      <div class="fv-row"><span class="fv-key">High Risk</span><span class="fv-val" id="fvHighRisk">â€”</span></div>
      <div class="fv-row"><span class="fv-key">Signed At</span><span class="fv-val" id="fvSignedAt">â€”</span></div>
      <div class="fv-row"><span class="fv-key">Valid Until</span><span class="fv-val" id="fvExpiry">â€”</span></div>
    </div>
    <button class="fv-close" onclick="document.getElementById('fwVerifyModal').className=''; document.getElementById('fwVerifyModal').style.display='none'">Close</button>
  </div>
</div>

</body>
</html>
